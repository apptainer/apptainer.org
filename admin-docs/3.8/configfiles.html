

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Singularity Configuration Files &mdash; Singularity Admin Guide 3.8 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="User Namespaces &amp; Fakeroot" href="user_namespace.html" />
    <link rel="prev" title="Installing Singularity" href="installation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Singularity Admin Guide
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="admin_quickstart.html">Admin Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installing Singularity</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configuration files</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#singularity-conf">singularity.conf</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setuid-and-capabilities">Setuid and Capabilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loop-devices">Loop Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="#namespace-options">Namespace Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-files">Configuration Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#session-directory-and-system-mounts">Session Directory and System Mounts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bind-mount-management">Bind Mount Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limiting-container-execution">Limiting Container Execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#networking-options">Networking Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpu-options">GPU Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supplemental-filesystems">Supplemental Filesystems</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-tooling-paths">External Tooling Paths</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-configuration-options">Updating Configuration Options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cgroups-toml">cgroups.toml</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limiting-memory">Limiting memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limiting-cpu">Limiting CPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#limiting-io">Limiting IO</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ecl-toml">ecl.toml</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#managing-ecl-public-keys">Managing ECL public keys</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gpu-library-configuration">GPU Library Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#nvidia-gpus-cuda">NVIDIA GPUs / CUDA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#amd-radeon-gpus-rocm">AMD Radeon GPUs / ROCm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpu-liblist-format">GPU liblist format</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#capability-json">capability.json</a></li>
<li class="toctree-l2"><a class="reference internal" href="#seccomp-profiles">seccomp-profiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#remote-yaml">remote.yaml</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#remote-endpoints">Remote Endpoints</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keyserver-configuration">Keyserver Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="user_namespace.html">User Namespaces &amp; Fakeroot</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Container Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Singularity Admin Guide</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Singularity Configuration Files</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/hpcng/singularity-admindocs/blob/master/configfiles.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="singularity-configuration-files">
<span id="singularity-configfiles"></span><h1>Singularity Configuration Files<a class="headerlink" href="#singularity-configuration-files" title="Permalink to this headline">¶</a></h1>
<p>As a Singularity Administrator, you will have access to various configuration
files, that will let you manage container resources, set security restrictions
and configure network options etc, when installing Singularity across the system.
All these files can be found in <code class="docutils literal notranslate"><span class="pre">/usr/local/etc/singularity</span></code> by default (though
its location will obviously differ based on options passed during the
installation). This page will describe the following configuration files and
the various parameters contained by them. They are usually self documenting
but here are several things to pay special attention to:</p>
<div class="section" id="singularity-conf">
<h2>singularity.conf<a class="headerlink" href="#singularity-conf" title="Permalink to this headline">¶</a></h2>
<p>Most of the configuration options are set using the file <code class="docutils literal notranslate"><span class="pre">singularity.conf</span></code>
that defines the global configuration for Singularity across the entire system.
Using this file, system administrators can have direct say as to what functions
the users can utilize. As a security measure, for <code class="docutils literal notranslate"><span class="pre">setuid</span></code> installations of
Singularity it must be owned by root and must not be writable by users or
Singularity will refuse to run. This is not the case for <code class="docutils literal notranslate"><span class="pre">non-setuid</span></code>
installations that will only ever execute with user priviledge and thus do not
require such limitations. The options for this configuration are listed below.
Options are grouped together based on relevance, the order of options within
<code class="docutils literal notranslate"><span class="pre">singularity.conf</span></code> differs.</p>
<div class="section" id="setuid-and-capabilities">
<h3>Setuid and Capabilities<a class="headerlink" href="#setuid-and-capabilities" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">SETUID</span></code>:
To use all features of Singularity containers, Singularity will need to have
access to some privileged system calls. One way singularity achieves this is by
using binaries with the <code class="docutils literal notranslate"><span class="pre">setuid</span></code> bit enabled. This variable lets you
enable/disable users ability to utilize these binaries within Singularity. By
default, it is set to “yes”, but when disabled, various Singularity features
will not function. Please see
<a class="reference internal" href="user_namespace.html#userns-limitations"><span class="std std-ref">Unprivileged Installations</span></a> for more information
about running Singularity without <code class="docutils literal notranslate"><span class="pre">setuid</span></code> enabled.</p>
<p><code class="docutils literal notranslate"><span class="pre">ROOT</span> <span class="pre">DEFAULT</span> <span class="pre">CAPABILITIES</span></code>:
Singularity allows the specification of capabilities kept by the root user
when running a container by default. Options include:</p>
<ul class="simple">
<li><p>full: all capabilities are maintained, this gives the same behavior as the <code class="docutils literal notranslate"><span class="pre">--keep-privs</span></code> option.</p></li>
<li><p>file: only capabilities granted in <code class="docutils literal notranslate"><span class="pre">/usr/local/etc/singularity/capabilities/user.root</span></code> are maintained.</p></li>
<li><p>no: no capabilities are maintained, this gives the same behavior as the <code class="docutils literal notranslate"><span class="pre">--no-privs</span></code> option.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The root user can manage the capabilities granted to individual containers when they
are launched through the <code class="docutils literal notranslate"><span class="pre">--add-caps</span></code> and <code class="docutils literal notranslate"><span class="pre">drop-caps</span></code> flags.
Please see <a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8/security_options.html#linux-capabilities">Linux Capabilities</a>
in the user guide for more information.</p>
</div>
</div>
<div class="section" id="loop-devices">
<h3>Loop Devices<a class="headerlink" href="#loop-devices" title="Permalink to this headline">¶</a></h3>
<p>Singularity uses loop devices to facilitate the mounting of container
filesystems from SIF images.</p>
<p><code class="docutils literal notranslate"><span class="pre">MAX</span> <span class="pre">LOOP</span> <span class="pre">DEVICES</span></code>:
This option allows an admin to limit the total number of loop devices
Singularity will consume at a given time.</p>
<p><code class="docutils literal notranslate"><span class="pre">SHARED</span> <span class="pre">LOOP</span> <span class="pre">DEVICES</span></code>:
This allows containers running the same image to share a single loop device.
This minimizes loop device usage and helps optimize kernel cache usage.
Enabling this feature can be particularly useful for MPI jobs.</p>
</div>
<div class="section" id="namespace-options">
<h3>Namespace Options<a class="headerlink" href="#namespace-options" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">PID</span> <span class="pre">NS</span></code>:
This option determines if users can leverage the PID namespace when running
their containers through the <code class="docutils literal notranslate"><span class="pre">--pid</span></code> flag.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For some HPC systems, using the PID namespace has the potential of confusing
some resource managers as well as some MPI implementations.</p>
</div>
</div>
<div class="section" id="configuration-files">
<h3>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h3>
<p>Singularity allows for the automatic configuration of several system
configuration files within containers to ease usage across systems.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These options will do nothing unless the file or directory path exists within
the container or Singularity has either overlay or underlay support enabled.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CONFIG</span> <span class="pre">PASSWD</span></code>:
This option determines if Singularity should automatically append an entry to
<code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code> for the user running the container.</p>
<p><code class="docutils literal notranslate"><span class="pre">CONFIG</span> <span class="pre">GROUP</span></code>:
This option determines if Singularity should automatically append the calling
user’s group entries to the containers <code class="docutils literal notranslate"><span class="pre">/etc/group</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">CONFIG</span> <span class="pre">RESOLV_CONF</span></code>:
This option determines if Singularity should automatically bind the host’s
<code class="docutils literal notranslate"><span class="pre">/etc/resolv/conf</span></code> within the container.</p>
</div>
<div class="section" id="session-directory-and-system-mounts">
<h3>Session Directory and System Mounts<a class="headerlink" href="#session-directory-and-system-mounts" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">SESSIONDIR</span> <span class="pre">MAX</span> <span class="pre">SIZE</span></code>:
In order for the Singularity runtime to create a container it needs to create a
<code class="docutils literal notranslate"><span class="pre">sessiondir</span></code> to manage various components of the container, including
mounting filesystems over the base image filesystem. This option
specifies how large the default <code class="docutils literal notranslate"><span class="pre">sessiondir</span></code> should be (in MB) and will
only affect users who use the <code class="docutils literal notranslate"><span class="pre">--contain</span></code> options without also specifying a
location to perform default read/writes to via the <code class="docutils literal notranslate"><span class="pre">--workdir</span></code> or <code class="docutils literal notranslate"><span class="pre">--home</span></code>
options.</p>
<p><code class="docutils literal notranslate"><span class="pre">MOUNT</span> <span class="pre">PROC</span></code>:
This option determines if Singularity should automatically bind mount <code class="docutils literal notranslate"><span class="pre">/proc</span></code>
within the container.</p>
<p><code class="docutils literal notranslate"><span class="pre">MOUNT</span> <span class="pre">SYS</span></code>:
This option determines if Singularity should automatically bind mount <code class="docutils literal notranslate"><span class="pre">/sys</span></code>
within the container.</p>
<p><code class="docutils literal notranslate"><span class="pre">MOUNT</span> <span class="pre">DEV</span></code>:
Should be set to “YES”, if you want Singularity to automatically bind mount
<cite>/dev</cite> within the container. If set to ‘minimal’, then only ‘null’, ‘zero’,
‘random’, ‘urandom’, and ‘shm’ will be included.</p>
<p><code class="docutils literal notranslate"><span class="pre">MOUNT</span> <span class="pre">DEVPTS</span></code>:
This option determines if Singularity will mount a new instance of <code class="docutils literal notranslate"><span class="pre">devpts</span></code>
when there is a <code class="docutils literal notranslate"><span class="pre">minimal</span></code> <code class="docutils literal notranslate"><span class="pre">/dev</span></code> directory as explained above, or when the
<code class="docutils literal notranslate"><span class="pre">--contain</span></code> option is passed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This requires either a kernel configured with
<code class="docutils literal notranslate"><span class="pre">CONFIG_DEVPTS_MULTIPLE_INSTANCES=y</span></code>, or a kernel version at or newer than
<code class="docutils literal notranslate"><span class="pre">4.7</span></code>.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">MOUNT</span> <span class="pre">HOME</span></code>:
When this option is enabled, Singularity will automatically determine the
calling user’s home directory and attempt to mount it into the container.</p>
<p><code class="docutils literal notranslate"><span class="pre">MOUNT</span> <span class="pre">TMP</span></code>:
When this option is enabled, Singularity will automatically bind mount
<code class="docutils literal notranslate"><span class="pre">/tmp</span></code> and <code class="docutils literal notranslate"><span class="pre">/var/tmp</span></code> into the container from the host. If the
<code class="docutils literal notranslate"><span class="pre">--contain</span></code> option is passed, Singularity will create both locations within
the <code class="docutils literal notranslate"><span class="pre">sessiondir</span></code> or within the directory specified by the <code class="docutils literal notranslate"><span class="pre">--workdir</span></code>
option if that is passed as well.</p>
<p><code class="docutils literal notranslate"><span class="pre">MOUNT</span> <span class="pre">HOSTFS</span></code>:
This option will cause Singularity to probe the host for all mounted
filesystems and bind those into containers at runtime.</p>
<p><code class="docutils literal notranslate"><span class="pre">MOUNT</span> <span class="pre">SLAVE</span></code>:
Singularity automatically mounts a handful host system directories to the
container by default. This option determines if filesystem changes on the host
should automatically be propogated to those directories in the container.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This should be set to <code class="docutils literal notranslate"><span class="pre">yes</span></code> when autofs mounts in the system should
show up in the container.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">MEMORY</span> <span class="pre">FS</span> <span class="pre">TYPE</span></code>:
This option allows admins to choose the temporary filesystem used by
Singularity. Temporary filesystems are primarily used for system
directories like <code class="docutils literal notranslate"><span class="pre">/dev</span></code> when the host system directory is not mounted
within the container.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For Cray CLE 5 and 6, up to CLE 6.0.UP05, there is an issue (kernel panic) when Singularity
uses tmpfs, so on affected systems it’s recommended to set this value to ramfs to avoid a
kernel panic</p>
</div>
</div>
<div class="section" id="bind-mount-management">
<h3>Bind Mount Management<a class="headerlink" href="#bind-mount-management" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">BIND</span> <span class="pre">PATH</span></code>:
This option is used for defining a list of files or directories to
automatically be made available when Singularity runs a container.
In order to successfully mount listed paths the file or directory path must
exist within the container, or Singularity has either overlay or underlay
support enabled.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This option is ignored when containers are invoked with the <code class="docutils literal notranslate"><span class="pre">--contain</span></code> option.</p>
</div>
<p>You can define the a bind point where the source and destination are identical:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bind path = /etc/localtime
</pre></div>
</div>
<p>Or you can specify different source and destination locations using:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bind path = /etc/singularity/default-nsswitch.conf:/etc/nsswitch.conf
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">USER</span> <span class="pre">BIND</span> <span class="pre">CONTROL</span></code>:
This allows admins to decide if users can define bind points at runtime.
By Default, this option is set to <code class="docutils literal notranslate"><span class="pre">YES</span></code>, which means users can specify bind
points, scratch and tmp locations.</p>
</div>
<div class="section" id="limiting-container-execution">
<h3>Limiting Container Execution<a class="headerlink" href="#limiting-container-execution" title="Permalink to this headline">¶</a></h3>
<p>There are several ways to limit container execution as an admin listed below.
If stricter controls are required, check out the
<a class="reference internal" href="#execution-control-list"><span class="std std-ref">Execution Control List</span></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">LIMIT</span> <span class="pre">CONTAINER</span> <span class="pre">OWNERS</span></code>:
This restricts container execution to only allow conatiners that are owned by
the specified user.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature will only apply when Singularity is running in SUID mode and the
user is non-root. By default this is set to <cite>NULL</cite>.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">LIMIT</span> <span class="pre">CONTAINER</span> <span class="pre">GROUPS</span></code>:
This restricts container execution to only allow conatiners that are owned by
the specified group.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature will only apply when Singularity is running in SUID mode and the
user is non-root. By default this is set to <cite>NULL</cite>.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">LIMIT</span> <span class="pre">CONTAINER</span> <span class="pre">PATHS</span></code>:
This restricts container execution to only allow containers that are located
within the specified path prefix.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature will only apply when Singularity is running in SUID mode and the
user is non-root. By default this is set to <cite>NULL</cite>.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">CONTAINER</span> <span class="pre">${TYPE}</span></code>:
This option allows admins to limit the types of image formats that can be
leveraged by users with Singularity. Formats include <code class="docutils literal notranslate"><span class="pre">squashfs</span></code> which is used
by SIF and v2.x Singularity images, <code class="docutils literal notranslate"><span class="pre">extfs</span></code> which is used for writable
overlays and some legacy Singularity images, <code class="docutils literal notranslate"><span class="pre">dir</span></code> which is used by sandbox
images and <code class="docutils literal notranslate"><span class="pre">encrypted</span></code> which is only used by SIF images to encrypt filesystem
contents.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These limitations do not apply to the root user.</p>
</div>
</div>
<div class="section" id="networking-options">
<h3>Networking Options<a class="headerlink" href="#networking-options" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">--network</span></code> option can be used to specify a CNI networking
configuration that will be used when running a container with <a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8/networking.html">network
virtualization</a>. Unrestricted
use of CNI network configurations requires root privilege, as certain
configurations may disrupt the host networking environment.</p>
<p>Singularity 3.8 allows specific users or groups to be granted the
ability to run containers with adminstrator specified CNI
configurations.</p>
<p><code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">NET</span> <span class="pre">USERS</span></code>:
Allow specified root administered CNI network configurations to be used by the
specified list of users. By default only root may use CNI configuration,
except in the case of a fakeroot execution where only 40_fakeroot.conflist
is used. This feature only applies when Singularity is running in
SUID mode and the user is non-root.</p>
<p><code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">NET</span> <span class="pre">GROUPS</span></code>:
Allow specified root administered CNI network configurations to be used by the
specified list of users. By default only root may use CNI configuration,
except in the case of a fakeroot execution where only 40_fakeroot.conflist
is used. This feature only applies when Singularity is running in
SUID mode and the user is non-root.</p>
<p><code class="docutils literal notranslate"><span class="pre">ALLOW</span> <span class="pre">NET</span> <span class="pre">NETWORKS</span></code>:
Specify the names of CNI network configurations that may be used by users and
groups listed in the allow net users / allow net groups directives. Thus feature
only applies when Singularity is running in SUID mode and the user is non-root.</p>
</div>
<div class="section" id="gpu-options">
<h3>GPU Options<a class="headerlink" href="#gpu-options" title="Permalink to this headline">¶</a></h3>
<p>Singularity provides integration with GPUs in order to facilitate GPU based
workloads seamlessly. Both options listed below are particularly useful in
GPU only environments. For more information on using GPUs with Singularity
checkout <a class="reference internal" href="#gpu-library-configuration"><span class="std std-ref">GPU Library Configuration</span></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">ALWAYS</span> <span class="pre">USE</span> <span class="pre">NV</span> <span class="pre">${TYPE}</span></code>:
Enabling this option will cause every action command
(<code class="docutils literal notranslate"><span class="pre">exec/shell/run/instance</span></code>) to be executed with the <code class="docutils literal notranslate"><span class="pre">--nv</span></code> option
implicitly added.</p>
<p><code class="docutils literal notranslate"><span class="pre">ALWAYS</span> <span class="pre">USE</span> <span class="pre">ROCM</span> <span class="pre">${TYPE}</span></code>:
Enabling this option will cause every action command
(<code class="docutils literal notranslate"><span class="pre">exec/shell/run/instance</span></code>) to be executed with the <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> option
implicitly added.</p>
</div>
<div class="section" id="supplemental-filesystems">
<h3>Supplemental Filesystems<a class="headerlink" href="#supplemental-filesystems" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ENABLE</span> <span class="pre">FUSEMOUNT</span></code>:
This will allow users to mount fuse filesystems inside containers using the
<code class="docutils literal notranslate"><span class="pre">--fusemount</span></code> flag.</p>
<p><code class="docutils literal notranslate"><span class="pre">ENABLE</span> <span class="pre">OVERLAY</span></code>:
This option will allow Singularity to create bind mounts at paths that do not
exist within the container image. This option can be set to <code class="docutils literal notranslate"><span class="pre">try</span></code>, which will
try to use an overlayfs. If it fails to create an overlayfs in this case the
bind path will be silently ignored.</p>
<p><code class="docutils literal notranslate"><span class="pre">ENABLE</span> <span class="pre">UNDERLAY</span></code>:
This option will allow Singularity to create bind mounts at paths that do not
exist within the container image, just like <code class="docutils literal notranslate"><span class="pre">ENABLE</span> <span class="pre">OVERLAY</span></code>, but instead
using an underlay. This is suitable for systems where overlay is not possible
or not working. If the overlay option is available and working, it will be
used instead.</p>
</div>
<div class="section" id="external-tooling-paths">
<h3>External Tooling Paths<a class="headerlink" href="#external-tooling-paths" title="Permalink to this headline">¶</a></h3>
<p>Internally, Singularity leverages several pieces of tooling in order to provide
a wide breadth of features for users. Locations for these tools can be
customized by system admins and referenced with the options below:</p>
<p><code class="docutils literal notranslate"><span class="pre">CNI</span> <span class="pre">CONFIGURATION</span> <span class="pre">PATH</span></code>:
This option allows admins to specify a custom path for the CNI configuration
that Singularity will use for <a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8/networking.html">Network Virtualization</a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">CNI</span> <span class="pre">PLUGIN</span> <span class="pre">PATH</span></code>:
This option allows admins to specify a custom path for Singularity to access
CNI plugin executables. Check out the <a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8/networking.html">Network Virtualization</a>
section of the user guide for more information.</p>
<p><code class="docutils literal notranslate"><span class="pre">MKSQUASHFS</span> <span class="pre">PATH</span></code>:
This allows an admin to specify the location of <code class="docutils literal notranslate"><span class="pre">mksquashfs</span></code> if it is not
installed in a standard location. If set, <code class="docutils literal notranslate"><span class="pre">mksquashfs</span></code> at this path will be
used instead of a <code class="docutils literal notranslate"><span class="pre">mksquashfs</span></code> found in <code class="docutils literal notranslate"><span class="pre">PATH</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">CRYPTSETUP</span> <span class="pre">PATH</span></code>:
The location for <code class="docutils literal notranslate"><span class="pre">cryptsetup</span></code> is recorded by Singularity at build time and
will use that value if this is undefined. This option allows an admin to set
the path of <code class="docutils literal notranslate"><span class="pre">cryptsetup</span></code> if it is located in a custom location and will
override the value recorded at build time.</p>
</div>
<div class="section" id="updating-configuration-options">
<h3>Updating Configuration Options<a class="headerlink" href="#updating-configuration-options" title="Permalink to this headline">¶</a></h3>
<p>In order to manage this configuration file, Singularity has a <code class="docutils literal notranslate"><span class="pre">config</span> <span class="pre">global</span></code>
command group that allows you to get, set, reset, and unset values through the
CLI. It’s important to note that these commands must be run with elevated
priveledges because the <code class="docutils literal notranslate"><span class="pre">singularity.conf</span></code> can only be modified by an
administrator.</p>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>In this example we will changing the <code class="docutils literal notranslate"><span class="pre">BIND</span> <span class="pre">PATH</span></code> option described above.
First we can see the current list of bind paths set within our system
configuration:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity config global --get &quot;bind path&quot;
/etc/localtime,/etc/hosts
</pre></div>
</div>
<p>Now we can add a new path and verify it was successfully added:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity config global --set &quot;bind path&quot; /etc/resolv.conf
$ sudo singularity config global --get &quot;bind path&quot;
/etc/resolv.conf,/etc/localtime,/etc/hosts
</pre></div>
</div>
<p>From here we can remove a path with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity config global --unset &quot;bind path&quot; /etc/localtime
$ sudo singularity config global --get &quot;bind path&quot;
/etc/resolv.conf,/etc/hosts
</pre></div>
</div>
<p>If we want to reset the option to the default at installation, then we can
reset it with:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity config global --reset &quot;bind path&quot;
$ sudo singularity config global --get &quot;bind path&quot;
/etc/localtime,/etc/hosts
</pre></div>
</div>
<p>And now we are back to our original option settings. You can also test what a
change would look like by using the <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> option in conjunction with
the above commands. Instead of writing to the configuration file, it will
output what would have been written to the configuration file if the command
had been run without the <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> option:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity config global --dry-run --set &quot;bind path&quot; /etc/resolv.conf
# SINGULARITY.CONF
# This is the global configuration file for Singularity. This file controls
[...]
# BIND PATH: [STRING]
# DEFAULT: Undefined
# Define a list of files/directories that should be made available from within
# the container. The file or directory must exist within the container on
# which to attach to. you can specify a different source and destination
# path (respectively) with a colon; otherwise source and dest are the same.
# NOTE: these are ignored if singularity is invoked with --contain.
bind path = /etc/resolv.conf
bind path = /etc/localtime
bind path = /etc/hosts
[...]
$ sudo singularity config global --get &quot;bind path&quot;
/etc/localtime,/etc/hosts
</pre></div>
</div>
<p>Above we can see that <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> is listed as a bind path in the
output of the <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> command, but did not affect the actual bind paths
of the system.</p>
</div>
</div>
</div>
<div class="section" id="cgroups-toml">
<h2>cgroups.toml<a class="headerlink" href="#cgroups-toml" title="Permalink to this headline">¶</a></h2>
<p>Cgroups or Control groups let you implement metering and limiting on the
resources used by processes. You can limit memory, CPU. You can block IO,
network IO, set SEL permissions for device nodes etc.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--apply-cgroups</span></code> option can only be used with root privileges.</p>
</div>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>When you are limiting resources, apply the settings in the TOML file by using
the path as an argument to the <code class="docutils literal notranslate"><span class="pre">--apply-cgroups</span></code> option like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity shell --apply-cgroups /path/to/cgroups.toml my_container.sif
</pre></div>
</div>
</div>
<div class="section" id="limiting-memory">
<h3>Limiting memory<a class="headerlink" href="#limiting-memory" title="Permalink to this headline">¶</a></h3>
<p>To limit the amount of memory that your container uses to 500MB (524288000 bytes):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[memory]
    limit = 524288000
</pre></div>
</div>
<p>Start your container like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity instance start --apply-cgroups path/to/cgroups.toml my_container.sif instance1
</pre></div>
</div>
<p>After that, you can verify that the container is only using 500MB of memory.
(This example assumes that <code class="docutils literal notranslate"><span class="pre">instance1</span></code> is the only running instance.)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cat /sys/fs/cgroup/memory/singularity/*/memory.limit_in_bytes
  524288000
</pre></div>
</div>
<p>Do not forget to stop your instances after configuring the options.</p>
<p>Similarly, the remaining examples can be tested by starting instances and
examining the contents of the appropriate subdirectories of <code class="docutils literal notranslate"><span class="pre">/sys/fs/cgroup/</span></code>.</p>
</div>
<div class="section" id="limiting-cpu">
<h3>Limiting CPU<a class="headerlink" href="#limiting-cpu" title="Permalink to this headline">¶</a></h3>
<p>Limit CPU resources using one of the following strategies. The <code class="docutils literal notranslate"><span class="pre">cpu</span></code> section
of the configuration file can limit memory with the following:</p>
<p><strong>shares</strong></p>
<p>This corresponds to a ratio versus other cgroups with cpu shares. Usually the
default value is <code class="docutils literal notranslate"><span class="pre">1024</span></code>. That means if you want to allow to use 50% of a
single CPU, you will set <code class="docutils literal notranslate"><span class="pre">512</span></code> as value.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[cpu]
    shares = 512
</pre></div>
</div>
<p>A cgroup can get more than its share of CPU if there are enough idle CPU cycles
available in the system, due to the work conserving nature of the scheduler, so
a contained process can consume all CPU cycles even with a ratio of 50%. The
ratio is only applied when two or more processes conflicts with their needs of
CPU cycles.</p>
<p><strong>quota/period</strong></p>
<p>You can enforce hard limits on the CPU cycles a cgroup can consume, so
contained processes can’t use more than the amount of CPU time set for the
cgroup. <code class="docutils literal notranslate"><span class="pre">quota</span></code> allows you to configure the amount of CPU time that a cgroup
can use per period. The default is 100ms (100000us). So if you want to limit
amount of CPU time to 20ms during period of 100ms:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[cpu]
    period = 100000
    quota = 20000
</pre></div>
</div>
<p><strong>cpus/mems</strong></p>
<p>You can also restrict access to specific CPUs and associated memory nodes by
using <code class="docutils literal notranslate"><span class="pre">cpus/mems</span></code> fields:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[cpu]
    cpus = &quot;0-1&quot;
    mems = &quot;0-1&quot;
</pre></div>
</div>
<p>Where container has limited access to CPU 0 and CPU 1.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s important to set identical values for both <code class="docutils literal notranslate"><span class="pre">cpus</span></code> and <code class="docutils literal notranslate"><span class="pre">mems</span></code>.</p>
</div>
</div>
<div class="section" id="limiting-io">
<h3>Limiting IO<a class="headerlink" href="#limiting-io" title="Permalink to this headline">¶</a></h3>
<p>You can limit and monitor access to I/O for block devices.  Use the
<code class="docutils literal notranslate"><span class="pre">[blockIO]</span></code> section of the configuration file to do this like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[blockIO]
    weight = 1000
    leafWeight = 1000
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">weight</span></code> and <code class="docutils literal notranslate"><span class="pre">leafWeight</span></code> accept values between <code class="docutils literal notranslate"><span class="pre">10</span></code> and <code class="docutils literal notranslate"><span class="pre">1000</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">weight</span></code> is the default weight of the group on all the devices until and
unless overridden by a per device rule.</p>
<p><code class="docutils literal notranslate"><span class="pre">leafWeight</span></code> relates to weight for the purpose of deciding how heavily to
weigh tasks in the given cgroup while competing with the cgroup’s child
cgroups.</p>
<p>To override <code class="docutils literal notranslate"><span class="pre">weight/leafWeight</span></code> for <code class="docutils literal notranslate"><span class="pre">/dev/loop0</span></code> and <code class="docutils literal notranslate"><span class="pre">/dev/loop1</span></code> block
devices you would do something like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[blockIO]
    [[blockIO.weightDevice]]
        major = 7
        minor = 0
        weight = 100
        leafWeight = 50
    [[blockIO.weightDevice]]
        major = 7
        minor = 1
        weight = 100
        leafWeight = 50
</pre></div>
</div>
<p>You could limit the IO read/write rate to 16MB per second for the <code class="docutils literal notranslate"><span class="pre">/dev/loop0</span></code>
block device with the following configuration.  The rate is specified in bytes
per second.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[blockIO]
    [[blockIO.throttleReadBpsDevice]]
        major = 7
        minor = 0
        rate = 16777216
    [[blockIO.throttleWriteBpsDevice]]
        major = 7
        minor = 0
        rate = 16777216
</pre></div>
</div>
</div>
</div>
<div class="section" id="ecl-toml">
<span id="execution-control-list"></span><h2>ecl.toml<a class="headerlink" href="#ecl-toml" title="Permalink to this headline">¶</a></h2>
<p>The execution control list is defined here. You can authorize the containers by
validating both the location of the SIF file in the filesystem and by
checking against a list of signing entities.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[[execgroup]]
  tagname = &quot;group2&quot;
  mode = &quot;whitelist&quot;
  dirpath = &quot;/tmp/containers&quot;
  keyfp = [&quot;7064B1D6EFF01B1262FED3F03581D99FE87EAFD1&quot;]
</pre></div>
</div>
<p>Only the containers running from and signed with above-mentioned path and keys
will be authorized to run.</p>
<p>Three possible list modes you can choose from:</p>
<p><strong>Whitestrict</strong>: The SIF must be signed by <em>ALL</em> of the keys mentioned.</p>
<p><strong>Whitelist</strong>: As long as the SIF is signed by one or more of the keys, the
container is allowed to run.</p>
<p><strong>Blacklist</strong>: Only the containers whose keys are not mentioned in the group
are allowed to run.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The ECL checks will use the new signature format introduced in
Singularity 3.6.0. Containers signed with older versions of Singularity
Singularity will not pass ECL checks.</p>
<p>To temporarily permit the use of legacy insecure signatures, set
<code class="docutils literal notranslate"><span class="pre">legacyinsecure</span> <span class="pre">=</span> <span class="pre">true</span></code> in <code class="docutils literal notranslate"><span class="pre">ecl.toml</span></code>.</p>
</div>
<div class="section" id="managing-ecl-public-keys">
<h3>Managing ECL public keys<a class="headerlink" href="#managing-ecl-public-keys" title="Permalink to this headline">¶</a></h3>
<p>In Singularity 3.6, public keys associated with fingerprints specified in ECL rules
were required to be present in user’s local keyring which is not very
convenient. Singularity 3.7.0 provides a mechanism to administrators for managing
a global keyring that ECL uses during signature verification, for that purpose a
<code class="docutils literal notranslate"><span class="pre">--global</span></code> option was added for:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">key</span> <span class="pre">import</span></code> (root user only)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">key</span> <span class="pre">pull</span></code> (root user only)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">key</span> <span class="pre">remove</span></code> (root user only)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">key</span> <span class="pre">export</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">key</span> <span class="pre">list</span></code></p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For security reasons, it is not possible to import private keys
into this global keyring because it must be accessible by users
and is stored in the file <code class="docutils literal notranslate"><span class="pre">SYSCONFDIR/singularity/global-pgp-public</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="gpu-library-configuration">
<span id="id3"></span><h2>GPU Library Configuration<a class="headerlink" href="#gpu-library-configuration" title="Permalink to this headline">¶</a></h2>
<p>When a container includes a GPU enabled application, Singularity (with
the <code class="docutils literal notranslate"><span class="pre">--nv</span></code> or <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> options) can properly inject the required
Nvidia or AMD GPU driver libraries into the container, to match the
host’s kernel. The GPU <code class="docutils literal notranslate"><span class="pre">/dev</span></code> entries are provided in containers run
with <code class="docutils literal notranslate"><span class="pre">--nv</span></code> or <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> even if the <code class="docutils literal notranslate"><span class="pre">--contain</span></code> option is used
to restrict the in-container device tree.</p>
<p>Compatibility between containerized CUDA/ROCm/OpenCL applications and
host drivers/libraries is dependent on the versions of the GPU compute
frameworks that were used to build the applications. Compatibility and
usage information is discussed in the <cite>GPU Support</cite> section of the
<a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8">user guide</a></p>
<div class="section" id="nvidia-gpus-cuda">
<h3>NVIDIA GPUs / CUDA<a class="headerlink" href="#nvidia-gpus-cuda" title="Permalink to this headline">¶</a></h3>
<p>If the <a class="reference external" href="https://github.com/NVIDIA/libnvidia-container">nvidia-container-cli</a> tool is installed on
the host system, it will be used to locate any Nvidia libraries and
binaries on the host system.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> is not present, the <code class="docutils literal notranslate"><span class="pre">nvliblist.conf</span></code>
file is used to specify libraries and executables that need to be
injected into the container when running Singularity with the <code class="docutils literal notranslate"><span class="pre">--nv</span></code>
Nvidia GPU support option. The default <code class="docutils literal notranslate"><span class="pre">nvliblist.conf</span></code> is suitable
for CUDA 10.1, but may need to be modified if you need to include
additional libraries, or further libraries are added to newer versions
of the Nvidia driver/CUDA distribution.</p>
</div>
<div class="section" id="amd-radeon-gpus-rocm">
<h3>AMD Radeon GPUs / ROCm<a class="headerlink" href="#amd-radeon-gpus-rocm" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">rocmliblist.conf</span></code> file is used to specify libraries and
executables that need to be injected into the container when running
Singularity with the <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> Radeon GPU support option. The default
<code class="docutils literal notranslate"><span class="pre">rocmliblist.conf</span></code> is suitable for ROCm 2.10, but may need to modified
if you need to include additional libraries, or further libraries are
added to newer versions of the ROCm distribution.</p>
</div>
<div class="section" id="gpu-liblist-format">
<h3>GPU liblist format<a class="headerlink" href="#gpu-liblist-format" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">nvliblist.conf</span></code> and <code class="docutils literal notranslate"><span class="pre">rocmliblist</span></code> files list the basename of
executables and libraries to be bound into the container, without path
information.</p>
<p>Binaries are found by searching <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># put binaries here
# In shared environments you should ensure that permissions on these files
# exclude writing by non-privileged users.
rocm-smi
rocminfo
</pre></div>
</div>
<p>Libraries should be specified without version information,
i.e. <code class="docutils literal notranslate"><span class="pre">libname.so</span></code>, and are resolved using <code class="docutils literal notranslate"><span class="pre">ldconfig</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># put libs here (must end in .so)
libamd_comgr.so
libcomgr.so
libCXLActivityLogger.so
</pre></div>
</div>
<p>If you receive warnings that binaries or libraries are not found,
ensure that they are in a system path (binaries), or available in paths
configured in <code class="docutils literal notranslate"><span class="pre">/etc/ld.so.conf</span></code> (libraries).</p>
</div>
</div>
<div class="section" id="capability-json">
<h2>capability.json<a class="headerlink" href="#capability-json" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is extremely important to recognize that <strong>granting users Linux
capabilities with the</strong> <code class="docutils literal notranslate"><span class="pre">capability</span></code> <strong>command group is usually identical
to granting those users root level access on the host system</strong>. Most if not
all capabilities will allow users to “break out” of the container and
become root on the host. This feature is targeted toward special use cases
(like cloud-native architectures) where an admin/developer might want to
limit the attack surface within a container that normally runs as root.
This is not a good option in multi-tenant HPC environments where an admin
wants to grant a user special privileges within a container. For that and
similar use cases, the <a class="reference internal" href="user_namespace.html#fakeroot"><span class="std std-ref">fakeroot feature</span></a> is a better
option.</p>
</div>
<p>Singularity provides full support for admins to grant and revoke Linux
capabilities on a user or group basis. The <code class="docutils literal notranslate"><span class="pre">capability.json</span></code> file is
maintained by Singularity in order to manage these capabilities. The
<code class="docutils literal notranslate"><span class="pre">capability</span></code> command group allows you to <code class="docutils literal notranslate"><span class="pre">add</span></code>, <code class="docutils literal notranslate"><span class="pre">drop</span></code>, and <code class="docutils literal notranslate"><span class="pre">list</span></code>
capabilities for users and groups.</p>
<p>For example, let us suppose that we have decided to grant a user (named
<code class="docutils literal notranslate"><span class="pre">pinger</span></code>) capabilities to open raw sockets so that they can use <code class="docutils literal notranslate"><span class="pre">ping</span></code> in
a container where the binary is controlled via capabilities.</p>
<p>To do so, we would issue a command such as this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity capability add --user pinger CAP_NET_RAW
</pre></div>
</div>
<p>This means the user <code class="docutils literal notranslate"><span class="pre">pinger</span></code> has just been granted permissions (through Linux
capabilities) to open raw sockets within Singularity containers.</p>
<p>We can check that this change is in effect with the <code class="docutils literal notranslate"><span class="pre">capability</span> <span class="pre">list</span></code>
command.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity capability list --user pinger
CAP_NET_RAW
</pre></div>
</div>
<p>To take advantage of this new capability, the user <code class="docutils literal notranslate"><span class="pre">pinger</span></code> must also request
the capability when executing a container with the <code class="docutils literal notranslate"><span class="pre">--add-caps</span></code> flag.
<code class="docutils literal notranslate"><span class="pre">pinger</span></code> would need to run a command like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity exec --add-caps CAP_NET_RAW library://sylabs/tests/ubuntu_ping:v1.0 ping -c 1 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=52 time=73.1 ms

--- 8.8.8.8 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 73.178/73.178/73.178/0.000 ms
</pre></div>
</div>
<p>If we decide that it is no longer necessary to allow the user <code class="docutils literal notranslate"><span class="pre">pinger</span></code>
to open raw sockets within Singularity containers, we can revoke the
appropriate Linux capability like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity capability drop --user pinger CAP_NET_RAW
</pre></div>
</div>
<p>Now if <code class="docutils literal notranslate"><span class="pre">pinger</span></code> tries to use <code class="docutils literal notranslate"><span class="pre">CAP_NET_RAW</span></code>, Singularity will not give the
capability to the container and <code class="docutils literal notranslate"><span class="pre">ping</span></code> will fail to create a socket:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity exec --add-caps CAP_NET_RAW library://sylabs/tests/ubuntu_ping:v1.0 ping -c 1 8.8.8.8
WARNING: not authorized to add capability: CAP_NET_RAW
ping: socket: Operation not permitted
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">capability</span> <span class="pre">add</span></code> and <code class="docutils literal notranslate"><span class="pre">drop</span></code> subcommands will also accept the case
insensitive keyword <code class="docutils literal notranslate"><span class="pre">all</span></code> to grant or revoke all Linux capabilities to a user
or group.</p>
<p>For more information about individual Linux capabilities check out the
<a class="reference external" href="http://man7.org/linux/man-pages/man7/capabilities.7.html">man pages</a> or
use the <code class="docutils literal notranslate"><span class="pre">capability</span> <span class="pre">avail</span></code> command to output available capabilities with a
description of their behaviors.</p>
</div>
<div class="section" id="seccomp-profiles">
<h2>seccomp-profiles<a class="headerlink" href="#seccomp-profiles" title="Permalink to this headline">¶</a></h2>
<p>Secure Computing (seccomp) Mode is a feature of the Linux kernel that allows an
administrator to filter system calls being made from a container. Profiles made
up of allowed and restricted calls can be passed to different containers.
<em>Seccomp</em> provides more control than <em>capabilities</em> alone, giving a smaller
attack surface for an attacker to work from within a container.</p>
<p>You can set the default action with <code class="docutils literal notranslate"><span class="pre">defaultAction</span></code> for a non-listed system
call. Example: <code class="docutils literal notranslate"><span class="pre">SCMP_ACT_ALLOW</span></code> filter will allow all the system calls if it
matches the filter rule and you can set it to <code class="docutils literal notranslate"><span class="pre">SCMP_ACT_ERRNO</span></code> which will have
the thread receive a return value of <em>errno</em> if it calls a system call that matches
the filter rule.
The file is formatted in a way that it can take a list of additional system calls
for different architecture and Singularity will automatically take syscalls
related to the current architecture where it’s been executed.
The <code class="docutils literal notranslate"><span class="pre">include</span></code>/<code class="docutils literal notranslate"><span class="pre">exclude</span></code>-&gt; <code class="docutils literal notranslate"><span class="pre">caps</span></code> section will include/exclude the listed
system calls if the user has the associated capability.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">--security</span></code> option to invoke the container like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity shell --security seccomp:/home/david/my.json my_container.sif
</pre></div>
</div>
<p>For more insight into security options, network options, cgroups, capabilities,
etc, please check the <a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8">Userdocs</a>
and it’s <a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8/appendix.html">Appendix</a>.</p>
</div>
<div class="section" id="remote-yaml">
<h2>remote.yaml<a class="headerlink" href="#remote-yaml" title="Permalink to this headline">¶</a></h2>
<p>System-wide remote endpoints are defined in a configuration file typically
located at <code class="docutils literal notranslate"><span class="pre">/usr/local/etc/singularity/remote.yaml</span></code> (this location may
vary depending on installation parameters) and can be managed by
administrators with the <code class="docutils literal notranslate"><span class="pre">remote</span></code> command group.</p>
<div class="section" id="remote-endpoints">
<h3>Remote Endpoints<a class="headerlink" href="#remote-endpoints" title="Permalink to this headline">¶</a></h3>
<p>Sylabs introduced the online <a class="reference external" href="https://cloud.sylabs.io/home">Sylabs Cloud</a> to enable users to <a class="reference external" href="https://cloud.sylabs.io/builder">Create</a>, <a class="reference external" href="https://cloud.sylabs.io/keystore?sign=true">Secure</a>, and <a class="reference external" href="https://cloud.sylabs.io/library/guide#create">Share</a> their container
images with others.</p>
<p>Singularity allows users to login to an account on the Sylabs Cloud, or
configure Singularity to use an API compatable container service such as
a local installation of Singularity Enterprise, which provides an on-premise
private Container Library, Remote Builder and Key Store.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A fresh installation of Singularity is automatically configured
to connect to the public <a class="reference external" href="https://cloud.sylabs.io">Sylabs Cloud</a>
services.</p>
</div>
<p><strong>Examples</strong></p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">remote</span></code> command group with the <code class="docutils literal notranslate"><span class="pre">--global</span></code> flag to create a
system-wide remote endpoint:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity remote add --global company-remote https://enterprise.example.com
[sudo] password for dave:
INFO:    Remote &quot;company-remote&quot; added.
INFO:    Global option detected. Will not automatically log into remote.
</pre></div>
</div>
<p>Conversely, to remove a system-wide endpoint:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity remote remove --global company-remote
[sudo] password for dave:
INFO:    Remote &quot;company-remote&quot; removed.
</pre></div>
</div>
<p>Singularity 3.7 introduces the ability for an administrator to make a remote
the only usable remote for the system by using the <code class="docutils literal notranslate"><span class="pre">--exclusive</span></code> flag:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity remote use --exclusive company-remote
[sudo] password for dave:
INFO:    Remote &quot;company-remote&quot; now in use.
$ singularity remote list
Cloud Services Endpoints
========================

NAME            URI                     ACTIVE  GLOBAL  EXCLUSIVE
SylabsCloud     cloud.sylabs.io         NO      YES     NO
company-remote  enterprise.example.com  YES     YES     YES
myremote        enterprise.example.com  NO      NO      NO

Keyservers
==========

URI                       GLOBAL  INSECURE  ORDER
https://keys.example.com  YES     NO        1*

* Active cloud services keyserver
</pre></div>
</div>
<p>For more details on the <code class="docutils literal notranslate"><span class="pre">remote</span></code> command group and managing remote endpoints,
please check the <a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8/endpoint.html">Remote Userdocs</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Once users login to a system wide endpoint, a copy of the endpoint will be listed in
a their <code class="docutils literal notranslate"><span class="pre">~/.singularity/remote.yaml</span></code> file. This means modifications or removal of
the system-wide endpoint will not be reflected in the users configuration unless they
remove the endpoint themselves.</p>
</div>
</div>
<div class="section" id="keyserver-configuration">
<h3>Keyserver Configuration<a class="headerlink" href="#keyserver-configuration" title="Permalink to this headline">¶</a></h3>
<p>By default, Singularity will use the keyserver correlated to the active cloud
service endpoint. This behavior can be changed or supplemented via the
<code class="docutils literal notranslate"><span class="pre">add-keyserver</span></code> and <code class="docutils literal notranslate"><span class="pre">remove-keyserver</span></code> commands. These commands allow an
administrator to create a global list of key servers used to verify container
signatures by default.</p>
<p>For more details on the <code class="docutils literal notranslate"><span class="pre">remote</span></code> command group and managing keyservers,
please check the <a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8/endpoint.html">Remote Userdocs</a>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="user_namespace.html" class="btn btn-neutral float-right" title="User Namespaces &amp; Fakeroot" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="installation.html" class="btn btn-neutral float-left" title="Installing Singularity" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2020, Sylabs Inc.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>