<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Environment and Metadata &mdash; Apptainer User Guide main documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/js/ga.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Plugins" href="plugins.html" />
    <link rel="prev" title="Running Services" href="running_services.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Apptainer User Guide
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                main
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Apptainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security in Apptainer</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="definition_files.html">The Definition File</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_env.html">Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="fakeroot.html">Fakeroot feature</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="signNverify.html">Sign and Verify</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_commands.html">Key management commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="encryption.html">Encrypted Containers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="endpoint.html">Remote Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="library_api.html">Library API Registries</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_services.html">Running Services</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Environment and Metadata</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#environment-overview">Environment Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment-from-a-base-image">Environment From a Base Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment-from-a-definition-file">Environment From a Definition File</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build-time-variables-in-post">Build Time Variables in <code class="docutils literal notranslate"><span class="pre">%post</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#environment-from-the-host">Environment From the Host</a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment-from-the-apptainer-runtime">Environment From the Apptainer Runtime</a></li>
<li class="toctree-l2"><a class="reference internal" href="#overriding-environment-variables">Overriding Environment Variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#env-option"><code class="docutils literal notranslate"><span class="pre">--env</span></code> option</a></li>
<li class="toctree-l3"><a class="reference internal" href="#env-file-option"><code class="docutils literal notranslate"><span class="pre">--env-file</span></code> option</a></li>
<li class="toctree-l3"><a class="reference internal" href="#apptainerenv-prefix"><code class="docutils literal notranslate"><span class="pre">APPTAINERENV_</span></code> prefix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manipulating-path">Manipulating <code class="docutils literal notranslate"><span class="pre">PATH</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#escaping-and-evaluation-of-environment-variables">Escaping and Evaluation of Environment Variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#docker-oci-compatibility">Docker / OCI Compatibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-host-variables">Using Host Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-container-variables">Using Container Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quoting-avoiding-evaluation">Quoting / Avoiding Evaluation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#environment-variable-precedence">Environment Variable Precedence</a></li>
<li class="toctree-l2"><a class="reference internal" href="#umask-default-file-permissions">Umask / Default File Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#container-metadata">Container Metadata</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inherited-labels">Inherited Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-labels">Custom Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dynamic-build-time-labels">Dynamic Build Time Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inspecting-metadata">Inspecting Metadata</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#l-labels"><code class="docutils literal notranslate"><span class="pre">-l</span></code>/ <code class="docutils literal notranslate"><span class="pre">--labels</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#d-deffile"><code class="docutils literal notranslate"><span class="pre">-d</span></code> / <code class="docutils literal notranslate"><span class="pre">--deffile</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#r-runscript"><code class="docutils literal notranslate"><span class="pre">-r</span></code> / <code class="docutils literal notranslate"><span class="pre">--runscript</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#t-test"><code class="docutils literal notranslate"><span class="pre">-t</span></code> / <code class="docutils literal notranslate"><span class="pre">--test</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#e-environment"><code class="docutils literal notranslate"><span class="pre">-e</span></code> / <code class="docutils literal notranslate"><span class="pre">--environment</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#h-helpfile"><code class="docutils literal notranslate"><span class="pre">-H</span></code> / <code class="docutils literal notranslate"><span class="pre">--helpfile</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#j-json"><code class="docutils literal notranslate"><span class="pre">-j</span></code> / <code class="docutils literal notranslate"><span class="pre">--json</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#singularity-d-directory">/.singularity.d directory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_options.html">Security Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Network Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgroups.html">Limiting Container Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="checkpoint.html">Application Checkpointing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="singularity_compatibility.html">Singularity Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker_and_oci.html">Support for Docker / OCI Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci_runtime.html">OCI Runtime Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi.html">Apptainer and MPI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.html">GPU Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licenses</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Apptainer User Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Environment and Metadata</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apptainer/apptainer-userdocs/blob/master/environment_and_metadata.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="environment-and-metadata">
<span id="id1"></span><h1>Environment and Metadata<a class="headerlink" href="#environment-and-metadata" title="Permalink to this heading"></a></h1>
<p id="sec-envandmetadata">Environment variables are values you can set in a session, which can be
used to influence the behavior of programs. It’s often considered best
practice to use environment variables to pass settings to a program in a
container, because they are easily set and don’t rely on writing and
binding in program-specific configuration files. When building a
container you may need to set fixed or default environment variables.
When running containers you may need to set or override environment
variables.</p>
<p>The <a class="reference internal" href="#sec-metadata"><span class="std std-ref">metadata</span></a> of a container is information that
describes the container. Apptainer automatically records important
information such as the definition file used to build a container. Other
details such as the version of Apptainer used are present as
<a class="reference internal" href="#sec-labels"><span class="std std-ref">labels</span></a> on a container. You can also specify your own
to be recorded against your container.</p>
<section id="environment-overview">
<h2>Environment Overview<a class="headerlink" href="#environment-overview" title="Permalink to this heading"></a></h2>
<p>When you run a program in a container with Apptainer, the
environment variables that the program sees are a combination of:</p>
<blockquote>
<div><ul class="simple">
<li><p>The environment variables set in the base image (e.g. Docker
image) used to build the container.</p></li>
<li><p>The environment variables set in the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section of
the definition file used to build the container.</p></li>
<li><p><em>Most</em> of the environment variables set on your host, which are
passed into the container.</p></li>
<li><p>Any variables you set specifically for the container at runtime,
using the <code class="docutils literal notranslate"><span class="pre">--env</span></code>, <code class="docutils literal notranslate"><span class="pre">--env-file</span></code> options, or by setting
<code class="docutils literal notranslate"><span class="pre">APPTAINERENV_</span></code> variables outside of the container.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">PATH</span></code> variable can be manipulated to add entries.</p></li>
<li><p>Runtime variables <code class="docutils literal notranslate"><span class="pre">APPTAINER_xxx</span></code> set by Apptainer to
provide information about the container.</p></li>
</ul>
</div></blockquote>
<p>The environment variables from the base image or definition file used to
build a container always apply, but can be overridden.</p>
<p>You can choose to exclude passing environment variables from the host
into the container with the <code class="docutils literal notranslate"><span class="pre">-e</span></code> or <code class="docutils literal notranslate"><span class="pre">--cleanenv</span></code> option.</p>
<p>We’ll go through each place environment variables can be defined, so
that you can understand how the final environment in a container is
created, and can be manipulated.</p>
<p>If you are interested in variables available when you are <em>building</em> a
container, rather than when running a container, see <a class="reference internal" href="build_env.html#build-environment"><span class="std std-ref">build
environment section</span></a>.</p>
</section>
<section id="environment-from-a-base-image">
<h2>Environment From a Base Image<a class="headerlink" href="#environment-from-a-base-image" title="Permalink to this heading"></a></h2>
<p>When you build a container with Apptainer you might <em>bootstrap</em> from
a library or Docker image, or using Linux distribution bootstrap tools
such as <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code>, <code class="docutils literal notranslate"><span class="pre">yum</span></code> etc.</p>
<p>When using <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code>, <code class="docutils literal notranslate"><span class="pre">yum</span></code> etc. you are starting from a fresh
install of a Linux distribution into your container. No specific
environment variables will be set. If you are using a <code class="docutils literal notranslate"><span class="pre">library</span></code> or
<code class="docutils literal notranslate"><span class="pre">Docker</span></code> source then you may inherit environment variables from your
base image.</p>
<p>If I build an Apptainer container from the image
<code class="docutils literal notranslate"><span class="pre">docker://python:3.7</span></code> then when I run the container I can see that the
<code class="docutils literal notranslate"><span class="pre">PYTHON_VERSION</span></code> variable is set in the container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer exec python.sif env | grep PYTHON_VERSION
PYTHON_VERSION=3.7.7
</pre></div>
</div>
<p>This happens because the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> used to build that container has
<code class="docutils literal notranslate"><span class="pre">ENV</span> <span class="pre">PYTHON_VERSION</span> <span class="pre">3.7.7</span></code> set inside it.</p>
<p>You can override the inherited environment with <code class="docutils literal notranslate"><span class="pre">APPTAINERENV_</span></code> vars, or the
<code class="docutils literal notranslate"><span class="pre">--env</span> <span class="pre">/</span> <span class="pre">--env-file</span></code> flags (see below), but <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> <code class="docutils literal notranslate"><span class="pre">ENV</span></code> vars will
not be overridden by host environment variables of the same name.</p>
</section>
<section id="environment-from-a-definition-file">
<h2>Environment From a Definition File<a class="headerlink" href="#environment-from-a-definition-file" title="Permalink to this heading"></a></h2>
<p>Environment variables can be included in your container by adding them
to your definition file. Use <code class="docutils literal notranslate"><span class="pre">export</span></code> in the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section
of a definition file to set a container environment variable:</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: alpine

<span class="gh">%environment</span>
    <span class="nb">export</span> <span class="nv">MYVAR</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span>

<span class="gh">%runscript</span>
    <span class="nb">echo</span> <span class="nv">$MYVAR</span>
</pre></div>
</div>
<p>Now the value of <code class="docutils literal notranslate"><span class="pre">MYVAR</span></code> is <code class="docutils literal notranslate"><span class="pre">Hello</span></code> when the container is launched.
The <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> is set to echo the value.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer run env.sif
Hello
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Apptainer uses an embedded shell interpreter to evaluate and
setup container environments, therefore all commands executed from
the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section have an execution timeout of <strong>1 minute</strong>.
While it is possible to source a script from there, it
is not recommended to use this section to run potentially long
initialization tasks because this would impact users running the
image and the execution could abort due to timeout.</p>
</div>
<section id="build-time-variables-in-post">
<h3>Build Time Variables in <code class="docutils literal notranslate"><span class="pre">%post</span></code><a class="headerlink" href="#build-time-variables-in-post" title="Permalink to this heading"></a></h3>
<p>In some circumstances the value that needs to be assigned to an
environment variable may only be known after e.g. software
installation, in <code class="docutils literal notranslate"><span class="pre">%post</span></code>. For situations like this, the
<code class="docutils literal notranslate"><span class="pre">$APPTAINER_ENVIRONMENT</span></code> variable is provided. Redirecting text to
this variable will cause it to be written to a file called
<code class="docutils literal notranslate"><span class="pre">/.singularity.d/env/91-environment.sh</span></code> that will be sourced at
runtime.</p>
<p>Variables set in the <code class="docutils literal notranslate"><span class="pre">%post</span></code> section through
<code class="docutils literal notranslate"><span class="pre">$APPTAINER_ENVIRONMENT</span></code> take precedence over those added via
<code class="docutils literal notranslate"><span class="pre">%environment</span></code>.</p>
</section>
</section>
<section id="environment-from-the-host">
<h2>Environment From the Host<a class="headerlink" href="#environment-from-the-host" title="Permalink to this heading"></a></h2>
<p>If you have environment variables set outside of your container, on the
host, then by default they will be available inside the container.
Except that:</p>
<blockquote>
<div><ul class="simple">
<li><p>An environment variable set on the host will be overridden by a variable
of the same name that has been set either inside the container image, or
via <code class="docutils literal notranslate"><span class="pre">APPTAINERENV_</span></code> environment variables, or the <code class="docutils literal notranslate"><span class="pre">--env</span></code> and
<code class="docutils literal notranslate"><span class="pre">--env-file</span></code> flags.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">PS1</span></code> shell prompt is reset for a container specific prompt.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">PATH</span></code> environment variable will be modified to contain
default values.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> is modified to a default
<code class="docutils literal notranslate"><span class="pre">/.singularity.d/libs</span></code>, that will include NVIDIA / ROCm
libraries if applicable.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See compatibility documentation for <code class="docutils literal notranslate"><span class="pre">SINGULARITYENV_</span></code> prefixed environment
variable support <a class="reference internal" href="singularity_compatibility.html#singularity-environment-variable-compatibility"><span class="std std-ref">here</span></a>.</p>
</div>
<p>To override an environment variable that is already set in the container with
the value from the host, use <code class="docutils literal notranslate"><span class="pre">APPTAINERENV_</span></code> or the <code class="docutils literal notranslate"><span class="pre">--env</span></code> flag. For
example, to force <code class="docutils literal notranslate"><span class="pre">MYVAR</span></code> in the container to take the value of <code class="docutils literal notranslate"><span class="pre">MYVAR</span></code> on
the host:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ export APPTAINERENV_MYVAR=&quot;$MYVAR&quot;
$ apptainer run mycontainer.sif

# or
$ apptainer run --env &quot;MYVAR=$MYVAR&quot;
</pre></div>
</div>
<p>If you <em>do not want</em> the host environment variables to pass into the
container you can use the <code class="docutils literal notranslate"><span class="pre">-e</span></code> or <code class="docutils literal notranslate"><span class="pre">--cleanenv</span></code> option. This gives a
clean environment inside the container, with a minimal set of
environment variables for correct operation of most software.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer exec --cleanenv env.sif env
HOME=/home/dave
LANG=C
LD_LIBRARY_PATH=/.singularity.d/libs
PATH=/startpath:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
PROMPT_COMMAND=PS1=&quot;Apptainer&gt; &quot;; unset PROMPT_COMMAND
PS1=Apptainer&gt;
PWD=/home/dave/doc-tesrts
APPTAINER_COMMAND=exec
APPTAINER_CONTAINER=/home/dave/doc-tesrts/env.sif
APPTAINER_ENVIRONMENT=/.singularity.d/env/91-environment.sh
APPTAINER_NAME=env.sif
TERM=xterm-256color
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you work on a host system that sets a lot of environment
variables, e.g. because you use software made available through
environment modules / lmod, you may see strange behavior in your
container. Check your host environment with <code class="docutils literal notranslate"><span class="pre">env</span></code> for variables
such as <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code> that can change the way code runs, and
consider using <code class="docutils literal notranslate"><span class="pre">--cleanenv</span></code>.</p>
</div>
</section>
<section id="environment-from-the-apptainer-runtime">
<h2>Environment From the Apptainer Runtime<a class="headerlink" href="#environment-from-the-apptainer-runtime" title="Permalink to this heading"></a></h2>
<p>It can be useful for a program to know when it is running in a
Apptainer container, and some basic information about the container
environment. Apptainer will automatically set a number of
environment variables in a container that can be inspected by any
program running in the container.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">APPTAINER_COMMAND</span></code> - how the container was started, e.g.
<code class="docutils literal notranslate"><span class="pre">exec</span></code> / <code class="docutils literal notranslate"><span class="pre">run</span></code> / <code class="docutils literal notranslate"><span class="pre">shell</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">APPTAINER_CONTAINER</span></code> - the full path to the container image.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">APPTAINER_ENVIRONMENT</span></code> - path inside the container to the
shell script holding the container image environment settings.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">APPTAINER_NAME</span></code> - name of the container image, e.g.
<code class="docutils literal notranslate"><span class="pre">myfile.sif</span></code> or <code class="docutils literal notranslate"><span class="pre">docker://ubuntu</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">APPTAINER_BIND</span></code> - a list of bind paths that the user
requested, via flags or environment variables, when running the
container.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See compatibility documentation for <code class="docutils literal notranslate"><span class="pre">SINGULARITY_</span></code> prefixed environment
variable support <a class="reference internal" href="singularity_compatibility.html#singularity-environment-variable-compatibility"><span class="std std-ref">here</span></a>.</p>
</div>
</section>
<section id="overriding-environment-variables">
<h2>Overriding Environment Variables<a class="headerlink" href="#overriding-environment-variables" title="Permalink to this heading"></a></h2>
<p>You can override variables that have been set in the container image, or
define additional variables, in various ways as appropriate for your
workflow.</p>
<section id="env-option">
<h3><code class="docutils literal notranslate"><span class="pre">--env</span></code> option<a class="headerlink" href="#env-option" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">--env</span></code> option on the <code class="docutils literal notranslate"><span class="pre">run/exec/shell</span></code> commands allows you to
specify environment variables as <code class="docutils literal notranslate"><span class="pre">NAME=VALUE</span></code> pairs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer run env.sif
Hello

$ apptainer run --env MYVAR=Goodbye env.sif
Goodbye
</pre></div>
</div>
<p>Separate multiple variables with commas, e.g. <code class="docutils literal notranslate"><span class="pre">--env</span>
<span class="pre">MYVAR=A,MYVAR2=B</span></code>, and use shell quoting / shell escape if your
variables include special characters.</p>
</section>
<section id="env-file-option">
<h3><code class="docutils literal notranslate"><span class="pre">--env-file</span></code> option<a class="headerlink" href="#env-file-option" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">--env-file</span></code> option lets you provide a file that contains
environment variables as <code class="docutils literal notranslate"><span class="pre">NAME=VALUE</span></code> pairs, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat myenvs
MYVAR=&quot;Hello from a file&quot;

$ apptainer run --env-file myenvs env.sif
Hello from a file
</pre></div>
</div>
</section>
<section id="apptainerenv-prefix">
<h3><code class="docutils literal notranslate"><span class="pre">APPTAINERENV_</span></code> prefix<a class="headerlink" href="#apptainerenv-prefix" title="Permalink to this heading"></a></h3>
<p>If you export an environment variable on your host called
<code class="docutils literal notranslate"><span class="pre">APPTAINERENV_xxx</span></code> <em>before</em> you run a container, then it will set
the environment variable <code class="docutils literal notranslate"><span class="pre">xxx</span></code> inside the container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer run env.sif
Hello

$ export APPTAINERENV_MYVAR=&quot;Overridden&quot;
$ apptainer run env.sif
Overridden
</pre></div>
</div>
</section>
<section id="manipulating-path">
<h3>Manipulating <code class="docutils literal notranslate"><span class="pre">PATH</span></code><a class="headerlink" href="#manipulating-path" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a special environment variable that tells a system where to
look for programs that can be run. <code class="docutils literal notranslate"><span class="pre">PATH</span></code> contains multiple filesystem</p>
<p>locations (paths) separated by colons. When you ask to run a program
<code class="docutils literal notranslate"><span class="pre">myprog</span></code>, the system looks through these locations one by one, until
it finds <code class="docutils literal notranslate"><span class="pre">myprog</span></code>.</p>
<p>To ensure containers work correctly, when a host <code class="docutils literal notranslate"><span class="pre">PATH</span></code> might contain
a lot of host-specific locations that are not present in the container,
Apptainer will ensure <code class="docutils literal notranslate"><span class="pre">PATH</span></code> in the container is set to a default.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span>
</pre></div>
</div>
<p>This covers the standard locations for software installed using a system
package manager in most Linux distributions. If you have software
installed elsewhere in the container, then you can override this by
setting <code class="docutils literal notranslate"><span class="pre">PATH</span></code> in the container definition <code class="docutils literal notranslate"><span class="pre">%environment</span></code> block.</p>
<p>If your container depends on things that are bind mounted into it, or
you have another need to modify the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> variable when starting a
container, you can do so with <code class="docutils literal notranslate"><span class="pre">APPTAINERENV_APPEND_PATH</span></code> or
<code class="docutils literal notranslate"><span class="pre">APPTAINERENV_PREPEND_PATH</span></code>.</p>
<p>If you set a variable on your host called <code class="docutils literal notranslate"><span class="pre">APPTAINERENV_APPEND_PATH</span></code>
then its value will be appended (added to the end) of the <code class="docutils literal notranslate"><span class="pre">PATH</span></code>
variable in the container.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer exec env.sif sh -c &#39;echo $PATH&#39;
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

$ export APPTAINERENV_APPEND_PATH=&quot;/endpath&quot;
$ apptainer exec env.sif sh -c &#39;echo $PATH&#39;
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/endpath
</pre></div>
</div>
<p>Alternatively you could use the <code class="docutils literal notranslate"><span class="pre">--env</span></code> option to set a
<code class="docutils literal notranslate"><span class="pre">APPEND_PATH</span></code> variable, e.g. <code class="docutils literal notranslate"><span class="pre">--env</span> <span class="pre">APPEND_PATH=/endpath</span></code>.</p>
<p>If you set a variable on your host called
<code class="docutils literal notranslate"><span class="pre">APPTAINERENV_PREPEND_PATH</span></code> then its value will be prepended (added
to the start) of the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> variable in the container.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer exec env.sif sh -c &#39;echo $PATH&#39;
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

$ export APPTAINERENV_PREPEND_PATH=&quot;/startpath&quot;
$ apptainer exec env.sif sh -c &#39;echo $PATH&#39;
/startpath:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</pre></div>
</div>
<p>Alternatively you could use the <code class="docutils literal notranslate"><span class="pre">--env</span></code> option to set a
<code class="docutils literal notranslate"><span class="pre">PREPEND_PATH</span></code> variable, e.g. <code class="docutils literal notranslate"><span class="pre">--env</span> <span class="pre">PREPEND_PATH=/startpath</span></code>.</p>
</section>
</section>
<section id="escaping-and-evaluation-of-environment-variables">
<span id="escaping-environment"></span><h2>Escaping and Evaluation of Environment Variables<a class="headerlink" href="#escaping-and-evaluation-of-environment-variables" title="Permalink to this heading"></a></h2>
<p>Apptainer uses an embedded shell interpreter to process the container
startup scripts and environment. When this processing is performed, by default a
single step of shell evaluation happens in the container context. The shell from
which you are running Apptainer may also evaluate variables on your command
line before passing them to Apptainer.</p>
<section id="docker-oci-compatibility">
<h3>Docker / OCI Compatibility<a class="headerlink" href="#docker-oci-compatibility" title="Permalink to this heading"></a></h3>
<p>This default behavior of Apptainer differs from Docker/OCI handling of
environment variables / <code class="docutils literal notranslate"><span class="pre">ENV</span></code> directives. To avoid the extra evaluation of
variables that Apptainer performs you can:</p>
<ul class="simple">
<li><p>Follow the instructions about escaping in the sections below, to add
additional escape characters and/or quoting.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">--no-eval</span></code> or <code class="docutils literal notranslate"><span class="pre">--compat</span></code> flags.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">--no-eval</span></code> prevents Apptainer from evaluating environment variables on
container startup, so that they will take the same value as with a Docker/OCI
runtime:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Set an environment variable that would run `date` if evaluated
$ export APPTAINER_MYVAR=&#39;$(date)&#39;

# Default behavior
# MYVAR was evaluated in the container, and is set to the output of `date`
$ apptainer run ~/ubuntu_latest.sif env | grep MYVAR
MYVAR=Tue Apr 26 14:37:07 CDT 2022

# --no-eval / --compat behavior
# MYVAR was not evaluated and is a literal `$(date)`
$ apptainer run --no-eval ~/ubuntu_latest.sif env | grep MYVAR
MYVAR=$(date)
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--compat</span></code> flag is a short-hand flag to activate <code class="docutils literal notranslate"><span class="pre">--no-eval</span></code> along with
other Docker/OCI compatibility flags. See <a class="reference internal" href="docker_and_oci.html#compat-flag"><span class="std std-ref">Docker-like --compat Flag</span></a> for more details.</p>
</section>
<section id="using-host-variables">
<h3>Using Host Variables<a class="headerlink" href="#using-host-variables" title="Permalink to this heading"></a></h3>
<p>To set a container environment variable to the value of a variable on
the host, use double quotes around the variable, so that it is
processed by the host shell before the value is passed to
Apptainer. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">run</span> <span class="o">--</span><span class="n">env</span> <span class="s2">&quot;MYHOST=$HOSTNAME&quot;</span> <span class="n">mycontainer</span><span class="o">.</span><span class="n">sif</span>
</pre></div>
</div>
<p>This will set the <code class="docutils literal notranslate"><span class="pre">MYHOST</span></code> environment variable inside the container
to the value of the <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> on the host system. <code class="docutils literal notranslate"><span class="pre">$HOSTNAME</span></code> is
substituted before the host shell runs <code class="docutils literal notranslate"><span class="pre">apptainer</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can often use no quotes, but it is good practice to use quotes
consistently so that variables containing e.g. spaces are handled
correctly.</p>
</div>
</section>
<section id="using-container-variables">
<h3>Using Container Variables<a class="headerlink" href="#using-container-variables" title="Permalink to this heading"></a></h3>
<p>To set an environment variable to a value that references another
variable inside the container, you should escape the <code class="docutils literal notranslate"><span class="pre">$</span></code> sign to
<code class="docutils literal notranslate"><span class="pre">\$</span></code>. This prevents the host shell from substituting the
value. Instead it will be substituted inside the container.</p>
<p>For example, to create an environment variable <code class="docutils literal notranslate"><span class="pre">MYPATH</span></code>, with the
same value as <code class="docutils literal notranslate"><span class="pre">PATH</span></code> in the container (not the host’s <code class="docutils literal notranslate"><span class="pre">PATH</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">run</span> <span class="o">--</span><span class="n">env</span> <span class="s2">&quot;MYPATH=\$PATH&quot;</span> <span class="n">mycontainer</span><span class="o">.</span><span class="n">sif</span>
</pre></div>
</div>
<p>You can also use this approach to append or prepend to variables that
are already set in the container. For example, <code class="docutils literal notranslate"><span class="pre">--env</span>
<span class="pre">PATH=&quot;\$PATH:/endpath&quot;</span></code> would have the same effect as <code class="docutils literal notranslate"><span class="pre">--env</span>
<span class="pre">APPEND_PATH=&quot;/endpath&quot;</span></code>, which uses the special <code class="docutils literal notranslate"><span class="pre">APPEND/PREPEND</span></code>
handling for <code class="docutils literal notranslate"><span class="pre">PATH</span></code> discussed above.</p>
</section>
<section id="quoting-avoiding-evaluation">
<h3>Quoting / Avoiding Evaluation<a class="headerlink" href="#quoting-avoiding-evaluation" title="Permalink to this heading"></a></h3>
<p>If you need to pass an environment variable into the container
verbatim, it must be quoted and escaped appropriately. For example, if
you need to set a path containing a literal <code class="docutils literal notranslate"><span class="pre">$LIB</span></code> for the
<code class="docutils literal notranslate"><span class="pre">LD_PRELOAD</span></code> environment variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">run</span> <span class="o">--</span><span class="n">env</span><span class="o">=</span><span class="s2">&quot;LD_PRELOAD=/foo/bar/</span><span class="se">\\</span><span class="s2">\$LIB/baz.so&quot;</span> <span class="n">mycontainer</span><span class="o">.</span><span class="n">sif</span>
</pre></div>
</div>
<p>This will result in <code class="docutils literal notranslate"><span class="pre">LD_PRELOAD</span></code> having the value
<code class="docutils literal notranslate"><span class="pre">/foo/bar/$LIB/baz.so</span></code> inside the container.</p>
<p>The host shell consumes the double <code class="docutils literal notranslate"><span class="pre">\\</span></code>, and then environment
processing within Apptainer will consume the third <code class="docutils literal notranslate"><span class="pre">\</span></code> that
escapes the literal <code class="docutils literal notranslate"><span class="pre">$</span></code>.</p>
<p>You can also use single quotes on the command line, to avoid one
level of escaping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">run</span> <span class="o">--</span><span class="n">env</span><span class="o">=</span><span class="s1">&#39;LD_PRELOAD=/foo/bar/\$LIB/baz.so&#39;</span> <span class="n">mycontainer</span><span class="o">.</span><span class="n">sif</span>
</pre></div>
</div>
</section>
</section>
<section id="environment-variable-precedence">
<h2>Environment Variable Precedence<a class="headerlink" href="#environment-variable-precedence" title="Permalink to this heading"></a></h2>
<p>When a container is run with Apptainer, the container
environment is constructed in the following order:</p>
<blockquote>
<div><ul class="simple">
<li><p>Clear the environment, keeping just <code class="docutils literal notranslate"><span class="pre">HOME</span></code> and
<code class="docutils literal notranslate"><span class="pre">APPTAINER_APPNAME</span></code>.</p></li>
<li><p>Set Docker/OCI defined environment variables, where a Docker or
OCI image was used as the base for the container build.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is not defined set the Apptainer default <code class="docutils literal notranslate"><span class="pre">PATH</span></code>
<em>or</em></p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is defined, add any missing path parts from
Apptainer defaults</p></li>
<li><p>Set environment variables defined explicitly in the
<code class="docutils literal notranslate"><span class="pre">%environment</span></code> section of the definition file. These can
override any previously set values.</p></li>
<li><p>Set environment variables that were defined in the <code class="docutils literal notranslate"><span class="pre">%post</span></code>
section of the build, by addition to the
<code class="docutils literal notranslate"><span class="pre">$APPTAINER_ENVIRONMENT</span></code> file.</p></li>
<li><p>Set SCIF (<code class="docutils literal notranslate"><span class="pre">--app</span></code>) environment variables</p></li>
<li><p>Set base environment essential vars (<code class="docutils literal notranslate"><span class="pre">PS1</span></code> and
<code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code>)</p></li>
<li><p>Inject <code class="docutils literal notranslate"><span class="pre">APPTAINERENV_</span></code> / <code class="docutils literal notranslate"><span class="pre">--env</span></code> / <code class="docutils literal notranslate"><span class="pre">--env-file</span></code> variables
so they can override or modify any previous values.</p></li>
<li><p>Apply special <code class="docutils literal notranslate"><span class="pre">APPEND_PATH</span></code> / <code class="docutils literal notranslate"><span class="pre">PREPEND_PATH</span></code> handling.</p></li>
<li><p>Restore environment variables from the host, if they have not
already been set in the container, and the <code class="docutils literal notranslate"><span class="pre">--cleanenv</span></code> /
<code class="docutils literal notranslate"><span class="pre">--containall</span></code> options were not specified.</p></li>
</ul>
</div></blockquote>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While Apptainer will process additional scripts found under
<code class="docutils literal notranslate"><span class="pre">/.singularity.d/env</span></code> inside the container, it is strongly
recommended to avoid manipulating the container environment by
directly adding or modifying scripts in this directory. Please use
the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section of the definition file, and the
<code class="docutils literal notranslate"><span class="pre">$APPTAINER_ENVIRONMENT</span></code> file from <code class="docutils literal notranslate"><span class="pre">%post</span></code> if required.</p>
<p>A future version of Apptainer may move container scripts,
environment, and metadata outside of the container’s root
filesystem. This will permit further reproducibility and
compatibility improvements, but will preclude environment
manipulation via arbitrary scripts.</p>
</div>
</section>
<section id="umask-default-file-permissions">
<span id="sec-umask"></span><h2>Umask / Default File Permissions<a class="headerlink" href="#umask-default-file-permissions" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">umask</span></code> value on a Linux system controls the default permissions
for newly created files. It is not an environment variable, but
influences the behavior of programs in the container when they create
new files.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A detailed description of what the <code class="docutils literal notranslate"><span class="pre">umask</span></code> is, and how it works can
be found at <a class="reference external" href="https://en.wikipedia.org/wiki/Umask">Wikipedia</a>.</p>
</div>
<p>Apptainer sets the <code class="docutils literal notranslate"><span class="pre">umask</span></code> in the container to match
the value outside, unless:</p>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">--fakeroot</span></code> option is used, in which case a <code class="docutils literal notranslate"><span class="pre">0022</span></code> umask
is set so that <code class="docutils literal notranslate"><span class="pre">root</span></code> owned newly created files have expected
‘system default’ permissions, and can be accessed by other
non-root users who may use the same container later.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">--no-umask</span></code> option is used, in which case a <code class="docutils literal notranslate"><span class="pre">0022</span></code> umask
is set.</p></li>
</ul>
</div></blockquote>
</section>
<section id="container-metadata">
<span id="sec-metadata"></span><h2>Container Metadata<a class="headerlink" href="#container-metadata" title="Permalink to this heading"></a></h2>
<p>Each Apptainer container has metadata describing the container, how
it was built, etc. This metadata includes the definition file used to
build the container and labels, which are specific pieces of information
set automatically or explicitly when the container is built.</p>
<p>Apptainer container default labels are represented using the
<a class="reference external" href="http://label-schema.org/rc1/">rc1 Label Schema</a>.</p>
<section id="inherited-labels">
<span id="sec-labels"></span><h3>Inherited Labels<a class="headerlink" href="#inherited-labels" title="Permalink to this heading"></a></h3>
<p>When building a container from an existing image, either directly from a
URI or with a definition file, your container will inherit the labels
that are set in that base image. For example the <code class="docutils literal notranslate"><span class="pre">LABEL</span></code> a Docker
container sets in its <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, or a SIF container that sets
labels in its definition file as described below.</p>
<p>Inherited labels can only be overwritten during a build when the build
is performed using the <code class="docutils literal notranslate"><span class="pre">--force</span></code> option. Apptainer will warn that
it is not modifying an existing label when <code class="docutils literal notranslate"><span class="pre">--force</span></code> is not used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer build test2.sif test2.def
...
INFO:    Adding labels
WARNING: Label: OWNER already exists and force option is false, not overwriting
</pre></div>
</div>
</section>
<section id="custom-labels">
<h3>Custom Labels<a class="headerlink" href="#custom-labels" title="Permalink to this heading"></a></h3>
<p>You can add custom labels to your container using the <code class="docutils literal notranslate"><span class="pre">%labels</span></code>
section in a definition file:</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: ubuntu:latest

<span class="gh">%labels</span>
  OWNER Joana
</pre></div>
</div>
</section>
<section id="dynamic-build-time-labels">
<h3>Dynamic Build Time Labels<a class="headerlink" href="#dynamic-build-time-labels" title="Permalink to this heading"></a></h3>
<p>You may wish to set a label to a value that is not known in advance,
when you are writing the definition file, but can be obtained in the
<code class="docutils literal notranslate"><span class="pre">%post</span></code> section of your definition file while the container is
building.</p>
<p>Apptainer allows this, through adding labels to the
file defined by the <code class="docutils literal notranslate"><span class="pre">APPTAINER_LABELS</span></code> environment variable in the
<code class="docutils literal notranslate"><span class="pre">%post</span></code> section:</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: ubuntu:latest<span class="c"></span>

<span class="c"># These labels take a fixed value in the definition</span>
<span class="gh">%labels</span>
  OWNER Joana

<span class="c1"># We can now also set labels to a value at build time</span>
<span class="gh">%post</span>
  <span class="nv">VAL</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>myprog --version<span class="k">)</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;my.label </span><span class="nv">$VAL</span><span class="s2">&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="nv">$APPTAINER_LABELS</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Labels must be added to the file one per line, in a <code class="docutils literal notranslate"><span class="pre">NAME</span> <span class="pre">VALUE</span></code>
format, where the name and value are separated by a space.</p>
</section>
<section id="inspecting-metadata">
<h3>Inspecting Metadata<a class="headerlink" href="#inspecting-metadata" title="Permalink to this heading"></a></h3>
<p id="inspect-command">The <code class="docutils literal notranslate"><span class="pre">inspect</span></code> command gives you the ability to view the labels and/or
other metadata that were added to your container when it was built.</p>
<section id="l-labels">
<h4><code class="docutils literal notranslate"><span class="pre">-l</span></code>/ <code class="docutils literal notranslate"><span class="pre">--labels</span></code><a class="headerlink" href="#l-labels" title="Permalink to this heading"></a></h4>
<p>Running inspect without any options, or with the <code class="docutils literal notranslate"><span class="pre">-l</span></code> or <code class="docutils literal notranslate"><span class="pre">--labels</span></code>
options will display any labels set on the container</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer inspect ubuntu.sif
<span class="go">my.label: version 1.2.3</span>
<span class="go">OWNER: Joana</span>
<span class="go">org.label-schema.build-arch: amd64</span>
<span class="go">org.label-schema.build-date: Thursday_12_November_2020_10:51:59_CST</span>
<span class="go">org.label-schema.schema-version: 1.0</span>
<span class="go">org.label-schema.usage.singularity.deffile.bootstrap: docker</span>
<span class="go">org.label-schema.usage.singularity.deffile.from: ubuntu:latest</span>
<span class="go">org.label-schema.usage.singularity.version: 3.7.0-rc.1</span>
</pre></div>
</div>
<p>We can easily see when the container was built, the source of the base
image, and the exact version of Apptainer that was used to build it.</p>
<p>The custom label <code class="docutils literal notranslate"><span class="pre">OWNER</span></code> that we set in our definition file is also
visible.</p>
</section>
<section id="d-deffile">
<h4><code class="docutils literal notranslate"><span class="pre">-d</span></code> / <code class="docutils literal notranslate"><span class="pre">--deffile</span></code><a class="headerlink" href="#d-deffile" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">-d</span></code> or <code class="docutils literal notranslate"><span class="pre">-deffile</span></code> flag shows the definition file(s) that were
used to build the container.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer inspect --deffile jupyter.sif
</pre></div>
</div>
<p>And the output would look like:</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: debian:<span class="m">9</span>

<span class="gh">%help</span>
    Container with Anaconda <span class="m">2</span> <span class="o">(</span>Conda <span class="m">4</span>.5.11 Canary<span class="o">)</span> and Jupyter Notebook <span class="m">5</span>.6.0 <span class="k">for</span> Debian <span class="m">9</span>.x <span class="o">(</span>Stretch<span class="o">)</span>.
    This installation is based on Python <span class="m">2</span>.7.15

<span class="gh">%environment</span>
    <span class="nv">JUP_PORT</span><span class="o">=</span><span class="m">8888</span>
    <span class="nv">JUP_IPNAME</span><span class="o">=</span>localhost
    <span class="nb">export</span> JUP_PORT JUP_IPNAME

<span class="gh">%startscript</span>
    <span class="nv">PORT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$JUP_PORT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">PORT</span><span class="o">=</span><span class="s2">&quot;--port=</span><span class="si">${</span><span class="nv">JUP_PORT</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">fi</span>

    <span class="nv">IPNAME</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$JUP_IPNAME</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">IPNAME</span><span class="o">=</span><span class="s2">&quot;--ip=</span><span class="si">${</span><span class="nv">JUP_IPNAME</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">fi</span>

    <span class="nb">exec</span> jupyter notebook --allow-root <span class="si">${</span><span class="nv">PORT</span><span class="si">}</span> <span class="si">${</span><span class="nv">IPNAME</span><span class="si">}</span>

<span class="gh">%setup</span>
    <span class="c1">#Create the .condarc file where the environments/channels from conda are specified, these are pulled with preference to root</span>
    <span class="nb">cd</span> /
    touch .condarc

<span class="gh">%post</span>
    <span class="nb">echo</span> <span class="s1">&#39;export RANDOM=123456&#39;</span> &gt;&gt;<span class="nv">$APPTAINER_ENVIRONMENT</span>
    <span class="c1">#Installing all dependencies</span>
    apt-get update <span class="o">&amp;&amp;</span> apt-get -y upgrade
    apt-get -y install <span class="se">\</span>
    build-essential <span class="se">\</span>
    wget <span class="se">\</span>
    bzip2 <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    libglib2.0-0 <span class="se">\</span>
    libxext6 <span class="se">\</span>
    libsm6 <span class="se">\</span>
    libxrender1 <span class="se">\</span>
    git
    rm -rf /var/lib/apt/lists/*
    apt-get clean
    <span class="c1">#Installing Anaconda 2 and Conda 4.5.11</span>
    wget -c https://repo.continuum.io/archive/Anaconda2-5.3.0-Linux-x86_64.sh
    /bin/bash Anaconda2-5.3.0-Linux-x86_64.sh -bfp /usr/local
    <span class="c1">#Conda configuration of channels from .condarc file</span>
    conda config --file /.condarc --add channels defaults
    conda config --file /.condarc --add channels conda-forge
    conda update conda
    <span class="c1">#List installed environments</span>
    conda list
</pre></div>
</div>
<p>Which is the definition file for the <code class="docutils literal notranslate"><span class="pre">jupyter.sif</span></code> container.</p>
</section>
<section id="r-runscript">
<h4><code class="docutils literal notranslate"><span class="pre">-r</span></code> / <code class="docutils literal notranslate"><span class="pre">--runscript</span></code><a class="headerlink" href="#r-runscript" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">-r</span></code> or <code class="docutils literal notranslate"><span class="pre">--runscript</span></code> option shows the runscript for the image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer inspect --runscript jupyter.sif
</pre></div>
</div>
<p>And the output would look like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nv">OCI_ENTRYPOINT</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="nv">OCI_CMD</span><span class="o">=</span><span class="s2">&quot;bash&quot;</span>
<span class="c1"># ENTRYPOINT only - run entrypoint plus args</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$OCI_CMD</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$OCI_ENTRYPOINT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nv">SINGULARITY_OCI_RUN</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCI_ENTRYPOINT</span><span class="si">}</span><span class="s2"> </span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="c1"># CMD only - run CMD or override with args</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$OCI_CMD</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$OCI_ENTRYPOINT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -gt <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">SINGULARITY_OCI_RUN</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="k">else</span>
    <span class="nv">SINGULARITY_OCI_RUN</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCI_CMD</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">fi</span>
<span class="k">fi</span>

<span class="c1"># ENTRYPOINT and CMD - run ENTRYPOINT with CMD as default args</span>
<span class="c1"># override with user provided args</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -gt <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">SINGULARITY_OCI_RUN</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCI_ENTRYPOINT</span><span class="si">}</span><span class="s2"> </span><span class="nv">$@</span><span class="s2">&quot;</span>
<span class="k">else</span>
    <span class="nv">SINGULARITY_OCI_RUN</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">OCI_ENTRYPOINT</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">OCI_CMD</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">fi</span>

<span class="nb">exec</span> <span class="nv">$SINGULARITY_OCI_RUN</span>
</pre></div>
</div>
</section>
<section id="t-test">
<h4><code class="docutils literal notranslate"><span class="pre">-t</span></code> / <code class="docutils literal notranslate"><span class="pre">--test</span></code><a class="headerlink" href="#t-test" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">-t</span></code> or <code class="docutils literal notranslate"><span class="pre">--test</span></code> flag shows the test script for the image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer inspect --test jupyter.sif
</pre></div>
</div>
<p>This will output the corresponding <code class="docutils literal notranslate"><span class="pre">%test</span></code> section from the definition
file.</p>
</section>
<section id="e-environment">
<h4><code class="docutils literal notranslate"><span class="pre">-e</span></code> / <code class="docutils literal notranslate"><span class="pre">--environment</span></code><a class="headerlink" href="#e-environment" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">-e</span></code> or <code class="docutils literal notranslate"><span class="pre">--environment</span></code> flag shows the environment variables
that are defined in the container image. These may be set from one or
more environment files, depending on how the container was built.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer inspect --environment jupyter.sif
</pre></div>
</div>
<p>And the output would look like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">==</span><span class="m">90</span>-environment.sh<span class="o">==</span>
<span class="c1">#!/bin/sh</span>

<span class="nv">JUP_PORT</span><span class="o">=</span><span class="m">8888</span>
<span class="nv">JUP_IPNAME</span><span class="o">=</span>localhost
<span class="nb">export</span> JUP_PORT JUP_IPNAME
</pre></div>
</div>
</section>
<section id="h-helpfile">
<h4><code class="docutils literal notranslate"><span class="pre">-H</span></code> / <code class="docutils literal notranslate"><span class="pre">--helpfile</span></code><a class="headerlink" href="#h-helpfile" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">-H</span></code> or <code class="docutils literal notranslate"><span class="pre">-helpfile</span></code> flag will show the container’s description
in the <code class="docutils literal notranslate"><span class="pre">%help</span></code> section of its definition file.</p>
<p>You can call it this way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ apptainer inspect --helpfile jupyter.sif
</pre></div>
</div>
<p>And the output would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Container</span> <span class="k">with</span> <span class="n">Anaconda</span> <span class="mi">2</span> <span class="p">(</span><span class="n">Conda</span> <span class="mf">4.5.11</span> <span class="n">Canary</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Jupyter</span> <span class="n">Notebook</span> <span class="mf">5.6.0</span> <span class="k">for</span> <span class="n">Debian</span> <span class="mf">9.</span><span class="n">x</span> <span class="p">(</span><span class="n">Stretch</span><span class="p">)</span><span class="o">.</span>
<span class="n">This</span> <span class="n">installation</span> <span class="ow">is</span> <span class="n">based</span> <span class="n">on</span> <span class="n">Python</span> <span class="mf">2.7.15</span>
</pre></div>
</div>
</section>
<section id="j-json">
<h4><code class="docutils literal notranslate"><span class="pre">-j</span></code> / <code class="docutils literal notranslate"><span class="pre">--json</span></code><a class="headerlink" href="#j-json" title="Permalink to this heading"></a></h4>
<p>This flag gives you the possibility to output your labels in a JSON
format.</p>
<p>You can call it this way:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer inspect --json ubuntu.sif
</pre></div>
</div>
<p>And the output would look like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="nt">&quot;my.label&quot;</span><span class="p">:</span> <span class="s2">&quot;version 1.2.3&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;OWNER&quot;</span><span class="p">:</span> <span class="s2">&quot;Joana&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;org.label-schema.build-arch&quot;</span><span class="p">:</span> <span class="s2">&quot;amd64&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;org.label-schema.build-date&quot;</span><span class="p">:</span> <span class="s2">&quot;Thursday_12_November_2020_10:51:59_CST&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;org.label-schema.schema-version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;org.label-schema.usage.singularity.deffile.bootstrap&quot;</span><span class="p">:</span> <span class="s2">&quot;docker&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;org.label-schema.usage.singularity.deffile.from&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu:latest&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;org.label-schema.usage.singularity.version&quot;</span><span class="p">:</span> <span class="s2">&quot;3.7.0-rc.1&quot;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;container&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="singularity-d-directory">
<h2>/.singularity.d directory<a class="headerlink" href="#singularity-d-directory" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">/.singularity.d</span></code> directory in a container contains scripts and
environment files that are used when a container is executed.</p>
<p><em>You should not manually modify</em> files under <code class="docutils literal notranslate"><span class="pre">/.singularity.d</span></code>, from
your definition file during builds, or directly within your container
image. Apptainer replaces older action scripts
dynamically, at runtime, to support new features. In the longer term,
metadata will be moved outside of the container, and stored only in the
SIF file metadata descriptor.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/.singularity.d/

├── actions
│   ├── exec
│   ├── run
│   ├── shell
│   ├── start
│   └── test
├── env
│   ├── 01-base.sh
|   ├── 10-docker2singularity.sh
│   ├── 90-environment.sh
│   ├── 91-environment.sh
|   ├── 94-appsbase.sh
│   ├── 95-apps.sh
│   └── 99-base.sh
├── labels.json
├── libs
├── runscript
├── runscript.help
├── Apptainer
└── startscript
</pre></div>
</div>
<ul class="simple">
<li><p><strong>actions</strong>: This directory contains helper scripts to allow the
container to carry out the action commands. (e.g. <code class="docutils literal notranslate"><span class="pre">exec</span></code> , <code class="docutils literal notranslate"><span class="pre">run</span></code>
or <code class="docutils literal notranslate"><span class="pre">shell</span></code>). In later versions of Apptainer, these files may be
dynamically written at runtime, <em>and should not be modified</em> in the
container.</p></li>
<li><p><strong>env</strong>: All <code class="docutils literal notranslate"><span class="pre">*.sh</span></code> files in this directory are sourced in alphanumeric
order when the container is started. For legacy purposes there is a symbolic
link called <code class="docutils literal notranslate"><span class="pre">/environment</span></code> that points to
<code class="docutils literal notranslate"><span class="pre">/.singularity.d/env/90-environment.sh</span></code>. Whenever possible, avoid modifying
or creating environment files manually to prevent potential issues building &amp;
running containers with future versions of Apptainer. Additional
facilities such as <code class="docutils literal notranslate"><span class="pre">--env</span></code> and <code class="docutils literal notranslate"><span class="pre">--env-file</span></code> are available to allow
manipulation of the container environment at runtime.</p></li>
<li><p><strong>labels.json</strong>: The json file that stores a containers labels
described above.</p></li>
<li><p><strong>libs</strong>: At runtime the user may request some host-system libraries
to be mapped into the container (with the <code class="docutils literal notranslate"><span class="pre">--nv</span></code> option for
example). If so, this is their destination.</p></li>
<li><p><strong>runscript</strong>: The commands in this file will be executed when the
container is invoked with the <code class="docutils literal notranslate"><span class="pre">run</span></code> command or called as an
executable. For legacy purposes there is a symbolic link called
<code class="docutils literal notranslate"><span class="pre">/singularity</span></code> that points to this file.</p></li>
<li><p><strong>runscript.help</strong>: Contains the description that was added in the
<code class="docutils literal notranslate"><span class="pre">%help</span></code> section.</p></li>
<li><p><strong>Apptainer</strong>: This is the definition file that was used to
generate the container. If more than 1 definition file was used to
generate the container additional Apptainer files will appear in
numeric order in a sub-directory called <code class="docutils literal notranslate"><span class="pre">bootstrap_history</span></code>.</p></li>
<li><p><strong>startscript</strong>: The commands in this file will be executed when the
container is invoked with the <code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">start</span></code> command.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="running_services.html" class="btn btn-neutral float-left" title="Running Services" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="plugins.html" class="btn btn-neutral float-right" title="Plugins" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <br>
    &copy; Contributors to the Apptainer project, established as Apptainer a Series of LF Projects LLC
    <br>
    &copy; 2017-2022, Sylabs Inc


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>