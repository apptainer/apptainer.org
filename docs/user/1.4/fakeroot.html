

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fakeroot feature &mdash; Apptainer User Guide 1.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=0ed52906"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/js/ga.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Signing and Verifying Containers" href="signNverify.html" />
    <link rel="prev" title="Build Environment" href="build_env.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Apptainer User Guide
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Apptainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security in Apptainer</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="definition_files.html">The Definition File</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_env.html">Build Environment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fakeroot feature</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#restrictions-security">Restrictions/security</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#filesystem">Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#network">Network</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build">Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-from-a-definition-file">Build from a definition file:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-package-to-a-writable-overlay">Add package to a writable overlay</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ping-from-container">Ping from container:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#http-server">HTTP server:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-fakeroot-command-inside-definition-file">Using fakeroot command inside definition file:</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="signNverify.html">Sign and Verify</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_commands.html">Key management commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="encryption.html">Encrypted Containers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="endpoint.html">Remote Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="keyserver.html">Keyserver Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="registry.html">OCI Registries</a></li>
<li class="toctree-l1"><a class="reference internal" href="library_api.html">Library API Registries</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_services.html">Instances - Running Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment_and_metadata.html">Environment and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_options.html">Security Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Network Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgroups.html">Limiting Container Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="checkpoint.html">Application Checkpointing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="singularity_compatibility.html">Singularity Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker_and_oci.html">Support for Docker / OCI Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci_runtime.html">OCI Runtime Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi.html">Apptainer and MPI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.html">GPU Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licenses</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Apptainer User Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Fakeroot feature</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apptainer/apptainer-userdocs/blob/1.4/fakeroot.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="fakeroot-feature">
<span id="fakeroot"></span><h1>Fakeroot feature<a class="headerlink" href="#fakeroot-feature" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>The fakeroot feature allows an unprivileged user to run a container with
the appearance of running as root.
Apptainer does this in different ways, depending on what is available on
the host:</p>
<ol class="arabic simple">
<li><p>If the host is set up to map the current user via <code class="docutils literal notranslate"><span class="pre">/etc/subuid</span></code> and
<code class="docutils literal notranslate"><span class="pre">/etc/subgid</span></code> mapping files (or equivalent through libsubid),
Apptainer will use that method first.
This is also commonly referred to as “rootless mode” and is the
method used for example by Podman.
This mode requires user namespaces to be enabled.
It is the most complete emulation but it requires administrator setup
as described in the <a class="reference external" href="https://apptainer.org/docs/admin/1.4/user_namespace.html#rootless-fakeroot-feature">admin guide</a>.
It also requires some elevated privilege assistance on the host as described
there, which means that it will not be able to run nested inside another
container that disallows elevating privileges, as Apptainer does.
Those elevated privileges on the host come from either a setuid-root
install of Apptainer or via the host <code class="docutils literal notranslate"><span class="pre">newuidmap</span></code> and <code class="docutils literal notranslate"><span class="pre">newgidmap</span></code>
commands.</p></li>
<li><p>Otherwise if user namespaces are available without <code class="docutils literal notranslate"><span class="pre">/etc/subuid</span></code>
and <code class="docutils literal notranslate"><span class="pre">/etc/subguid</span></code> mapping files, Apptainer will map only
the root user id to the original unprivileged user.
This method is sometimes called a “root-mapped user namespace”.
Since this method is not as complete an emulation as rootless mode,
an INFO message showing it is happening is displayed.</p></li>
<li><p>If the “fakeroot” command is available on the host, Apptainer will
use it in addition to a root-mapped user namespace.
This command fakes root privileges on file manipulation, telling
programs that operations that would succeed as root have succeeded
even though they really haven’t.
This is useful for avoiding errors when building containers or when
adding packages to a writable container, because many package
installations attempt to do additional setup that only works as root.
When the fakeroot command is used, an INFO message is displayed.
The combination of a root-mapped user namespace with the fakeroot command
allows most package installations to work, but the fakeroot command is
bound in from the host so if the host libc library is a newer version
than the corresponding library in the container the
fakeroot command can fail with errors about missing GLIBC versions.
If that situation happens the easiest solution may be to use the
<a class="reference external" href="https://apptainer.org/docs/admin/1.4/installation.html#install-from-pre-built-packages">install-unprivileged.sh script</a>
to install Apptainer because it downloads a fakeroot command
built with as old a libc as possible.
Otherwise you can also try using the <code class="docutils literal notranslate"><span class="pre">--ignore-fakeroot-command</span></code>
which may work if the commands in the <code class="docutils literal notranslate"><span class="pre">%post</span></code> section of the build
definition file are simple enough.
As a last resort advanced option see the
<a class="reference internal" href="#fakeroot-inside-def"><span class="std std-ref">Using fakeroot command inside definition file</span></a>
example below.</p></li>
<li><p>If user namespaces are not available but Apptainer has been installed
with setuid-root and also the “fakeroot” command is available, then
the fakeroot command will be run by itself.
This allows some package installations to succeed but others will
still fail; it is not as complete an emulation because the
root-mapped user namespace causes the kernel to allow bypassing
restrictions on files that are actually owned by the original user
on the host, things that the fakeroot command cannot do by itself.
Also, this mode requires the container image to be a sandbox.</p></li>
</ol>
<p>As mentioned above, the “rootless” fakeroot mode is the most complete
emulation.  That mode has almost the same administrative rights as root
but only <strong>inside the container</strong> and the <strong>requested namespaces</strong>,
which means that this user:</p>
<blockquote>
<div><ul class="simple">
<li><p>can set different user/group ownership for files or directories
they own</p></li>
<li><p>can change user/group identity with su/sudo commands when starting
as the fake root user</p></li>
</ul>
</div></blockquote>
<p>In addition, the first three modes above may have full privileges inside
the requested network namespace (see below).</p>
</section>
<section id="restrictions-security">
<h2>Restrictions/security<a class="headerlink" href="#restrictions-security" title="Link to this heading"></a></h2>
<section id="filesystem">
<h3>Filesystem<a class="headerlink" href="#filesystem" title="Link to this heading"></a></h3>
<p>A “fake root” user can never access or modify files and directories for
which they don’t already have access or rights on the host filesystem,
so a “fake root” user won’t be able to access root-only host files
such as <code class="docutils literal notranslate"><span class="pre">/etc/shadow</span></code> or the host <code class="docutils literal notranslate"><span class="pre">/root</span></code> directory.
As a convenience, by default the original user’s home directory is bound
to <code class="docutils literal notranslate"><span class="pre">/root</span></code> inside the container.</p>
<p>Additionally, all files or directories created by the “fake root”
user are owned by <code class="docutils literal notranslate"><span class="pre">root:root</span></code> inside the container but as <code class="docutils literal notranslate"><span class="pre">user:group</span></code>
outside of the container.</p>
<p>Let’s consider the following example.  In this case “user” is authorized
to use the rootless mode fakeroot feature and can use 65536
UIDs starting at 131072 (same thing for GIDs).</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>UID inside container</p></th>
<th class="head"><p>UID outside container</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0 (root)</p></td>
<td><p>1000 (user)</p></td>
</tr>
<tr class="row-odd"><td><p>1 (daemon)</p></td>
<td><p>131072 (non-existent)</p></td>
</tr>
<tr class="row-even"><td><p>2 (bin)</p></td>
<td><p>131073 (non-existent)</p></td>
</tr>
<tr class="row-odd"><td><p>…</p></td>
<td><p>…</p></td>
</tr>
<tr class="row-even"><td><p>65536</p></td>
<td><p>196607</p></td>
</tr>
</tbody>
</table>
<p>This means that if the “fake root” user creates a file under a <code class="docutils literal notranslate"><span class="pre">bin</span></code>
user in the container, this file will be owned by <code class="docutils literal notranslate"><span class="pre">131073:131073</span></code>
outside of the container. The responsibility relies on the administrator to
ensure that there is no overlap with any user’s UID/GID on the
system.</p>
</section>
<section id="network">
<h3>Network<a class="headerlink" href="#network" title="Link to this heading"></a></h3>
<p>Normally the kernel prevents unprivileged users from connecting to
ports below 1024, and the <code class="docutils literal notranslate"><span class="pre">ping</span></code> command requires a setcap capability in
order to work on the network.
Apptainer allows overriding these restrictions when all of the following
conditions are true:</p>
<ol class="arabic simple">
<li><p>Apptainer is installed with suid mode enabled</p></li>
<li><p>Network namespaces are enabled</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">-net</span></code> option is used</p></li>
<li><p>The user is listed in <code class="docutils literal notranslate"><span class="pre">/etc/subuid</span></code> and so can use rootless mode</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">--fakeroot</span></code> option is used</p></li>
</ol>
<p>If those conditions are true, the user has full network privileges in a
dedicated container network. Inside the container network they can bind
on privileged ports below 1024, use ping, manage firewall rules, listen
to traffic, etc. Anything done in this dedicated network won’t affect
the host network.
The ports inside the dedicated network can be mapped to other ports
on the host with the <code class="docutils literal notranslate"><span class="pre">--network-args=&quot;portmap&quot;</span></code> option.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Of course an unprivileged user can not map host ports below
1024 by using for example: <code class="docutils literal notranslate"><span class="pre">--network-args=&quot;portmap=80:80/tcp&quot;</span></code></p>
</div>
</section>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h2>
<p>You can work as a fake root user inside a container by using the
<code class="docutils literal notranslate"><span class="pre">--fakeroot</span></code> or <code class="docutils literal notranslate"><span class="pre">-f</span></code> option.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--fakeroot</span></code> option is available with the following apptainer
commands:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shell</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exec</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">start</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">build</span></code></p></li>
</ul>
</div></blockquote>
<p>The option is automatically implied when doing a build as an
unprivileged user.</p>
<section id="build">
<span id="id1"></span><h3>Build<a class="headerlink" href="#build" title="Link to this heading"></a></h3>
<p>Depending on the method of “fake root” used, an unprivileged user can build
an image from a definition file with few restrictions.
Some bootstrap methods that require creation of block devices (like
<code class="docutils literal notranslate"><span class="pre">/dev/null</span></code>) may not always work correctly with “fake root”.
With the rootles mode “fake root”, Apptainer uses seccomp filters
to give programs the illusion that block device creation succeeded.
This appears to work with <code class="docutils literal notranslate"><span class="pre">yum</span></code> or <code class="docutils literal notranslate"><span class="pre">dnf</span></code> bootstraps and <em>may</em> work with other
bootstrap methods, although <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code> is known to not work.</p>
<p>If only the fakeroot command is used for “fake root” mode (because no
user namespaces are available, in suid mode), then building a container
also implies the <code class="docutils literal notranslate"><span class="pre">--fix-perms</span></code> option, because otherwise directories
created may not be writable by the creating user.</p>
</section>
<section id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Link to this heading"></a></h3>
<section id="build-from-a-definition-file">
<h4>Build from a definition file:<a class="headerlink" href="#build-from-a-definition-file" title="Link to this heading"></a></h4>
<p>(fakeroot is implied)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">build</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">sif</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="k">def</span>
</pre></div>
</div>
</section>
<section id="add-package-to-a-writable-overlay">
<h4>Add package to a writable overlay<a class="headerlink" href="#add-package-to-a-writable-overlay" title="Link to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">overlay</span>
<span class="n">apptainer</span> <span class="n">exec</span> <span class="o">--</span><span class="n">fakeroot</span> <span class="o">--</span><span class="n">overlay</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">overlay</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">sif</span> <span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">openssh</span>
</pre></div>
</div>
</section>
<section id="ping-from-container">
<h4>Ping from container:<a class="headerlink" href="#ping-from-container" title="Link to this heading"></a></h4>
<p>(when the Network conditions above are met)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">exec</span> <span class="o">--</span><span class="n">fakeroot</span> <span class="o">--</span><span class="n">net</span> <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="n">alpine</span> <span class="n">ping</span> <span class="o">-</span><span class="n">c1</span> <span class="mf">8.8.8.8</span>
</pre></div>
</div>
</section>
<section id="http-server">
<h4>HTTP server:<a class="headerlink" href="#http-server" title="Link to this heading"></a></h4>
<p>(when the Network conditions above are met)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">run</span> <span class="o">--</span><span class="n">fakeroot</span> <span class="o">--</span><span class="n">net</span> <span class="o">--</span><span class="n">network</span><span class="o">-</span><span class="n">args</span><span class="o">=</span><span class="s2">&quot;portmap=8080:80/tcp&quot;</span> <span class="o">-</span><span class="n">w</span> <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="n">nginx</span>
</pre></div>
</div>
</section>
<section id="using-fakeroot-command-inside-definition-file">
<span id="fakeroot-inside-def"></span><h4>Using fakeroot command inside definition file:<a class="headerlink" href="#using-fakeroot-command-inside-definition-file" title="Link to this heading"></a></h4>
<p>When using fakeroot mode 3 above, where user namespaces are
available but /etc/subuid mapping is not set up, and you are trying
to build a container for an operating sytem with an older glibc
library than the host or for a target operating system like alpine
that does not include glibc, this more advanced technique may help.</p>
<p>First, use the apptainer build <code class="docutils literal notranslate"><span class="pre">--ignore-fakeroot-command</span></code> option
to avoid binding in the fakeroot command from the host.
If your <code class="docutils literal notranslate"><span class="pre">%post</span></code> commands are simple enough, that alone may be enough.
If any of the commands try to do <code class="docutils literal notranslate"><span class="pre">chown</span></code> or something similar, then
try additionally installing the fakeroot command in the <code class="docutils literal notranslate"><span class="pre">%post</span></code>
section and running the other commands under that.
In order to work correctly with user namespaces there also needs to be
an environment variable setting of <code class="docutils literal notranslate"><span class="pre">FAKEROOTDONTTRYCHOWN=1</span></code>.</p>
<p>For example, with a definition file called <code class="docutils literal notranslate"><span class="pre">my.def</span></code>
containing this for a RHEL-derived container:</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: rockylinux:<span class="m">8</span>

<span class="gh">%post</span>
<span class="w">    </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>epel-release
<span class="w">    </span>dnf<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>fakeroot
<span class="w">    </span><span class="nv">FAKEROOTDONTTRYCHOWN</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>fakeroot<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">        dnf install -y openssh</span>
<span class="s1">    &#39;</span>
</pre></div>
</div>
<p>or this for an alpine container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Bootstrap</span><span class="p">:</span> <span class="n">docker</span>
<span class="n">From</span><span class="p">:</span> <span class="n">alpine</span><span class="p">:</span><span class="n">latest</span>

<span class="o">%</span><span class="n">post</span>
    <span class="n">apk</span> <span class="n">update</span>
    <span class="n">apk</span> <span class="n">add</span> <span class="n">fakeroot</span>
    <span class="n">FAKEROOTDONTTRYCHOWN</span><span class="o">=</span><span class="mi">1</span> <span class="n">fakeroot</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;</span>
        <span class="n">apk</span> <span class="n">add</span> <span class="n">squid</span>
    <span class="s1">&#39;</span>
</pre></div>
</div>
<p>then build with</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span>apptainer build --ignore-fakeroot-command my.sif my.def
</pre></div>
</div>
<p>A Debian-derived container is more challenging because even the
installation of the fakeroot package itself requires more than is
available in fakeroot mode 2 (root-mapped user namespace).  So to
demonstrate this you need to first build an image with another method
that installs fakeroot (perhaps on another host where you have root
access), and then make that image available where you need it and build
on top of that.</p>
<p>For example for the first phase:</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: ubuntu:<span class="m">20.04</span>

<span class="gh">%post</span>
<span class="w">    </span>apt<span class="w"> </span>update
<span class="w">    </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>fakeroot
</pre></div>
</div>
<p>and build with</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span>sudo apptainer build ubuntu+fakeroot.sif my.def
</pre></div>
</div>
<p>Then this for the second phase in a file called my2.def:</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: localimage
<span class="k">From</span>: ubuntu+fakeroot.sif

<span class="gh">%post</span>
<span class="w">    </span><span class="nv">FAKEROOTDONTTRYCHOWN</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>fakeroot<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">        apt update</span>
<span class="s1">        apt install -y openssh</span>
<span class="s1">    &#39;</span>
</pre></div>
</div>
<p>and build with</p>
<div class="highlight-apptainer notranslate"><div class="highlight"><pre><span></span>apptainer build --ignore-fakeroot-command my.sif my2.def
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="build_env.html" class="btn btn-neutral float-left" title="Build Environment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="signNverify.html" class="btn btn-neutral float-right" title="Signing and Verifying Containers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <br>
    &copy; Contributors to the Apptainer project, established as Apptainer a Series of LF Projects LLC
    <br>
    &copy; 2017-2022, Sylabs Inc


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>