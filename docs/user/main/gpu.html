

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPU Support (NVIDIA CUDA &amp; AMD ROCm) &mdash; Apptainer User Guide main documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=a8da1a53"></script>
      <script src="_static/doctools.js?v=fd6eb6e6"></script>
      <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="_static/js/ga.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Contributing" href="contributing.html" />
    <link rel="prev" title="Apptainer and MPI applications" href="mpi.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Apptainer User Guide
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Apptainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security in Apptainer</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="definition_files.html">The Definition File</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_env.html">Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="fakeroot.html">Fakeroot feature</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="signNverify.html">Sign and Verify</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_commands.html">Key management commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="encryption.html">Encrypted Containers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="endpoint.html">Remote Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="keyserver.html">Keyserver Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="registry.html">OCI Registries</a></li>
<li class="toctree-l1"><a class="reference internal" href="library_api.html">Library API Registries</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_services.html">Instances - Running Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment_and_metadata.html">Environment and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_options.html">Security Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Network Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgroups.html">Limiting Container Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="checkpoint.html">Application Checkpointing</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="singularity_compatibility.html">Singularity Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker_and_oci.html">Support for Docker / OCI Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci_runtime.html">OCI Runtime Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi.html">Apptainer and MPI applications</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">GPU Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#nvidia-gpus-cuda-standard">NVIDIA GPUs &amp; CUDA (Standard)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-tensorflow-gpu">Example - tensorflow-gpu</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiple-gpus">Multiple GPUs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cuda-error-unknown-when-everything-seems-to-be-correctly-configured">CUDA_ERROR_UNKNOWN when everything seems to be correctly configured</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#nvidia-gpus-cuda-nvidia-container-cli">NVIDIA GPUs &amp; CUDA (nvidia-container-cli)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements-limitations">Requirements &amp; Limitations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Example - tensorflow-gpu</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpu-selection">GPU Selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-gpu-options">Other GPU Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#amd-gpus-rocm">AMD GPUs &amp; ROCm</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-tensorflow-rocm">Example - tensorflow-rocm</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#opencl-applications">OpenCL Applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-blender-opencl">Example - Blender OpenCL</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">Licenses</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Apptainer User Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">GPU Support (NVIDIA CUDA &amp; AMD ROCm)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apptainer/apptainer-userdocs/blob/main/gpu.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="gpu-support-nvidia-cuda-amd-rocm">
<span id="gpu"></span><h1>GPU Support (NVIDIA CUDA &amp; AMD ROCm)<a class="headerlink" href="#gpu-support-nvidia-cuda-amd-rocm" title="Link to this heading"></a></h1>
<p>Apptainer natively supports running application containers that use
NVIDIA’s CUDA GPU compute framework, or AMD’s ROCm solution. This allows
easy access to users of GPU-enabled machine learning frameworks such as
TensorFlow, regardless of the host operating system. As long as the host
has a driver and library installation for CUDA/ROCm, then it’s possible
to e.g. run TensorFlow in an up-to-date Ubuntu 24.04 container, from an
older RHEL 8 host. However, note that since the libraries are bound in
from the host, the libc version present in the container and on the host
must not be too far apart or there will be libc mismatch errors.  Errors
happen when the libc in the container is older than on the host and have
sometimes also been seen when the libc in the container is much newer
than on the host.</p>
<p>Applications that support OpenCL for compute acceleration can also be
used easily, with an additional bind option.</p>
<p>Apptainer experimental support is provided to use
Nvidia’s <code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> tooling for GPU container setup. This
functionality, accessible via the new <code class="docutils literal notranslate"><span class="pre">--nvccli</span></code> flag, improves
compatibility with OCI runtimes and exposes additional container
configuration options.</p>
<section id="nvidia-gpus-cuda-standard">
<h2>NVIDIA GPUs &amp; CUDA (Standard)<a class="headerlink" href="#nvidia-gpus-cuda-standard" title="Link to this heading"></a></h2>
<p>Commands that <code class="docutils literal notranslate"><span class="pre">run</span></code>, or otherwise execute containers (<code class="docutils literal notranslate"><span class="pre">shell</span></code>,
<code class="docutils literal notranslate"><span class="pre">exec</span></code>) can take an <code class="docutils literal notranslate"><span class="pre">--nv</span></code> option, which will setup the container’s
environment to use an NVIDIA GPU and the basic CUDA libraries to run a
CUDA enabled application. The <code class="docutils literal notranslate"><span class="pre">--nv</span></code> flag will:</p>
<ul class="simple">
<li><p>Ensure that the <code class="docutils literal notranslate"><span class="pre">/dev/nvidiaX</span></code> device entries are available inside
the container, so that the GPU cards in the host are accessible.</p></li>
<li><p>Locate and bind the basic CUDA libraries from the host into the
container, so that they are available to the container, and match the
kernel GPU driver on the host.</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> inside the container so that the bound-in
version of the CUDA libraries are used by applications run inside the
container.</p></li>
</ul>
<section id="requirements">
<h3>Requirements<a class="headerlink" href="#requirements" title="Link to this heading"></a></h3>
<p>To use the <code class="docutils literal notranslate"><span class="pre">--nv</span></code> flag to run a CUDA application inside a container
you must ensure that:</p>
<ul class="simple">
<li><p>The host has a working installation of the NVIDIA GPU driver, and a
matching version of the basic NVIDIA/CUDA libraries. The host <em>does
not</em> need to have an X server running, unless you want to run
graphical apps from the container.</p></li>
<li><p>The NVIDIA libraries are in the system’s library search path.</p></li>
<li><p>The application inside your container was compiled for a CUDA
version, and device capability level, that is supported by the host
card and driver.</p></li>
</ul>
<p>These requirements are usually satisfied by installing the NVIDIA
drivers and CUDA packages directly from the NVIDIA website. Linux
distributions may provide NVIDIA drivers and CUDA libraries, but they
are often outdated which can lead to problems running applications
compiled for the latest versions of CUDA.</p>
<p>Apptainer will find the NVIDIA/CUDA libraries on your host using the
list of libraries in the configuration file
<code class="docutils literal notranslate"><span class="pre">etc/apptainer/nvbliblist</span></code>, and resolving paths through the
<code class="docutils literal notranslate"><span class="pre">ldconfig</span></code> cache. At time of release this list is appropriate for the
latest stable CUDA version. It can be modified by the administrator to
add additional libraries if necessary. See the admin guide for more
details.</p>
</section>
<section id="example-tensorflow-gpu">
<h3>Example - tensorflow-gpu<a class="headerlink" href="#example-tensorflow-gpu" title="Link to this heading"></a></h3>
<p>Tensorflow is commonly used for machine learning projects but can be
difficult to install on older systems, and is updated frequently.
Running tensorflow from a container removes installation problems and
makes trying out new versions easy.</p>
<p>The official tensorflow repository on Docker Hub contains NVIDA GPU
supporting containers, that will use CUDA for processing. You can view
the available versions on the <a class="reference external" href="https://hub.docker.com/r/tensorflow/tensorflow/tags">tags page on Docker Hub</a></p>
<p>The container is large, so it’s best to build or pull the docker image
to a SIF before you start working with it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer<span class="w"> </span>pull<span class="w"> </span>docker://tensorflow/tensorflow:latest-gpu
<span class="go">...</span>
<span class="go">INFO:    Creating SIF file...</span>
<span class="go">[=====================================================================]</span>
<span class="go">100 % 0s</span>
<span class="go">INFO:    Build complete: tensorflow_latest-gpu.sif</span>
</pre></div>
</div>
<p>Then run the container with GPU support:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer<span class="w"> </span>run<span class="w"> </span>--nv<span class="w"> </span>tensorflow_latest-gpu.sif

<span class="go">________                               _______________</span>
<span class="go">___  __/__________________________________  ____/__  /________      __</span>
<span class="go">__  /  _  _ \_  __ \_  ___/  __ \_  ___/_  /_   __  /_  __ \_ | /| / /</span>
<span class="go">_  /   /  __/  / / /(__  )/ /_/ /  /   _  __/   _  / / /_/ /_ |/ |/ /</span>
<span class="go">/_/    \___//_/ /_//____/ \____//_/    /_/      /_/  \____/____/|__/</span>


<span class="go">You are running this container as user with ID 1000 and group 1000,</span>
<span class="go">which should map to the ID and group for your user on the Docker host. Great!</span>

<span class="go">Apptainer&gt;</span>
</pre></div>
</div>
<p>You can verify the GPU is available within the container by using the
tensorflow <code class="docutils literal notranslate"><span class="pre">list_local_devices()</span></code> function:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Apptainer&gt; python</span>
<span class="go">Python 2.7.15+ (default, Jul  9 2019, 16:51:35)</span>
<span class="go">[GCC 7.4.0] on linux2</span>
<span class="go">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span>
<span class="go">&gt;&gt;&gt; from tensorflow.python.client import device_lib</span>
<span class="go">&gt;&gt;&gt; print(device_lib.list_local_devices())</span>
<span class="go">2019-11-14 15:32:09.743600: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA</span>
<span class="go">2019-11-14 15:32:09.784482: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 3292620000 Hz</span>
<span class="go">2019-11-14 15:32:09.787911: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x565246634360 executing computations on platform Host. Devices:</span>
<span class="go">2019-11-14 15:32:09.787939: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version</span>
<span class="go">2019-11-14 15:32:09.798428: I tensorflow/stream_executor/platform/default/dso_loader.cc:44] Successfully opened dynamic library libcuda.so.1</span>
<span class="go">2019-11-14 15:32:09.842683: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:1006] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero</span>
<span class="go">2019-11-14 15:32:09.843252: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x5652469263d0 executing computations on platform CUDA. Devices:</span>
<span class="go">2019-11-14 15:32:09.843265: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): GeForce GT 730, Compute Capability 3.5</span>
<span class="go">2019-11-14 15:32:09.843380: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:1006] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero</span>
<span class="go">2019-11-14 15:32:09.843984: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1618] Found device 0 with properties:</span>
<span class="go">name: GeForce GT 730 major: 3 minor: 5 memoryClockRate(GHz): 0.9015</span>
<span class="go">...</span>
</pre></div>
</div>
</section>
<section id="multiple-gpus">
<h3>Multiple GPUs<a class="headerlink" href="#multiple-gpus" title="Link to this heading"></a></h3>
<p>By default, Apptainer makes all host devices available in the
container. When the <code class="docutils literal notranslate"><span class="pre">--contain</span></code> option is used a minimal <code class="docutils literal notranslate"><span class="pre">/dev</span></code> tree
is created in the container, but the <code class="docutils literal notranslate"><span class="pre">--nv</span></code> option will ensure that
all nvidia devices on the host are present in the container.</p>
<p>This behaviour is different to <code class="docutils literal notranslate"><span class="pre">nvidia-docker</span></code> where an
<code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES</span></code> environment variable is used to control
whether some or all host GPUs are visible inside a container. The
<code class="docutils literal notranslate"><span class="pre">nvidia-container-runtime</span></code> explicitly binds the devices into the
container dependent on the value of <code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES</span></code>.</p>
<p>To control which GPUs are used in an Apptainer container that is run
with <code class="docutils literal notranslate"><span class="pre">--nv</span></code> you can set <code class="docutils literal notranslate"><span class="pre">APPTAINERENV_CUDA_VISIBLE_DEVICES</span></code> before
running the container, or <code class="docutils literal notranslate"><span class="pre">CUDA_VISIBLE_DEVICES</span></code> inside the container.
This variable will limit the GPU devices that CUDA programs see.</p>
<p>E.g. to run the tensorflow container, but using only the first GPU in
the host, we could do:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nv">APPTAINERENV_CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>apptainer<span class="w"> </span>run<span class="w"> </span>--nv<span class="w"> </span>tensorflow_latest-gpu.sif

<span class="gp"># </span>or

<span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">APPTAINERENV_CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>
<span class="gp">$ </span>apptainer<span class="w"> </span>run<span class="w"> </span>tensorflow_latest-gpu.sif
</pre></div>
</div>
</section>
<section id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading"></a></h3>
<p>If the host installation of the NVIDIA / CUDA driver and libraries is
working and up-to-date there are rarely issues running CUDA programs
inside of Apptainer containers. The most common issue seen is:</p>
<section id="cuda-error-unknown-when-everything-seems-to-be-correctly-configured">
<h4>CUDA_ERROR_UNKNOWN when everything seems to be correctly configured<a class="headerlink" href="#cuda-error-unknown-when-everything-seems-to-be-correctly-configured" title="Link to this heading"></a></h4>
<p>CUDA depends on multiple kernel modules being loaded. Not all of the
modules are loaded at system startup. Some portions of the NVIDA driver
stack are initialized when first needed. This is done using a setuid
root binary, so initializing can be triggered by any user on the host.
In Apptainer containers, privilege escalation is blocked, so the
setuid root binary cannot initialize the driver stack fully.</p>
<p>If you experience <code class="docutils literal notranslate"><span class="pre">CUDA_ERROR_UNKNOWN</span></code> in a container, initialize the
driver stack on the host first, by running a CUDA program there or
<code class="docutils literal notranslate"><span class="pre">modprobe</span> <span class="pre">nvidia_uvm</span></code> as root, and using <code class="docutils literal notranslate"><span class="pre">nvidia-persistenced</span></code> to
avoid driver unload.</p>
</section>
</section>
</section>
<section id="nvidia-gpus-cuda-nvidia-container-cli">
<h2>NVIDIA GPUs &amp; CUDA (nvidia-container-cli)<a class="headerlink" href="#nvidia-gpus-cuda-nvidia-container-cli" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">--nvccli</span></code> option instructs
Apptainer to perform GPU container setup using the
<code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> utility. This utility must be installed
separately from Apptainer. It is available in the repositories of
some distributions, and at:
<a class="reference external" href="https://nvidia.github.io/libnvidia-container/">https://nvidia.github.io/libnvidia-container/</a></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This feature is considered experimental in Apptainer as of now. It
cannot not replace the legacy NVIDIA support in all situations, and
should be tested carefully before use in production workflows.</p>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> to configure a container for GPU
operation has a number of advantages, including:</p>
<ul class="simple">
<li><p>The tool is maintained by NVIDIA, and will track new features /
libraries in new CUDA releases closely.</p></li>
<li><p>Support for passing only specific GPUs / MIG devices into the
container.</p></li>
<li><p>Support for providing different classes of GPU capability to the
container, e.g. compute, graphics, and display functionality.</p></li>
<li><p>Configuration via the same environment variables that are in use with
OCI containers.</p></li>
</ul>
<section id="requirements-limitations">
<h3>Requirements &amp; Limitations<a class="headerlink" href="#requirements-limitations" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> must be installed on your host.
It must be able to be found by the <code class="docutils literal notranslate"><span class="pre">binary</span> <span class="pre">path</span></code> set in
<code class="docutils literal notranslate"><span class="pre">apptainer.conf</span></code> which by default includes the user’s PATH.</p></li>
<li><p>For security reasons, <code class="docutils literal notranslate"><span class="pre">--nvccli</span></code> cannot be used with
privileged mode in a setuid install of Apptainer.
<code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> also requires writing to the image, so
either the <code class="docutils literal notranslate"><span class="pre">--writable</span></code> (<code class="docutils literal notranslate"><span class="pre">-w</span></code>) or <code class="docutils literal notranslate"><span class="pre">--writable-tmpfs</span></code> option
is also required; if neither is given, <code class="docutils literal notranslate"><span class="pre">--writable-tmpfs</span></code> is
implied.
That also means that the permissions on system directories such as
<code class="docutils literal notranslate"><span class="pre">/usr/bin</span></code> have to be writable, so either use a sandbox image that
has that directory writable by the user (for example built with
the <code class="docutils literal notranslate"><span class="pre">--fix-perms</span></code> option) or use <code class="docutils literal notranslate"><span class="pre">--fakeroot</span></code>.</p></li>
<li><p>There are known problems with library discovery for the current
<code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> in recent Debian distributions. See <a class="reference external" href="https://github.com/NVIDIA/nvidia-docker/issues/1399">this
GitHub issue</a></p></li>
</ul>
</section>
<section id="id1">
<h3>Example - tensorflow-gpu<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<p>Tensorflow can be run using <code class="docutils literal notranslate"><span class="pre">--nvccli</span></code> in a similar manner as the
standard <code class="docutils literal notranslate"><span class="pre">--nv</span></code> binding approach when run unprivleged. Build the
large container into a sandbox:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer<span class="w"> </span>build<span class="w"> </span>--sandbox<span class="w"> </span>tensorflow_latest-gpu<span class="w"> </span>docker://tensorflow/tensorflow:latest-gpu
<span class="go">INFO:    Starting build...</span>
<span class="go">...</span>
<span class="go">INFO:    Creating sandbox directory...</span>
<span class="go">INFO:    Build complete: tensorflow_latest-gpu</span>
</pre></div>
</div>
<p>Then run the container with <code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> GPU support:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer<span class="w"> </span>run<span class="w"> </span>--nvccli<span class="w"> </span>tensorflow_latest-gpu

<span class="go">________                               _______________</span>
<span class="go">___  __/__________________________________  ____/__  /________      __</span>
<span class="go">__  /  _  _ \_  __ \_  ___/  __ \_  ___/_  /_   __  /_  __ \_ | /| / /</span>
<span class="go">_  /   /  __/  / / /(__  )/ /_/ /  /   _  __/   _  / / /_/ /_ |/ |/ /</span>
<span class="go">/_/    \___//_/ /_//____/ \____//_/    /_/      /_/  \____/____/|__/</span>


<span class="go">You are running this container as user with ID 1000 and group 1000,</span>
<span class="go">which should map to the ID and group for your user on the Docker host. Great!</span>

<span class="go">Apptainer&gt;</span>
</pre></div>
</div>
<p>You can verify the GPU is available within the container by using the
tensorflow <code class="docutils literal notranslate"><span class="pre">list_local_devices()</span></code> function:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Apptainer&gt; python</span>
<span class="go">Python 2.7.15+ (default, Jul  9 2019, 16:51:35)</span>
<span class="go">[GCC 7.4.0] on linux2</span>
<span class="go">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span>
<span class="go">&gt;&gt;&gt; from tensorflow.python.client import device_lib</span>
<span class="go">&gt;&gt;&gt; print(device_lib.list_local_devices())</span>
<span class="go">...</span>
<span class="go">device_type: &quot;GPU&quot;</span>
<span class="go">memory_limit: 14474280960</span>
<span class="go">locality {</span>
<span class="go">  bus_id: 1</span>
<span class="go">  links {</span>
<span class="go">  }</span>
<span class="go">}</span>
<span class="go">incarnation: 13349913758992036690</span>
<span class="go">physical_device_desc: &quot;device: 0, name: Tesla T4, pci bus id: 0000:00:1e.0, compute capability: 7.5&quot;</span>
<span class="go">...</span>
</pre></div>
</div>
</section>
<section id="gpu-selection">
<h3>GPU Selection<a class="headerlink" href="#gpu-selection" title="Link to this heading"></a></h3>
<p>When running with <code class="docutils literal notranslate"><span class="pre">--nvccli</span></code>, by default Apptainer will expose all
GPUs on the host inside the container. This mirrors the functionality of
the standard GPU support for the most common use-case.</p>
<p>Setting the <code class="docutils literal notranslate"><span class="pre">APPTAINER_CUDA_VISIBLE_DEVICES</span></code> environment variable
before running a container is still supported, to control which GPUs are
used by CUDA programs that honor <code class="docutils literal notranslate"><span class="pre">CUDA_VISIBLE_DEVICES</span></code>. However, more
powerful GPU isolation is possible using the <code class="docutils literal notranslate"><span class="pre">--contain</span></code> (or <code class="docutils literal notranslate"><span class="pre">-c</span></code>) flag and
<code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES</span></code> environment variable. This controls which GPU
devices are bound into the <code class="docutils literal notranslate"><span class="pre">/dev</span></code> tree in the container.</p>
<p>For example, to pass only the 2nd and 3rd GPU into a container running
on a system with 4 GPUs, run the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">NVIDIA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">1</span>,2
<span class="gp">$ </span>apptainer<span class="w"> </span>run<span class="w"> </span>-uwc<span class="w"> </span>--nvccli<span class="w"> </span>tensorflow_latest-gpu
</pre></div>
</div>
<p>Note that:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES</span></code> is not prepended with <code class="docutils literal notranslate"><span class="pre">APPTAINER_</span></code> as
this variable controls container setup, and is not passed into the
container.</p></li>
<li><p>The GPU device identifiers start at 0, so 1,2 refers to the 2nd and
3rd GPU.</p></li>
<li><p>You can use GPU UUIDs in place of numeric identifiers. Use
<code class="docutils literal notranslate"><span class="pre">nvidia-smi</span> <span class="pre">-L</span></code> to list both numeric IDs and UUIDs available on the
system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all</span></code> can be used to pass all available GPUs into the container.</p></li>
</ul>
<p>If you use <code class="docutils literal notranslate"><span class="pre">--contain</span></code> without setting <code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES</span></code>, no
GPUs will be available in the container, and a warning will be shown:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer<span class="w"> </span>run<span class="w"> </span>-uwc<span class="w"> </span>--nvccli<span class="w"> </span>tensorflow_latest-gpu
<span class="go">WARNING: When using nvidia-container-cli with --contain NVIDIA_VISIBLE_DEVICES</span>
<span class="go">must be set or no GPUs will be available in container.</span>
</pre></div>
</div>
<p>To restore the behaviour of the standard GPU handling, set
<code class="docutils literal notranslate"><span class="pre">NVIDIA_VISIBLE_DEVICES=0</span></code> when running with <code class="docutils literal notranslate"><span class="pre">--contain</span></code>.</p>
<p>If your system contains Ampere or newer GPUs that support virtual MIG
devices, you can specify MIG identifiers / UUIDs.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">NVIDIA_VISIBLE_DEVICES</span><span class="o">=</span>MIG-GPU-5c89852c-d268-c3f3-1b07-005d5ae1dc3f/7/0
</pre></div>
</div>
<p>Apptainer does not configure MIG partitions. It is expected that
these would be statically configured by the system administrator, or
setup dynamically by a job scheduler / workflow system according to the
requirements of the job.</p>
</section>
<section id="other-gpu-options">
<h3>Other GPU Options<a class="headerlink" href="#other-gpu-options" title="Link to this heading"></a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">--nvccli</span></code> mode, Apptainer understands the following additional
environment variables. Note that these environment variables are read
from the environment where <code class="docutils literal notranslate"><span class="pre">apptainer</span></code> is run. Apptainer does
not currently read these settings from the container environment.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA_DRIVER_CAPABILITIES</span></code> controls which libraries and utilities
are mounted in the container, to support different requirements. The
default value under Apptainer is <code class="docutils literal notranslate"><span class="pre">compute,utility</span></code>, which will
provide CUDA functionality and basic utilities such as
<code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code>. Other options include <code class="docutils literal notranslate"><span class="pre">graphics</span></code> for OpenGL/Vulkan
support, <code class="docutils literal notranslate"><span class="pre">video</span></code> for the codecs SDK, and <code class="docutils literal notranslate"><span class="pre">display</span></code> to use X11
from a container.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA_REQUIRE_*</span></code> variables allow specifying requirements, which
will be checked by <code class="docutils literal notranslate"><span class="pre">nvidia-container-cli</span></code> prior to starting the
container. Constraints can be set on <code class="docutils literal notranslate"><span class="pre">cuda</span></code>, <code class="docutils literal notranslate"><span class="pre">driver</span></code>, <code class="docutils literal notranslate"><span class="pre">arch</span></code>,
and <code class="docutils literal notranslate"><span class="pre">brand</span></code> values. Docker/OCI images may set these variables
inside the container, to indicate runtime requirements. However,
these container variables are not yet interpreted by Apptainer.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NVIDIA_DISABLE_REQUIRE</span></code> will disable the enforcement of any
<code class="docutils literal notranslate"><span class="pre">NVIDIA_REQUIRE_*</span></code> requirements that are set.</p></li>
</ul>
<p>Full details of the supported values for these environment variables can
be found in the container-toolkit guide:</p>
<p><a class="reference external" href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/user-guide.html#environment-variables-oci-spec">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/user-guide.html#environment-variables-oci-spec</a></p>
</section>
</section>
<section id="amd-gpus-rocm">
<h2>AMD GPUs &amp; ROCm<a class="headerlink" href="#amd-gpus-rocm" title="Link to this heading"></a></h2>
<p>Apptainer has a <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> flag to support GPU compute with the
ROCm framework using AMD Radeon GPU cards.</p>
<p>Commands that <code class="docutils literal notranslate"><span class="pre">run</span></code>, or otherwise execute containers (<code class="docutils literal notranslate"><span class="pre">shell</span></code>,
<code class="docutils literal notranslate"><span class="pre">exec</span></code>) can take an <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> option, which will setup the
container’s environment to use a Radeon GPU and the basic ROCm libraries
to run a ROCm enabled application. The <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> flag will:</p>
<ul class="simple">
<li><p>Ensure that the <code class="docutils literal notranslate"><span class="pre">/dev/dri/</span></code> device entries are available inside the
container, so that the GPU cards in the host are accessible.</p></li>
<li><p>Locate and bind the basic ROCm libraries from the host into the
container, so that they are available to the container, and match the
kernel GPU driver on the host.</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> inside the container so that the bound-in
version of the ROCm libraries are used by application run inside the
container.</p></li>
</ul>
<section id="id2">
<h3>Requirements<a class="headerlink" href="#id2" title="Link to this heading"></a></h3>
<p>To use the <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> flag to run a CUDA application inside a container
you must ensure that:</p>
<ul class="simple">
<li><p>The host has a working installation of the <code class="docutils literal notranslate"><span class="pre">amdgpu</span></code> driver, and a
compatible version of the basic ROCm libraries. The host <em>does not</em>
need to have an X server running, unless you want to run graphical
apps from the container.</p></li>
<li><p>The ROCm libraries are in the system’s library search path.</p></li>
<li><p>The application inside your container was compiled for a ROCm version
that is compatible with the ROCm version on your host.</p></li>
</ul>
<p>These requirements can be satisfied by following the requirements on the
<a class="reference external" href="https://rocm.github.io/ROCmInstall.html">ROCm web site</a></p>
</section>
<section id="example-tensorflow-rocm">
<h3>Example - tensorflow-rocm<a class="headerlink" href="#example-tensorflow-rocm" title="Link to this heading"></a></h3>
<p>Tensorflow is commonly used for machine learning projects, but can be
difficult to install on older systems, and is updated frequently.
Running tensorflow from a container removes installation problems and
makes trying out new versions easy.</p>
<p>The rocm tensorflow repository on Docker Hub contains Radeon GPU
supporting containers, that will use ROCm for processing. You can view
the available versions on the <a class="reference external" href="https://hub.docker.com/r/rocm/tensorflow/tags">tags page on Docker Hub</a></p>
<p>The container is large, so it’s best to build or pull the docker image
to a SIF before you start working with it:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer<span class="w"> </span>pull<span class="w"> </span>docker://rocm/tensorflow:latest
<span class="go">...</span>
<span class="go">INFO:    Creating SIF file...</span>
<span class="go">[=====================================================================]</span>
<span class="go">100 % 0s</span>
<span class="go">INFO:    Build complete: tensorflow_latest.sif</span>
</pre></div>
</div>
<p>Then run the container with GPU support:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer<span class="w"> </span>run<span class="w"> </span>--rocm<span class="w"> </span>tensorflow_latest.sif
</pre></div>
</div>
<p>You can verify the GPU is available within the container by using the
tensorflow <code class="docutils literal notranslate"><span class="pre">list_local_devices()</span></code> function:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Apptainer&gt; ipython</span>
<span class="go">Python 3.5.2 (default, Jul 10 2019, 11:58:48)</span>
<span class="go">Type &#39;copyright&#39;, &#39;credits&#39; or &#39;license&#39; for more information</span>
<span class="go">IPython 7.8.0 -- An enhanced Interactive Python. Type &#39;?&#39; for help.</span>
<span class="go">&gt;&gt;&gt; from tensorflow.python.client import device_lib</span>
<span class="go">...</span>
<span class="go">&gt;&gt;&gt; print(device_lib.list_local_devices())</span>
<span class="go">...</span>
<span class="go">2019-11-14 16:33:42.750509: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1651] Found device 0 with properties:</span>
<span class="go">name: Lexa PRO [Radeon RX 550/550X]</span>
<span class="go">AMDGPU ISA: gfx803</span>
<span class="go">memoryClockRate (GHz) 1.183</span>
<span class="go">pciBusID 0000:09:00.0</span>
<span class="go">...</span>
</pre></div>
</div>
</section>
</section>
<section id="opencl-applications">
<h2>OpenCL Applications<a class="headerlink" href="#opencl-applications" title="Link to this heading"></a></h2>
<p>Both the <code class="docutils literal notranslate"><span class="pre">--rocm</span></code> and <code class="docutils literal notranslate"><span class="pre">--nv</span></code> flags will bind the vendor OpenCL
implementation libraries into a container that is being run. However,
these libraries will not be used by OpenCL applications unless a vendor
icd file is available under <code class="docutils literal notranslate"><span class="pre">/etc/OpenCL/vendors</span></code> that directs OpenCL
to use the vendor library.</p>
<p>The simplest way to use OpenCL in a container is to <code class="docutils literal notranslate"><span class="pre">--bind</span>
<span class="pre">/etc/OpenCL</span></code> so that the icd files from the host (which match the
bound-in libraries) are present in the container.</p>
<section id="example-blender-opencl">
<h3>Example - Blender OpenCL<a class="headerlink" href="#example-blender-opencl" title="Link to this heading"></a></h3>
<p>The <a class="reference external" href="https://github.com/sylabs/examples">Sylabs examples repository</a>
contains an example container definition for the 3D modelling
application ‘Blender’.</p>
<p>The latest versions of Blender supports OpenCL rendering. You can run
Blender as a graphical application that will make use of a local Radeon
GPU for OpenCL compute using the container that has been published to
the Sylabs library:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>apptainer<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>--rocm<span class="w"> </span>--bind<span class="w"> </span>/etc/OpenCL<span class="w"> </span>library://sylabs/examples/blender<span class="w"> </span>blender
</pre></div>
</div>
<p>Note the <em>exec</em> used as the <em>runscript</em> for this container is setup for
batch rendering (which can also use OpenCL).</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mpi.html" class="btn btn-neutral float-left" title="Apptainer and MPI applications" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="contributing.html" class="btn btn-neutral float-right" title="Contributing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <br>
    &copy; Contributors to the Apptainer project, established as Apptainer a Series of LF Projects LLC
    <br>
    &copy; 2017-2022, Sylabs Inc


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>