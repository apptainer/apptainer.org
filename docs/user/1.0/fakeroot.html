<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fakeroot feature &mdash; Apptainer User Guide 1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/js/ga.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Signing and Verifying Containers" href="signNverify.html" />
    <link rel="prev" title="Build Environment" href="build_env.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Apptainer User Guide
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Apptainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security in Apptainer</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="definition_files.html">The Definition File</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_env.html">Build Environment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fakeroot feature</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#restrictions-security">Restrictions/security</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#filesystem">Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#network">Network</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#requirements-configuration">Requirements / Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#build">Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-from-a-definition-file">Build from a definition file:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ping-from-container">Ping from container:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#http-server">HTTP server:</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="signNverify.html">Sign and Verify</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_commands.html">Key management commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="encryption.html">Encrypted Containers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="endpoint.html">Remote Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="library_api.html">Library API Registries</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_services.html">Running Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment_and_metadata.html">Environment and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_options.html">Security Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Network Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgroups.html">Cgroups Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="checkpoint.html">Application Checkpointing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="singularity_compatibility.html">Singularity Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker_and_oci.html">Support for Docker / OCI Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci_runtime.html">OCI Runtime Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi.html">Apptainer and MPI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.html">GPU Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Apptainer User Guide</a>
      </nav>

      <div class="wy-nav-content">
<div class="rst-content style-external-links">
    <div class="admonition warning">
        <p class="admonition-title">Warning</p>
        <p>You're browsing the documentation for an old version of Apptainer. Consider upgrading to the latest version of Apptainer.</p>
        <p>Documentation for the latest version can always be found at: <br><a class="reference external" href="https://apptainer.org/docs/user/latest/">https://apptainer.org/docs/user/latest/</a></p>
    </div>
</div>

        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Fakeroot feature</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/apptainer/apptainer-userdocs/blob/master/fakeroot.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="fakeroot-feature">
<span id="fakeroot"></span><h1>Fakeroot feature<a class="headerlink" href="#fakeroot-feature" title="Permalink to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>The fakeroot feature (commonly referred as rootless mode) allows an
unprivileged user to run a container as a <strong>“fake root”</strong> user by
leveraging <a class="reference external" href="http://man7.org/linux/man-pages/man7/user_namespaces.7.html">user namespace UID/GID mapping</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature requires a Linux kernel &gt;= 3.8, but the recommended
version is &gt;= 3.18</p>
</div>
<p>A <strong>“fake root”</strong> user has almost the same administrative rights as root
but only <strong>inside the container</strong> and the <strong>requested namespaces</strong>,
which means that this user:</p>
<blockquote>
<div><ul class="simple">
<li><p>can set different user/group ownership for files or directories
they own</p></li>
<li><p>can change user/group identity with su/sudo commands</p></li>
<li><p>has full privileges inside the requested namespaces (network, ipc,
uts)</p></li>
</ul>
</div></blockquote>
</section>
<section id="restrictions-security">
<h2>Restrictions/security<a class="headerlink" href="#restrictions-security" title="Permalink to this heading"></a></h2>
<section id="filesystem">
<h3>Filesystem<a class="headerlink" href="#filesystem" title="Permalink to this heading"></a></h3>
<p>A <strong>“fake root”</strong> user can’t access or modify files and directories for
which they don’t already have access or rights on the host filesystem,
so a <strong>“fake root”</strong> user won’t be able to access root-only host files
like <code class="docutils literal notranslate"><span class="pre">/etc/shadow</span></code> or the host <code class="docutils literal notranslate"><span class="pre">/root</span></code> directory.</p>
<p>Additionally, all files or directories created by the <strong>“fake root”</strong>
user are owned by <code class="docutils literal notranslate"><span class="pre">root:root</span></code> inside container but as <code class="docutils literal notranslate"><span class="pre">user:group</span></code>
outside of the container. Let’s consider the following example, in this
case “user” is authorized to use the fakeroot feature and can use 65536
UIDs starting at 131072 (same thing for GIDs).</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 49%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>UID inside container</p></th>
<th class="head"><p>UID outside container</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0 (root)</p></td>
<td><p>1000 (user)</p></td>
</tr>
<tr class="row-odd"><td><p>1 (daemon)</p></td>
<td><p>131072 (non-existent)</p></td>
</tr>
<tr class="row-even"><td><p>2 (bin)</p></td>
<td><p>131073 (non-existent)</p></td>
</tr>
<tr class="row-odd"><td><p>…</p></td>
<td><p>…</p></td>
</tr>
<tr class="row-even"><td><p>65536</p></td>
<td><p>196607</p></td>
</tr>
</tbody>
</table>
<p>Which means if the <strong>“fake root”</strong> user creates a file under a <code class="docutils literal notranslate"><span class="pre">bin</span></code>
user in the container, this file will be owned by <code class="docutils literal notranslate"><span class="pre">131073:131073</span></code>
outside of container. The responsibility relies on the administrator to
ensure that there is no overlap with the current user’s UID/GID on the
system.</p>
</section>
<section id="network">
<h3>Network<a class="headerlink" href="#network" title="Permalink to this heading"></a></h3>
<p>Restrictions are also applied to networking, if <code class="docutils literal notranslate"><span class="pre">apptainer</span></code> is
executed without the <code class="docutils literal notranslate"><span class="pre">--net</span></code> flag, the <strong>“fake root”</strong> user won’t be
able to use <code class="docutils literal notranslate"><span class="pre">ping</span></code> or bind a container service to a port below 1024.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">--net</span></code> the <strong>“fake root”</strong> user has full privileges in a
dedicated container network. Inside the container network they can bind
on privileged ports below 1024, use ping, manage firewall rules, listen
to traffic, etc. Anything done in this dedicated network won’t affect
the host network.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Of course an unprivileged user could not map host ports below than
1024 by using: <code class="docutils literal notranslate"><span class="pre">--network-args=&quot;portmap=80:80/tcp&quot;</span></code></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For unprivileged installation of Apptainer or if <code class="docutils literal notranslate"><span class="pre">allow</span> <span class="pre">setuid</span> <span class="pre">=</span>
<span class="pre">no</span></code> is set in <code class="docutils literal notranslate"><span class="pre">apptainer.conf</span></code> users won’t be able to use a
<code class="docutils literal notranslate"><span class="pre">fakeroot</span></code> network.</p>
</div>
</section>
</section>
<section id="requirements-configuration">
<h2>Requirements / Configuration<a class="headerlink" href="#requirements-configuration" title="Permalink to this heading"></a></h2>
<p>Fakeroot depends on user mappings set in <code class="docutils literal notranslate"><span class="pre">/etc/subuid</span></code> and group
mappings in <code class="docutils literal notranslate"><span class="pre">/etc/subgid</span></code>, so your username needs to be listed in
those files with a valid mapping (see the admin-guide for details), if
you can’t edit the files ask an administrator.</p>
<p>Apptainer provides a <code class="docutils literal notranslate"><span class="pre">apptainer</span> <span class="pre">config</span> <span class="pre">fakeroot</span></code> command
to allow configuration of the <code class="docutils literal notranslate"><span class="pre">/etc/subuid</span></code> and
<code class="docutils literal notranslate"><span class="pre">/etc/subgid</span></code> mappings from the Apptainer command line. You must
be a root user or run with <code class="docutils literal notranslate"><span class="pre">sudo</span></code> to use <code class="docutils literal notranslate"><span class="pre">config</span> <span class="pre">fakeroot</span></code>, as the
mapping files are security sensitive. See the admin-guide for more
details.</p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading"></a></h2>
<p>If your user account is configured with valid <code class="docutils literal notranslate"><span class="pre">subuid</span></code> and <code class="docutils literal notranslate"><span class="pre">subgid</span></code>
mappings you work as a fake root user inside a container by using the
<code class="docutils literal notranslate"><span class="pre">--fakeroot</span></code> or <code class="docutils literal notranslate"><span class="pre">-f</span></code> option.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--fakeroot</span></code> option is available with the following apptainer
commands:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">shell</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exec</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">start</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">build</span></code></p></li>
</ul>
</div></blockquote>
<section id="build">
<h3>Build<a class="headerlink" href="#build" title="Permalink to this heading"></a></h3>
<p>With fakeroot an unprivileged user can now build an image from a
definition file with few restrictions. Some bootstrap methods that
require creation of block devices (like <code class="docutils literal notranslate"><span class="pre">/dev/null</span></code>) may not always
work correctly with <strong>“fake root”</strong>, Apptainer uses seccomp filters
to give programs the illusion that block device creation succeeded. This
appears to work with <code class="docutils literal notranslate"><span class="pre">yum</span></code> bootstraps and <em>may</em> work with other
bootstrap methods, although <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code> is known to not work.</p>
</section>
<section id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h3>
<section id="build-from-a-definition-file">
<h4>Build from a definition file:<a class="headerlink" href="#build-from-a-definition-file" title="Permalink to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">build</span> <span class="o">--</span><span class="n">fakeroot</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">sif</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="k">def</span>
</pre></div>
</div>
</section>
<section id="ping-from-container">
<h4>Ping from container:<a class="headerlink" href="#ping-from-container" title="Permalink to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">exec</span> <span class="o">--</span><span class="n">fakeroot</span> <span class="o">--</span><span class="n">net</span> <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="n">alpine</span> <span class="n">ping</span> <span class="o">-</span><span class="n">c1</span> <span class="mf">8.8.8.8</span>
</pre></div>
</div>
</section>
<section id="http-server">
<h4>HTTP server:<a class="headerlink" href="#http-server" title="Permalink to this heading"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apptainer</span> <span class="n">run</span> <span class="o">--</span><span class="n">fakeroot</span> <span class="o">--</span><span class="n">net</span> <span class="o">--</span><span class="n">network</span><span class="o">-</span><span class="n">args</span><span class="o">=</span><span class="s2">&quot;portmap=8080:80/tcp&quot;</span> <span class="o">-</span><span class="n">w</span> <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="n">nginx</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="build_env.html" class="btn btn-neutral float-left" title="Build Environment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="signNverify.html" class="btn btn-neutral float-right" title="Signing and Verifying Containers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
    <br>
    &copy; Contributors to the Apptainer project, established as Apptainer a Series of LF Projects LLC
    <br>
    &copy; 2017-2022, Sylabs Inc


</footer>
        </div>

      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>