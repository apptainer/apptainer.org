

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Definition Files &mdash; Singularity container 3.4 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/js/ga.js"></script>
        <script src="_static/js/footer.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Build Environment" href="build_env.html" />
    <link rel="prev" title="Build a Container" href="build_a_container.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Singularity container
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Container Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a container</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The Definition File</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#header">Header</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preferred-bootstrap-agents">Preferred bootstrap agents</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-bootstrap-agents">Other bootstrap agents</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sections">Sections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup">%setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#files">%files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#app">%app*</a></li>
<li class="toctree-l3"><a class="reference internal" href="#post">%post</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test">%test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment">%environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#startscript">%startscript</a></li>
<li class="toctree-l3"><a class="reference internal" href="#runscript">%runscript</a></li>
<li class="toctree-l3"><a class="reference internal" href="#labels">%labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#help">%help</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multi-stage-builds">Multi-Stage Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="#apps">Apps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#best-practices-for-build-recipes">Best Practices for Build Recipes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="build_env.html">Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="encryption.html">Encrypted Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud_library.html">Cloud Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="singularity_and_docker.html">Singularity and Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_services.html">Running Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment_and_metadata.html">Environment and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci_runtime.html">OCI Runtime Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Container Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_commands.html">Key commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="signNverify.html">Sign and Verify</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_options.html">Security Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Network Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="fakeroot.html">Fakeroot feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="endpoint.html">Remote Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgroups.html">Cgroups Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi.html">Singularity and MPI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Singularity container</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Definition Files</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/sylabs/singularity-userdocs/blob/master/definition_files.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="definition-files">
<span id="definitionfiles"></span><h1>Definition Files<a class="headerlink" href="#definition-files" title="Permalink to this headline">¶</a></h1>
<p id="sec-deffiles">A Singularity Definition File (or “def file” for short) is like a set of
blueprints explaining how to build a custom container. It includes specifics
about the base OS to build or the base container to start from, software to
install, environment variables to set at runtime, files to add from the host
system, and container metadata.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>A Singularity Definition file is divided into two parts:</p>
<ol class="arabic simple">
<li><p><strong>Header</strong>: The Header describes the core operating system to build within
the container. Here you will configure the base operating system features
needed within the container. You can specify, the Linux distribution, the
specific version, and the packages that must be part of the core install
(borrowed from the host system).</p></li>
<li><p><strong>Sections</strong>: The rest of the definition is comprised of sections, (sometimes
called scriptlets or blobs of data). Each section is defined by a <code class="docutils literal notranslate"><span class="pre">%</span></code>
character followed by the name of the particular section. All sections are
optional, and a def file may contain more than one instance of a given
section. Sections that are executed at build time are executed with the
<code class="docutils literal notranslate"><span class="pre">/bin/sh</span></code> interpreter and can accept <code class="docutils literal notranslate"><span class="pre">/bin/sh</span></code> options. Similarly,
sections that produce scripts to be executed at runtime can accept options
intended for <code class="docutils literal notranslate"><span class="pre">/bin/sh</span></code></p></li>
</ol>
<p>For more in-depth and practical examples of def files, see the <a class="reference external" href="https://github.com/sylabs/examples">Sylabs examples
repository</a></p>
<p>For a comparison between Dockerfile and Singularity definition file,
please see: <a class="reference internal" href="singularity_and_docker.html#sec-deffile-vs-dockerfile"><span class="std std-ref">this section</span></a>.</p>
</div>
<div class="section" id="header">
<h2>Header<a class="headerlink" href="#header" title="Permalink to this headline">¶</a></h2>
<p>The header should be written at the top of the def file. It tells Singularity
about the base operating system that it should use to build the container. It is
composed of several keywords.</p>
<p>The only keyword that is required for every type of build is <code class="docutils literal notranslate"><span class="pre">Bootstrap</span></code>.
It determines the <em>bootstrap agent</em>  that will be used to create the base
operating system you want to use. For example, the <code class="docutils literal notranslate"><span class="pre">library</span></code> bootstrap agent
will pull a container from the <a class="reference external" href="https://cloud.sylabs.io/library">Container Library</a> as a base. Similarly, the <code class="docutils literal notranslate"><span class="pre">docker</span></code>
bootstrap agent will pull docker layers from <a class="reference external" href="https://hub.docker.com/">Docker Hub</a> as a base OS to start your image.</p>
<p>Starting with Singularity 3.2, the <code class="docutils literal notranslate"><span class="pre">Bootstrap</span></code> keyword needs to be the first
entry in the header section.  This breaks compatibility with older versions
that allow the parameters of the header to appear in any order.</p>
<p>Depending on the value assigned to <code class="docutils literal notranslate"><span class="pre">Bootstrap</span></code>, other keywords may also be
valid in the header. For example, when using the <code class="docutils literal notranslate"><span class="pre">library</span></code> bootstrap agent,
the <code class="docutils literal notranslate"><span class="pre">From</span></code> keyword becomes valid. Observe the following example for building a
Debian container from the Container Library:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: library
<span class="k">From</span>: debian:<span class="m">7</span>
</pre></div>
</div>
<p>A def file that uses an official mirror to install Centos-7 might look like
this:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: yum
<span class="k">OSVersion</span>: <span class="m">7</span>
<span class="k">MirrorURL</span>: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/os/$basearch/
<span class="k">Include</span>: yum
</pre></div>
</div>
<p>Each bootstrap agent enables its own options and keywords. You can read about
them and see examples in the <a class="reference internal" href="appendix.html#buildmodules"><span class="std std-ref">appendix section</span></a>:</p>
<div class="section" id="preferred-bootstrap-agents">
<h3>Preferred bootstrap agents<a class="headerlink" href="#preferred-bootstrap-agents" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="appendix.html#build-library-module"><span class="std std-ref">library</span></a> (images hosted on the <a class="reference external" href="https://cloud.sylabs.io/library">Container Library</a>)</p></li>
<li><p><a class="reference internal" href="appendix.html#build-docker-module"><span class="std std-ref">docker</span></a> (images hosted on Docker Hub)</p></li>
<li><p><a class="reference internal" href="appendix.html#build-shub"><span class="std std-ref">shub</span></a> (images hosted on Singularity Hub)</p></li>
<li><p><a class="reference internal" href="appendix.html#build-oras"><span class="std std-ref">oras</span></a> (images from supporting OCI registries)</p></li>
<li><p><a class="reference internal" href="appendix.html#scratch-agent"><span class="std std-ref">scratch</span></a> (a flexible option for building a container from scratch)</p></li>
</ul>
</div>
<div class="section" id="other-bootstrap-agents">
<h3>Other bootstrap agents<a class="headerlink" href="#other-bootstrap-agents" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="appendix.html#build-localimage"><span class="std std-ref">localimage</span></a> (images saved on your machine)</p></li>
<li><p><a class="reference internal" href="appendix.html#build-yum"><span class="std std-ref">yum</span></a> (yum based systems such as CentOS and Scientific Linux)</p></li>
<li><p><a class="reference internal" href="appendix.html#build-debootstrap"><span class="std std-ref">debootstrap</span></a> (apt based systems such as Debian and Ubuntu)</p></li>
<li><p><a class="reference internal" href="singularity_and_docker.html#cli-oci-bootstrap-agent"><span class="std std-ref">oci</span></a> (bundle compliant with OCI Image Specification)</p></li>
<li><p><a class="reference internal" href="singularity_and_docker.html#cli-oci-archive-bootstrap-agent"><span class="std std-ref">oci-archive</span></a> (tar files obeying the OCI Image Layout Specification)</p></li>
<li><p><a class="reference internal" href="appendix.html#docker-daemon-archive"><span class="std std-ref">docker-daemon</span></a> (images managed by the locally running docker daemon)</p></li>
<li><p><a class="reference internal" href="appendix.html#docker-daemon-archive"><span class="std std-ref">docker-archive</span></a> (archived docker images)</p></li>
<li><p><a class="reference internal" href="appendix.html#build-arch"><span class="std std-ref">arch</span></a> (Arch Linux)</p></li>
<li><p><a class="reference internal" href="appendix.html#build-busybox"><span class="std std-ref">busybox</span></a> (BusyBox)</p></li>
<li><p><a class="reference internal" href="appendix.html#build-zypper"><span class="std std-ref">zypper</span></a> (zypper based systems such as Suse and OpenSuse)</p></li>
</ul>
</div>
</div>
<div class="section" id="sections">
<h2>Sections<a class="headerlink" href="#sections" title="Permalink to this headline">¶</a></h2>
<p>The main content of the bootstrap file is broken into sections. Different
sections add different content or execute commands at different times during the
build process. Note that if any command fails, the build process will halt.</p>
<p>Here is an example definition file that uses every available section. We will
discuss each section in turn. It is not necessary to include every section (or
any sections at all) within a def file. Furthermore, multiple sections of the
same name can be included and will be appended to one another during the build
process.</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: library
<span class="k">From</span>: ubuntu:<span class="m">18.04</span>
Stage: build

<span class="gh">%setup</span>
    touch /file1
    touch <span class="si">${</span><span class="nv">SINGULARITY_ROOTFS</span><span class="si">}</span>/file2

<span class="gh">%files</span>
    /file1
    /file1 /opt

<span class="gh">%environment</span>
    <span class="nb">export</span> <span class="nv">LISTEN_PORT</span><span class="o">=</span><span class="m">12345</span>
    <span class="nb">export</span> <span class="nv">LC_ALL</span><span class="o">=</span>C

<span class="gh">%post</span>
    apt-get update <span class="o">&amp;&amp;</span> apt-get install -y netcat
    <span class="nv">NOW</span><span class="o">=</span><span class="sb">`</span>date<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;export NOW=\&quot;</span><span class="si">${</span><span class="nv">NOW</span><span class="si">}</span><span class="s2">\&quot;&quot;</span> &gt;&gt; <span class="nv">$SINGULARITY_ENVIRONMENT</span>

<span class="gh">%runscript</span>
    <span class="nb">echo</span> <span class="s2">&quot;Container was created </span><span class="nv">$NOW</span><span class="s2">&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Arguments received: </span><span class="nv">$*</span><span class="s2">&quot;</span>
    <span class="nb">exec</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>

<span class="gh">%startscript</span>
    nc -lp <span class="nv">$LISTEN_PORT</span>

<span class="gh">%test</span>
    grep -q <span class="nv">NAME</span><span class="o">=</span><span class="se">\&quot;</span>Ubuntu<span class="se">\&quot;</span> /etc/os-release
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Container base is Ubuntu as expected.&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Container base is not Ubuntu.&quot;</span>
    <span class="k">fi</span>

<span class="gh">%labels</span>
    Author d@sylabs.io
    Version v0.0.1

<span class="gh">%help</span>
    This is a demo container used to illustrate a def file that uses all
    supported sections.
</pre></div>
</div>
<p>Although, the order of the sections in the def file is unimportant, they have
been documented below in the order of their execution during the build process
for logical understanding.</p>
<div class="section" id="setup">
<h3>%setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>During the build process, commands in the <code class="docutils literal notranslate"><span class="pre">%setup</span></code> section are first executed
on the host system outside of the container after the base OS has been installed.
You can reference the container file system with the <code class="docutils literal notranslate"><span class="pre">$SINGULARITY_ROOTFS</span></code>
environment variable in the <code class="docutils literal notranslate"><span class="pre">%setup</span></code> section.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be careful with the <code class="docutils literal notranslate"><span class="pre">%setup</span></code> section! This scriptlet is executed outside
of the container on the host system itself, and is executed with elevated
privileges. Commands in <code class="docutils literal notranslate"><span class="pre">%setup</span></code> can alter and potentially damage the
host.</p>
</div>
<p>Consider the example from the definition file above:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%setup</span>
    touch /file1
    touch <span class="si">${</span><span class="nv">SINGULARITY_ROOTFS</span><span class="si">}</span>/file2
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">file1</span></code> is created at the root of the file system <strong>on the host</strong>.
We’ll use <code class="docutils literal notranslate"><span class="pre">file1</span></code> to demonstrate the usage of the <code class="docutils literal notranslate"><span class="pre">%files</span></code> section below.
The <code class="docutils literal notranslate"><span class="pre">file2</span></code> is created at the root of the file system <strong>within the
container</strong>.</p>
<p>In later versions of Singularity the <code class="docutils literal notranslate"><span class="pre">%files</span></code> section is provided as a safer
alternative to copying files from the host system into the container during the
build. Because of the potential danger involved in running the <code class="docutils literal notranslate"><span class="pre">%setup</span></code>
scriptlet with elevated privileges on the host system during the build, it’s
use is generally discouraged.</p>
</div>
<div class="section" id="files">
<h3>%files<a class="headerlink" href="#files" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">%files</span></code> section allows you to copy files from your host system into the
container with greater safety than using the <code class="docutils literal notranslate"><span class="pre">%setup</span></code> section. Each line is a
<code class="docutils literal notranslate"><span class="pre">&lt;source&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;destination&gt;</span></code> pair, where the source is a path on your host
system, and the destination is a path in the container. The  <code class="docutils literal notranslate"><span class="pre">&lt;destination&gt;</span></code>
specification can be omitted and will be assumed to be the same path as the
<code class="docutils literal notranslate"><span class="pre">&lt;source&gt;</span></code> specification.</p>
<p>Consider the example from the definition file above:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%files</span>
    /file1
    /file1 /opt
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">file1</span></code> was created in the root of the host file system during the <code class="docutils literal notranslate"><span class="pre">%setup</span></code>
section (see above).  The <code class="docutils literal notranslate"><span class="pre">%files</span></code> scriptlet will copy <code class="docutils literal notranslate"><span class="pre">file1</span></code> to the root
of the container file system and then make a second copy of <code class="docutils literal notranslate"><span class="pre">file1</span></code> within the
container in <code class="docutils literal notranslate"><span class="pre">/opt</span></code>.</p>
<p>Files can be copied from other stages by providing the source location in the
previous stage and the destination in the current container.</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%files</span> from stage_name
  /root/hello /bin/hello
</pre></div>
</div>
<p>Files in the <code class="docutils literal notranslate"><span class="pre">%files</span></code> section are copied before the <code class="docutils literal notranslate"><span class="pre">%post</span></code> section is
executed so that they are available during the build and configuration process.</p>
</div>
<div class="section" id="app">
<h3>%app*<a class="headerlink" href="#app" title="Permalink to this headline">¶</a></h3>
<p>In some circumstances, it may be redundant to build different containers for
each app with nearly equivalent dependencies. Singularity supports installing
apps within internal modules based on the concept of <a class="reference external" href="https://sci-f.github.io/">Standard Container
Integration Format (SCI-F)</a>
All the apps are handled by Singularity at this point. More information on
Apps <a class="reference internal" href="#apps"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="post">
<h3>%post<a class="headerlink" href="#post" title="Permalink to this headline">¶</a></h3>
<p>This section is where you can download files from the internet with tools like <code class="docutils literal notranslate"><span class="pre">git</span></code>
and <code class="docutils literal notranslate"><span class="pre">wget</span></code>, install new software and libraries, write configuration files,
create new directories, etc.</p>
<p>Consider the example from the definition file above:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%post</span>
    apt-get update <span class="o">&amp;&amp;</span> apt-get install -y netcat
    <span class="nv">NOW</span><span class="o">=</span><span class="sb">`</span>date<span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">&quot;export NOW=\&quot;</span><span class="si">${</span><span class="nv">NOW</span><span class="si">}</span><span class="s2">\&quot;&quot;</span> &gt;&gt; <span class="nv">$SINGULARITY_ENVIRONMENT</span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">%post</span></code> scriptlet uses the Ubuntu package manager <code class="docutils literal notranslate"><span class="pre">apt</span></code> to update the
container and install the program <code class="docutils literal notranslate"><span class="pre">netcat</span></code> (that will be used in the
<code class="docutils literal notranslate"><span class="pre">%startscript</span></code> section below).</p>
<p>The script is also setting an environment variable at build time.  Note that the
value of this variable cannot be anticipated, and therefore cannot be set during
the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section. For situations like this, the <code class="docutils literal notranslate"><span class="pre">$SINGULARITY_ENVIRONMENT</span></code>
variable is provided. Redirecting text to this variable will cause it to be
written to a file called <code class="docutils literal notranslate"><span class="pre">/.singularity.d/env/91-environment.sh</span></code> that will be
sourced at runtime.</p>
</div>
<div class="section" id="test">
<h3>%test<a class="headerlink" href="#test" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">%test</span></code> section runs at the very end of the build process to validate the
container using a method of your choice. You can also execute this scriptlet
through the container itself, using the <code class="docutils literal notranslate"><span class="pre">test</span></code> command.</p>
<p>Consider the example from the def file above:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%test</span>
    grep -q <span class="nv">NAME</span><span class="o">=</span><span class="se">\&quot;</span>Ubuntu<span class="se">\&quot;</span> /etc/os-release
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Container base is Ubuntu as expected.&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Container base is not Ubuntu.&quot;</span>
    <span class="k">fi</span>
</pre></div>
</div>
<p>This (somewhat silly) script tests if the base OS is Ubuntu. You could also
write a script to test that binaries were appropriately downloaded and built, or
that software works as expected on custom hardware. If you want to build a
container without running the <code class="docutils literal notranslate"><span class="pre">%test</span></code> section (for example, if the build
system does not have the same hardware that will be used on the production
system), you can do so with the <code class="docutils literal notranslate"><span class="pre">--notest</span></code> build option:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build --notest my_container.sif my_container.def
</pre></div>
</div>
<p>Running the test command on a container built with this def file yields the
following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity test my_container.sif
Container base is Ubuntu as expected.
</pre></div>
</div>
<p>Now, the following sections are all inserted into the container filesystem in
single step:</p>
</div>
<div class="section" id="environment">
<h3>%environment<a class="headerlink" href="#environment" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section allows you to define environment variables that
will be set at runtime. Note that these variables are not made available at
build time by their inclusion in the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section. This means that
if you need the same variables during the build process, you should also define
them in your <code class="docutils literal notranslate"><span class="pre">%post</span></code> section. Specifically:</p>
<ul class="simple">
<li><p><strong>during build</strong>: The <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section is written to a file in the
container metadata directory. This file is not sourced.</p></li>
<li><p><strong>during runtime</strong>: The file in the container metadata directory is sourced.</p></li>
</ul>
<p>You should use the same conventions that you would use in a <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> or
<code class="docutils literal notranslate"><span class="pre">.profile</span></code> file. Consider this example from the def file above:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%environment</span>
    <span class="nb">export</span> <span class="nv">LISTEN_PORT</span><span class="o">=</span><span class="m">12345</span>
    <span class="nb">export</span> <span class="nv">LC_ALL</span><span class="o">=</span>C
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">$LISTEN_PORT</span></code> variable will be used in the <code class="docutils literal notranslate"><span class="pre">%startscript</span></code> section
below. The <code class="docutils literal notranslate"><span class="pre">$LC_ALL</span></code> variable is useful for many programs (often written in
Perl) that complain when no locale is set.</p>
<p>After building this container, you can verify that the environment variables are
set appropriately at runtime with the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity exec my_container.sif env | grep -E &#39;LISTEN_PORT|LC_ALL&#39;
LISTEN_PORT=12345
LC_ALL=C
</pre></div>
</div>
<p>In the special case of variables generated at build time, you can also add
environment variables to your container in the <code class="docutils literal notranslate"><span class="pre">%post</span></code> section.</p>
<p>At build time, the content of the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section is written to a file
called <code class="docutils literal notranslate"><span class="pre">/.singularity.d/env/90-environment.sh</span></code> inside of the container.  Text
redirected to the <code class="docutils literal notranslate"><span class="pre">$SINGULARITY_ENVIRONMENT</span></code> variable during <code class="docutils literal notranslate"><span class="pre">%post</span></code> is
added to a file called <code class="docutils literal notranslate"><span class="pre">/.singularity.d/env/91-environment.sh</span></code>.</p>
<p>At runtime, scripts in <code class="docutils literal notranslate"><span class="pre">/.singularity/env</span></code> are sourced in order. This means
that variables in the <code class="docutils literal notranslate"><span class="pre">%post</span></code> section take precedence over those added  via
<code class="docutils literal notranslate"><span class="pre">%environment</span></code>.</p>
<p>See <a class="reference internal" href="environment_and_metadata.html#environment-and-metadata"><span class="std std-ref">Environment and Metadata</span></a> for more
information about the Singularity container environment.</p>
</div>
<div class="section" id="startscript">
<span id="id2"></span><h3>%startscript<a class="headerlink" href="#startscript" title="Permalink to this headline">¶</a></h3>
<p>Similar to the <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> section, the contents of the <code class="docutils literal notranslate"><span class="pre">%startscript</span></code>
section are written to a file within the container at build time.  This file is
executed when the <code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">start</span></code> command is issued.</p>
<p>Consider the example from the def file above.</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%startscript</span>
    nc -lp <span class="nv">$LISTEN_PORT</span>
</pre></div>
</div>
<p>Here the netcat program is used to listen for TCP traffic on the port indicated
by the <code class="docutils literal notranslate"><span class="pre">$LISTEN_PORT</span></code> variable (set in the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section above).
The script can be invoked like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance start my_container.sif instance1
INFO:    instance started successfully

$ lsof | grep LISTEN
nc        19061               vagrant    3u     IPv4             107409      0t0        TCP *:12345 (LISTEN)

$ singularity instance stop instance1
Stopping instance1 instance of /home/vagrant/my_container.sif (PID=19035)
</pre></div>
</div>
</div>
<div class="section" id="runscript">
<span id="id3"></span><h3>%runscript<a class="headerlink" href="#runscript" title="Permalink to this headline">¶</a></h3>
<p>The contents of the <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> section are written to a file within the
container that is executed when the container image is run (either via the
<code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">run</span></code> command or by executing the container directly as a
command). When the container is invoked, arguments following the container name
are passed to the runscript. This means that you can (and should) process
arguments within your runscript.</p>
<p>Consider the example from the def file above:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%runscript</span>
    <span class="nb">echo</span> <span class="s2">&quot;Container was created </span><span class="nv">$NOW</span><span class="s2">&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Arguments received: </span><span class="nv">$*</span><span class="s2">&quot;</span>
    <span class="nb">exec</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>In this runscript, the time that the container was created is echoed via the
<code class="docutils literal notranslate"><span class="pre">$NOW</span></code> variable (set in the <code class="docutils literal notranslate"><span class="pre">%post</span></code> section above). The options passed to
the container at runtime are printed as a single string (<code class="docutils literal notranslate"><span class="pre">$*</span></code>) and then they
are passed to echo via a quoted array (<code class="docutils literal notranslate"><span class="pre">$&#64;</span></code>) which ensures that all of the
arguments are properly parsed by the executed command. The <code class="docutils literal notranslate"><span class="pre">exec</span></code> preceding
the final <code class="docutils literal notranslate"><span class="pre">echo</span></code> command replaces the current entry in the process table
(which originally was the call to Singularity). Thus the runscript shell process
ceases to exist, and only the process running within the container remains.</p>
<p>Running the container built using this def file will yield the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./my_container.sif
Container was created Thu Dec  6 20:01:56 UTC 2018
Arguments received:

$ ./my_container.sif this that and the other
Container was created Thu Dec  6 20:01:56 UTC 2018
Arguments received: this that and the other
this that and the other
</pre></div>
</div>
</div>
<div class="section" id="labels">
<h3>%labels<a class="headerlink" href="#labels" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">%labels</span></code> section is used to add metadata to the file
<code class="docutils literal notranslate"><span class="pre">/.singularity.d/labels.json</span></code> within your container. The general format is a
name-value pair.</p>
<p>Consider the example from the def file above:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%labels</span>
    Author d@sylabs.io
    Version v0.0.1
    MyLabel Hello World
</pre></div>
</div>
<p>Note that labels are defined by key-value pairs. To define a label just add it
on the labels section and after the first space character add the correspondent value to the label.</p>
<p>On the previous example, the first label name is <code class="docutils literal notranslate"><span class="pre">Author`</span></code> with a
value of <code class="docutils literal notranslate"><span class="pre">d&#64;sylabs.io</span></code>. The second label name is <code class="docutils literal notranslate"><span class="pre">Version</span></code> with a value of <code class="docutils literal notranslate"><span class="pre">v0.0.1</span></code>.
Finally, the last label named <code class="docutils literal notranslate"><span class="pre">MyLabel</span></code> has the value of <code class="docutils literal notranslate"><span class="pre">Hello</span> <span class="pre">World</span></code>.</p>
<p>To inspect the available labels on your image you can do so by running the following command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity inspect my_container.sif

{
  &quot;Author&quot;: &quot;d@sylabs.io&quot;,
  &quot;Version&quot;: &quot;v0.0.1&quot;,
  &quot;MyLabel&quot;: &quot;Hello World&quot;,
  &quot;org.label-schema.build-date&quot;: &quot;Thursday_6_December_2018_20:1:56_UTC&quot;,
  &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,
  &quot;org.label-schema.usage&quot;: &quot;/.singularity.d/runscript.help&quot;,
  &quot;org.label-schema.usage.singularity.deffile.bootstrap&quot;: &quot;library&quot;,
  &quot;org.label-schema.usage.singularity.deffile.from&quot;: &quot;ubuntu:18.04&quot;,
  &quot;org.label-schema.usage.singularity.runscript.help&quot;: &quot;/.singularity.d/runscript.help&quot;,
  &quot;org.label-schema.usage.singularity.version&quot;: &quot;3.0.1&quot;
}
</pre></div>
</div>
<p>Some labels that are captured automatically from the build process. You can read
more about labels and metadata <a class="reference internal" href="environment_and_metadata.html#environment-and-metadata"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="help">
<h3>%help<a class="headerlink" href="#help" title="Permalink to this headline">¶</a></h3>
<p>Any text in the <code class="docutils literal notranslate"><span class="pre">%help</span></code> section is transcribed into a metadata file in the
container during the build. This text can then be displayed using the
<code class="docutils literal notranslate"><span class="pre">run-help</span></code> command.</p>
<p>Consider the example from the def file above:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%help</span>
    This is a demo container used to illustrate a def file that uses all
    supported sections.
</pre></div>
</div>
<p>After building the help can be displayed like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity run-help my_container.sif
    This is a demo container used to illustrate a def file that uses all
    supported sections.
</pre></div>
</div>
</div>
</div>
<div class="section" id="multi-stage-builds">
<h2>Multi-Stage Builds<a class="headerlink" href="#multi-stage-builds" title="Permalink to this headline">¶</a></h2>
<p>Starting with Singularity v3.2 multi-stage builds are supported where one environment
can be used for compilation, then the resulting binary can be copied into a final
environment. This allows a slimmer final image that does not require the entire
development stack.</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: golang:<span class="m">1.12.3</span>-alpine3<span class="m">.9</span>
Stage: devel

<span class="gh">%post</span>
  <span class="c1"># prep environment</span>
  <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;/go/bin:/usr/local/go/bin:</span><span class="nv">$PATH</span><span class="s2">&quot;</span>
  <span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span><span class="s2">&quot;/root&quot;</span>
  <span class="nb">cd</span> /root

  <span class="c1"># insert source code, could also be copied from host with %files</span>
  cat <span class="s">&lt;&lt; EOF &gt; hello.go</span>
<span class="s">  package main</span>
<span class="s">  import &quot;fmt&quot;</span>

<span class="s">  func main() {</span>
<span class="s">    fmt.Printf(&quot;Hello World!\n&quot;)</span>
<span class="s">  }</span>
<span class="s">EOF</span>

  go build -o hello hello.go


<span class="c1"># Install binary into final image</span>
Bootstrap: library
From: alpine:3.9
Stage: final

<span class="c1"># install binary from stage one</span>
<span class="gh">%files</span> from devel
  /root/hello /bin/hello
</pre></div>
</div>
<p>The names of stages are arbitrary. Each of these sections will be executed in
the same order as described for single stage build except the files from the
previous stage are copied before <code class="docutils literal notranslate"><span class="pre">%setup</span></code> section of the next stage. Files
can only be copied from stages declared before the current stage in the definition.
E.g., the <code class="docutils literal notranslate"><span class="pre">devel</span></code> stage in the above definition cannot copy files from the
<code class="docutils literal notranslate"><span class="pre">final</span></code> stage, but the <code class="docutils literal notranslate"><span class="pre">final</span></code> stage can copy files from the <code class="docutils literal notranslate"><span class="pre">devel</span></code> stage.</p>
</div>
<div class="section" id="apps">
<span id="id4"></span><h2>Apps<a class="headerlink" href="#apps" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">%app*</span></code> sections can exist alongside any of the primary sections (i.e.
<code class="docutils literal notranslate"><span class="pre">%post</span></code>, <code class="docutils literal notranslate"><span class="pre">%runscript</span></code>, <code class="docutils literal notranslate"><span class="pre">%environment</span></code>, etc.).  As with the other sections,
the ordering of the <code class="docutils literal notranslate"><span class="pre">%app*</span></code> sections isn’t important.</p>
<p>The following runscript demonstrates how to build 2 different apps into the
same container using SCI-F modules:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: ubuntu

<span class="gh">%environment</span>
    <span class="nv">GLOBAL</span><span class="o">=</span>variables
    <span class="nv">AVAILABLE</span><span class="o">=</span><span class="s2">&quot;to all apps&quot;</span>

<span class="c1">##############################</span>
<span class="c1"># foo</span>
<span class="c1">##############################</span>

<span class="gh">%apprun</span> foo
    <span class="nb">exec</span> <span class="nb">echo</span> <span class="s2">&quot;RUNNING FOO&quot;</span>

<span class="gh">%applabels</span> foo
   BESTAPP FOO

<span class="gh">%appinstall</span> foo
   touch foo.exec

<span class="gh">%appenv</span> foo
    <span class="nv">SOFTWARE</span><span class="o">=</span>foo
    <span class="nb">export</span> SOFTWARE

<span class="gh">%apphelp</span> foo
    This is the <span class="nb">help</span> <span class="k">for</span> foo.

<span class="gh">%appfiles</span> foo
   foo.txt

<span class="c1">##############################</span>
<span class="c1"># bar</span>
<span class="c1">##############################</span>

<span class="gh">%apphelp</span> bar
    This is the <span class="nb">help</span> <span class="k">for</span> bar.

<span class="gh">%applabels</span> bar
   BESTAPP BAR

<span class="gh">%appinstall</span> bar
    touch bar.exec

<span class="gh">%appenv</span> bar
    <span class="nv">SOFTWARE</span><span class="o">=</span>bar
    <span class="nb">export</span> SOFTWARE
</pre></div>
</div>
<p>An <code class="docutils literal notranslate"><span class="pre">%appinstall</span></code> section is the equivalent of <code class="docutils literal notranslate"><span class="pre">%post</span></code> but for a particular
app. Similarly, <code class="docutils literal notranslate"><span class="pre">%appenv</span></code> equates to the app version of <code class="docutils literal notranslate"><span class="pre">%environment</span></code> and
so on.</p>
<p>After installing apps into modules using the <code class="docutils literal notranslate"><span class="pre">%app*</span></code> sections, the <code class="docutils literal notranslate"><span class="pre">--app</span></code>
option becomes available allowing the following functions:</p>
<p>To run a specific app within the container:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>% singularity run --app foo my_container.sif
RUNNING FOO
</pre></div>
</div>
<p>The same environment variable, <code class="docutils literal notranslate"><span class="pre">$SOFTWARE</span></code> is defined for both apps in the def
file above. You can execute the following command to search the list of active
environment variables and <code class="docutils literal notranslate"><span class="pre">grep</span></code> to determine if the variable changes
depending on the app we specify:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity exec --app foo my_container.sif env | grep SOFTWARE
SOFTWARE=foo

$ singularity exec --app bar my_container.sif env | grep SOFTWARE
SOFTWARE=bar
</pre></div>
</div>
</div>
<div class="section" id="best-practices-for-build-recipes">
<h2>Best Practices for Build Recipes<a class="headerlink" href="#best-practices-for-build-recipes" title="Permalink to this headline">¶</a></h2>
<p>When crafting your recipe, it is best to consider the following:</p>
<ol class="arabic simple">
<li><p>Always install packages, programs, data, and files into operating system
locations (e.g. not <code class="docutils literal notranslate"><span class="pre">/home</span></code>, <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> , or any other directories that might
get commonly binded on).</p></li>
<li><p>Document your container. If your runscript doesn’t supply help, write a
<code class="docutils literal notranslate"><span class="pre">%help</span></code> or <code class="docutils literal notranslate"><span class="pre">%apphelp</span></code> section. A good container tells the user how to
interact with it.</p></li>
<li><p>If you require any special environment variables to be defined, add them to
the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> and <code class="docutils literal notranslate"><span class="pre">%appenv</span></code> sections of the build recipe.</p></li>
<li><p>Files should always be owned by a system account (UID less than 500).</p></li>
<li><p>Ensure that sensitive files like <code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code>, <code class="docutils literal notranslate"><span class="pre">/etc/group</span></code>, and
<code class="docutils literal notranslate"><span class="pre">/etc/shadow</span></code> do not contain secrets.</p></li>
<li><p>Build production containers from a definition file  instead of a sandbox that
has been manually changed. This ensures greatest possibility of
reproducibility and mitigates the “black box” effect.</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="build_env.html" class="btn btn-neutral float-right" title="Build Environment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="build_a_container.html" class="btn btn-neutral float-left" title="Build a Container" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2019, Sylabs Inc.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>