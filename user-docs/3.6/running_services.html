

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Running Services &mdash; Singularity container 3.6 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/js/ga.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Environment and Metadata" href="environment_and_metadata.html" />
    <link rel="prev" title="Persistent Overlays" href="persistent_overlays.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Singularity container
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Singularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security in Singularity</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="definition_files.html">The Definition File</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_env.html">Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="singularity_and_docker.html">Singularity and Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="fakeroot.html">Fakeroot feature</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="signNverify.html">Sign and Verify</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_commands.html">Key management commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="encryption.html">Encrypted Containers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="endpoint.html">Remote Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud_library.html">Cloud Library</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#container-instances-in-singularity">Container Instances in Singularity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nginx-hello-world-in-singularity">Nginx “Hello-world” in Singularity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#putting-all-together">Putting all together</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#building-the-image">Building the image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-service">Running the Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#making-it-fancy">Making it Fancy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#system-integration-pid-files">System integration / PID files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="environment_and_metadata.html">Environment and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci_runtime.html">OCI Runtime Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_options.html">Security Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Network Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgroups.html">Cgroups Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi.html">Singularity and MPI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.html">GPU Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Singularity container</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Running Services</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/sylabs/singularity-userdocs/blob/master/running_services.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="running-services">
<span id="id1"></span><h1>Running Services<a class="headerlink" href="#running-services" title="Permalink to this headline">¶</a></h1>
<p>There are <a class="reference internal" href="quick_start.html#runcontainer"><span class="std std-ref">different ways</span></a>  in which you can run Singularity
containers. If you use commands like <code class="docutils literal notranslate"><span class="pre">run</span></code>, <code class="docutils literal notranslate"><span class="pre">exec</span></code> and <code class="docutils literal notranslate"><span class="pre">shell</span></code> to
interact with processes in the container, you are running Singularity containers
in the foreground. Singularity, also lets you run containers in a “detached” or
“daemon” mode which can run different services in the background. A “service” is
essentially a process running in the background that multiple different clients
can use. For example, a web server or a database. To run services in a
Singularity container one should use <em>instances</em>. A container instance is a
persistent and isolated version of the container image that runs in the
background.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p id="sec-instances">Singularity v2.4 introduced the concept of <em>instances</em> allowing users to run
services in Singularity. This page will help you understand instances using an
elementary example followed by a more useful example running an NGINX web server
using instances. In the end, you will find a more detailed example of running an
instance of an API that converts URL to PDFs.</p>
<p>To begin with, suppose you want to run an NGINX web server outside of a
container. On Ubuntu, you can simply install NGINX and start the service by:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get update &amp;&amp; sudo apt-get install -y nginx

$ sudo service nginx start
</pre></div>
</div>
<p>If you were to do something like this from within a container you would also see
the service start, and the web server running. But then if you were to exit the
container, the process would continue to run within an unreachable mount
namespace. The process would still be running, but you couldn’t easily kill or
interface with it. This is a called an orphan process. Singularity instances
give you the ability to handle services properly.</p>
</div>
<div class="section" id="container-instances-in-singularity">
<h2>Container Instances in Singularity<a class="headerlink" href="#container-instances-in-singularity" title="Permalink to this headline">¶</a></h2>
<p>For demonstration, let’s use an easy (though somewhat useless) example of
<a class="reference external" href="https://cloud.sylabs.io/library/_container/5baba5e594feb900016ea41c">alpine_latest.sif</a>
image from the <a class="reference external" href="https://cloud.sylabs.io/library/">container library</a>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull library://alpine
</pre></div>
</div>
<p>The above command will save the alpine image from the Container Library as
<code class="docutils literal notranslate"><span class="pre">alpine_latest.sif</span></code>.</p>
<p>To start an instance, you should follow this procedure :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[command]                      [image]              [name of instance]

$ singularity instance start   alpine_latest.sif     instance1
</pre></div>
</div>
<p>This command causes Singularity to create an isolated environment for the
container services to live inside. One can confirm that an instance is running
by using the <code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">list</span></code> command like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance list

INSTANCE NAME    PID      IP              IMAGE
instance1        22084                    /home/dave/instances/alpine_latest.sif
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The instances are linked with your user account. So make sure to run <em>all</em>
instance commands either with or without the <code class="docutils literal notranslate"><span class="pre">sudo</span></code> privilege. If you
<code class="docutils literal notranslate"><span class="pre">start</span></code> an instance with sudo then you must <code class="docutils literal notranslate"><span class="pre">list</span></code> it with sudo as
well, or you will not be able to locate the instance.</p>
</div>
<p>If you want to run multiple instances from the same image, it’s as simple as
running the command multiple times with different instance names. The instance
name uniquely identify instances, so they cannot be repeated.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance start alpine_latest.sif instance2

$ singularity instance start alpine_latest.sif instance3
</pre></div>
</div>
<p>And again to confirm that the instances are running as we expected:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance list

INSTANCE NAME    PID      IP              IMAGE
instance1        22084                    /home/dave/instances/alpine_latest.sif
instance2        22443                    /home/dave/instances/alpine_latest.sif
instance3        22493                    /home/dave/instances/alpine_latest.sif
</pre></div>
</div>
<p>You can also filter the instance list by supplying a pattern:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance list &#39;*2&#39;

INSTANCE NAME    PID      IP              IMAGE
instance2        22443                    /home/dave/instances/alpine_latest.s
</pre></div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">run/exec</span></code> commands on instances:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity run instance://instance1

$ singularity exec instance://instance2 cat /etc/os-release
</pre></div>
</div>
<p>When using <code class="docutils literal notranslate"><span class="pre">run</span></code> with an instance URI, the <code class="docutils literal notranslate"><span class="pre">runscript</span></code> will be executed
inside of the instance. Similarly with <code class="docutils literal notranslate"><span class="pre">exec</span></code>, it will execute the given
command in the instance.</p>
<p>If you want to poke around inside of your instance, you can do a normal
<code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">shell</span></code> command, but give it the instance URI:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity shell instance://instance3

Singularity&gt;
</pre></div>
</div>
<p>When you are finished with your instance you can clean it up with the
<code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">stop</span></code> command as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance stop instance1
</pre></div>
</div>
<p>If you have multiple instances running and you want to stop all of them, you can
do so with a wildcard or the –all flag. The following three commands are all
identical.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance stop \*

$ singularity instance stop --all

$ singularity instance stop --a
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that you must escape the wildcard with a backslash like this <code class="docutils literal notranslate"><span class="pre">\*</span></code> to
pass it properly.</p>
</div>
</div>
<div class="section" id="nginx-hello-world-in-singularity">
<h2>Nginx “Hello-world” in Singularity<a class="headerlink" href="#nginx-hello-world-in-singularity" title="Permalink to this headline">¶</a></h2>
<p>The above example, although not very useful, should serve as a fair introduction
to the concept of Singularity instances and running services in the background.
The following illustrates a more useful example of setting up a sample NGINX web
server using instances. First we will create a basic
<span class="xref std std-ref">definition file</span> (let’s call it nginx.def):</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: nginx
<span class="k">Includecmd</span>: no

<span class="gh">%startscript</span>
   nginx
</pre></div>
</div>
<p>This downloads the official NGINX Docker container, converts it to a Singularity
image, and tells it to run NGINX when you start the instance. Since we’re
running a web server, we’re going to run the following commands as root.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build nginx.sif nginx.def

$ sudo singularity instance start --writable-tmpfs nginx.sif web
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The above <code class="docutils literal notranslate"><span class="pre">start</span></code> command requires <code class="docutils literal notranslate"><span class="pre">sudo</span></code> because we are running a web
server. Also, to let the instance write temporary files during execution,
you should use <code class="docutils literal notranslate"><span class="pre">--writable-tmpfs</span></code> while starting the instance.</p>
</div>
<p>Just like that we’ve downloaded, built, and run an NGINX Singularity
image. And to confirm that it’s correctly running:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ curl localhost

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
 body {
     width: 35em;
     margin: 0 auto;
     font-family: Tahoma, Verdana, Arial, sans-serif;
 }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>Visit localhost on your browser, you should see a Welcome message!</p>
</div>
<div class="section" id="putting-all-together">
<h2>Putting all together<a class="headerlink" href="#putting-all-together" title="Permalink to this headline">¶</a></h2>
<p>In this section, we will demonstrate an example of packaging a service into a
container and running it. The service we will be packaging is an API server that
converts a web page into a PDF, and can be found <a class="reference external" href="https://github.com/alvarcarto/url-to-pdf-api">here</a>. You can build the image by
following the steps described below or you can just download the final image
directly from Container Library, simply run:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull url-to-pdf.sif library://sylabs/doc-examples/url-to-pdf:latest
</pre></div>
</div>
<div class="section" id="building-the-image">
<h3>Building the image<a class="headerlink" href="#building-the-image" title="Permalink to this headline">¶</a></h3>
<p>This section will describe the requirements for creating the definition file
(url-to-pdf.def) that will be used to build the container image.
<code class="docutils literal notranslate"><span class="pre">url-to-pdf-api</span></code> is based on a Node 8 server that uses a headless version of
Chromium called <a class="reference external" href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a>.
Let’s first choose a base from which to build our container, in this case the
docker image <code class="docutils literal notranslate"><span class="pre">node:8</span></code> which comes pre-installed with Node 8 has been used:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: node:<span class="m">8</span>
<span class="k">Includecmd</span>: no
</pre></div>
</div>
<p>Puppeteer also requires a slew of dependencies to be manually installed in
addition to Node 8, so we can add those into the <code class="docutils literal notranslate"><span class="pre">post</span></code> section as well as the
installation script for the <code class="docutils literal notranslate"><span class="pre">url-to-pdf</span></code>:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%post</span>

    apt-get update <span class="o">&amp;&amp;</span> apt-get install -yq gconf-service libasound2 <span class="se">\</span>
        libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 <span class="se">\</span>
        libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 <span class="se">\</span>
        libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 <span class="se">\</span>
        libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 <span class="se">\</span>
        libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 <span class="se">\</span>
        libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates <span class="se">\</span>
        fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils <span class="se">\</span>
        wget curl <span class="o">&amp;&amp;</span> rm -r /var/lib/apt/lists/*
    git clone https://github.com/alvarcarto/url-to-pdf-api.git pdf_server
    <span class="nb">cd</span> pdf_server
    npm install
    chmod -R <span class="m">0755</span> .
</pre></div>
</div>
<p>And now we need to define what happens when we start an instance of the
container. In this situation, we want to run the commands that starts up the
url-to-pdf service:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%startscript</span>
    <span class="nb">cd</span> /pdf_server
    <span class="c1"># Use nohup and /dev/null to completely detach server process from terminal</span>
    nohup npm start &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> &lt; /dev/null <span class="p">&amp;</span>
</pre></div>
</div>
<p>Also, the <code class="docutils literal notranslate"><span class="pre">url-to-pdf</span></code> service requires some environment variables to be set,
which we can do in the environment section:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%environment</span>
    <span class="nv">NODE_ENV</span><span class="o">=</span>development
    <span class="nv">PORT</span><span class="o">=</span><span class="m">9000</span>
    <span class="nv">ALLOW_HTTP</span><span class="o">=</span><span class="nb">true</span>
    <span class="nv">URL</span><span class="o">=</span>localhost
    <span class="nb">export</span> NODE_ENV PORT ALLOW_HTTP URL
</pre></div>
</div>
<p>The complete definition file will look like this:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: node:<span class="m">8</span>
<span class="k">Includecmd</span>: no

<span class="gh">%post</span>

    apt-get update <span class="o">&amp;&amp;</span> apt-get install -yq gconf-service libasound2 <span class="se">\</span>
        libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 <span class="se">\</span>
        libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 <span class="se">\</span>
        libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 <span class="se">\</span>
        libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 <span class="se">\</span>
        libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 <span class="se">\</span>
        libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates <span class="se">\</span>
        fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils <span class="se">\</span>
        wget curl <span class="o">&amp;&amp;</span> rm -r /var/lib/apt/lists/*
    git clone https://github.com/alvarcarto/url-to-pdf-api.git pdf_server
    <span class="nb">cd</span> pdf_server
    npm install
    chmod -R <span class="m">0755</span> .

<span class="gh">%startscript</span>
    <span class="nb">cd</span> /pdf_server
    <span class="c1"># Use nohup and /dev/null to completely detach server process from terminal</span>
    nohup npm start &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> &lt; /dev/null <span class="p">&amp;</span>

<span class="gh">%environment</span>
    <span class="nv">NODE_ENV</span><span class="o">=</span>development
    <span class="nv">PORT</span><span class="o">=</span><span class="m">9000</span>
    <span class="nv">ALLOW_HTTP</span><span class="o">=</span><span class="nb">true</span>
    <span class="nv">URL</span><span class="o">=</span>localhost
    <span class="nb">export</span> NODE_ENV PORT ALLOW_HTTP URL
</pre></div>
</div>
<p>The container can be built like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build url-to-pdf.sif url-to-pdf.def
</pre></div>
</div>
</div>
<div class="section" id="running-the-service">
<h3>Running the Service<a class="headerlink" href="#running-the-service" title="Permalink to this headline">¶</a></h3>
<p>We can now start an instance and run the service:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity instance start url-to-pdf.sif pdf
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If there occurs an error related to port connection being refused while
starting the instance or while using it later, you can try specifying
different port numbers in the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section of the definition
file above.</p>
</div>
<p>We can confirm it’s working by sending the server an http request using
curl:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ curl -o sylabs.pdf localhost:9000/api/render?url=http://sylabs.io/docs

% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                         Dload  Upload   Total   Spent    Left  Speed

100 73750  100 73750    0     0  14583      0  0:00:05  0:00:05 --:--:-- 19130
</pre></div>
</div>
<p>You should see a PDF file being generated like the one shown below:</p>
<img alt="Screenshot of the PDF generated!" src="_images/docpage.png" />
<p>If you shell into the instance, you can see the running processes:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity shell instance://pdf
Singularity: Invoking an interactive shell within container...

Singularity final.sif:/home/ysub&gt; ps auxf
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root       461  0.0  0.0  18204  3188 pts/1    S    17:58   0:00 /bin/bash --norc
root       468  0.0  0.0  36640  2880 pts/1    R+   17:59   0:00  \_ ps auxf
root         1  0.0  0.1 565392 12144 ?        Sl   15:10   0:00 sinit
root        16  0.0  0.4 1113904 39492 ?       Sl   15:10   0:00 npm
root        26  0.0  0.0   4296   752 ?        S    15:10   0:00  \_ sh -c nodemon --watch ./src -e js src/index.js
root        27  0.0  0.5 1179476 40312 ?       Sl   15:10   0:00      \_ node /pdf_server/node_modules/.bin/nodemon --watch ./src -e js src/index.js
root        39  0.0  0.7 936444 61220 ?        Sl   15:10   0:02          \_ /usr/local/bin/node src/index.js

Singularity final.sif:/home/ysub&gt; exit
</pre></div>
</div>
</div>
<div class="section" id="making-it-fancy">
<h3>Making it Fancy<a class="headerlink" href="#making-it-fancy" title="Permalink to this headline">¶</a></h3>
<p>Now that we have confirmation that the server is working, let’s make it a little
cleaner. It’s difficult to remember the exact <code class="docutils literal notranslate"><span class="pre">curl</span></code> command and URL syntax
each time you want to request a PDF, so let’s automate it. To do that, we can
use Scientific Filesystem (SCIF) apps, that are integrated
directly into singularity. If you haven’t already, check out the <a class="reference external" href="https://sci-f.github.io/">Scientific
Filesystem documentation</a> to come up to speed.</p>
<p>First off, we’re going to move the installation of the url-to-pdf into an app,
so that there is a designated spot to place output files. To do that, we want to
add a section to our definition file to build the server:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%appinstall</span> pdf_server
    git clone https://github.com/alvarcarto/url-to-pdf-api.git pdf_server
    <span class="nb">cd</span> pdf_server
    npm install
    chmod -R <span class="m">0755</span> .
</pre></div>
</div>
<p>And update our <code class="docutils literal notranslate"><span class="pre">startscript</span></code> to point to the app location:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%startscript</span>
    <span class="nb">cd</span> /scif/apps/pdf_server/scif/pdf_server
    <span class="c1"># Use nohup and /dev/null to completely detach server process from terminal</span>
    nohup npm start &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> &lt; /dev/null <span class="p">&amp;</span>
</pre></div>
</div>
<p>Now we want to define the pdf_client app, which we will run to send the requests
to the server:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="gh">%apprun</span> pdf_client
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage: singularity run --app pdf &lt;instance://name&gt; &lt;URL&gt; [output file]&quot;</span>
        <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>
    curl -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SINGULARITY_APPDATA</span><span class="si">}</span><span class="s2">/output/</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">output</span><span class="p">.pdf</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">URL</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">PORT</span><span class="si">}</span><span class="s2">/api/render?url=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>As you can see, the <code class="docutils literal notranslate"><span class="pre">pdf_client</span></code> app checks to make sure that the user
provides at least one argument.</p>
<p>The full def file will look like this:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: node:<span class="m">8</span>
<span class="k">Includecmd</span>: no

<span class="gh">%post</span>

    apt-get update <span class="o">&amp;&amp;</span> apt-get install -yq gconf-service libasound2 <span class="se">\</span>
        libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 <span class="se">\</span>
        libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 <span class="se">\</span>
        libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 <span class="se">\</span>
        libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 <span class="se">\</span>
        libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 <span class="se">\</span>
        libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates <span class="se">\</span>
        fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils <span class="se">\</span>
        wget curl <span class="o">&amp;&amp;</span> rm -r /var/lib/apt/lists/*

<span class="gh">%appinstall</span> pdf_server
    git clone https://github.com/alvarcarto/url-to-pdf-api.git pdf_server
    <span class="nb">cd</span> pdf_server
    npm install
    chmod -R <span class="m">0755</span> .

<span class="gh">%startscript</span>
    <span class="nb">cd</span> /scif/apps/pdf_server/scif/pdf_server
    <span class="c1"># Use nohup and /dev/null to completely detach server process from terminal</span>
    nohup npm start &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> &lt; /dev/null <span class="p">&amp;</span>

<span class="gh">%environment</span>
    <span class="nv">NODE_ENV</span><span class="o">=</span>development
    <span class="nv">PORT</span><span class="o">=</span><span class="m">9000</span>
    <span class="nv">ALLOW_HTTP</span><span class="o">=</span><span class="nb">true</span>
    <span class="nv">URL</span><span class="o">=</span>localhost
    <span class="nb">export</span> NODE_ENV PORT ALLOW_HTTP URL

<span class="gh">%apprun</span> pdf_client
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Usage: singularity run --app pdf &lt;instance://name&gt; &lt;URL&gt; [output file]&quot;</span>
        <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>
    curl -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SINGULARITY_APPDATA</span><span class="si">}</span><span class="s2">/output/</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">output</span><span class="p">.pdf</span><span class="si">}</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">URL</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">PORT</span><span class="si">}</span><span class="s2">/api/render?url=</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Create the container as before. The <code class="docutils literal notranslate"><span class="pre">--force</span></code> option will overwrite the old
container:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build --force url-to-pdf.sif url-to-pdf.def
</pre></div>
</div>
<p>Now that we have an output directory in the container, we need to expose it to
the host using a bind mount. Once we’ve rebuilt the container, make a new
directory called <code class="docutils literal notranslate"><span class="pre">/tmp/out</span></code> for the generated PDFs to go.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ mkdir /tmp/out
</pre></div>
</div>
<p>After building the image from the edited definition file we simply start the
instance:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance start --bind /tmp/out/:/output url-to-pdf.sif pdf
</pre></div>
</div>
<p>To request a pdf simply do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity run --app pdf_client instance://pdf http://sylabs.io/docs sylabs.pdf
</pre></div>
</div>
<p>To confirm that it worked:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ls /tmp/out/
sylabs.pdf
</pre></div>
</div>
<p>When you are finished, use the instance stop command to close all running
instances.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance stop --all
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the service you want to run in your instance requires a bind mount,
then you must pass the <code class="docutils literal notranslate"><span class="pre">--bind</span></code> option when calling <code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">start</span></code>.
For example, if you wish to capture the output of the <code class="docutils literal notranslate"><span class="pre">web</span></code> container
instance which is placed at <code class="docutils literal notranslate"><span class="pre">/output/</span></code> inside the container you could do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance start --bind output/dir/outside/:/output/ nginx.sif  web
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="system-integration-pid-files">
<h2>System integration / PID files<a class="headerlink" href="#system-integration-pid-files" title="Permalink to this headline">¶</a></h2>
<p>If you are running services in containers you may want them to be started on
boot, and shutdown gracefully automatically. This is usually performed by an init process,
or another supervisor daemon installed on your host. Many init and supervisor
daemons support managing processes via pid files.</p>
<p>You can specify a <cite>–pid-file</cite> option to <cite>singularity instance start</cite> to write
the PID for an instance to the specifed file, e.g.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity instance start --pid-file /home/dave/alpine.pid alpine_latest.sif instanceA

$ cat /home/dave/alpine.pid
23727
</pre></div>
</div>
<p>An example service file for an instance controlled by systemd is below. This can be used as a
template to setup containerized services under systemd.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Unit]
Description=Web Instance
After=network.target

[Service]
Type=forking
Restart=always
User=www-data
Group=www-data
PIDFile=/run/web-instance.pid
ExecStart=/usr/local/bin/singularity instance start --pid-file /run/web-instance.pid /data/containers/web.sif web-instance
ExecStop=/usr/local/bin/singularity instance stop web-instance

[Install]
WantedBy=multi-user.target
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">Type=forking</span></code> is required here, since <code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">start</span></code> starts an instance and then exits.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="environment_and_metadata.html" class="btn btn-neutral float-right" title="Environment and Metadata" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="persistent_overlays.html" class="btn btn-neutral float-left" title="Persistent Overlays" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2020, Sylabs Inc.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>