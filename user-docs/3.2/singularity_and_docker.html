

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Support for Docker and OCI &mdash; Singularity container 3.2 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Bind Paths and Mounts" href="bind_paths_and_mounts.html" />
    <link rel="prev" title="Cloud Library" href="cloud_library.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Singularity container
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="definition_files.html">The Definition File</a></li>
<li class="toctree-l1"><a class="reference internal" href="build_env.html">Build Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud_library.html">Cloud Library</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Singularity and Docker</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-action-commands-on-public-images-from-docker-hub">Running action commands on public images from Docker Hub</a></li>
<li class="toctree-l2"><a class="reference internal" href="#making-use-of-public-images-from-docker-hub">Making use of public images from Docker Hub</a></li>
<li class="toctree-l2"><a class="reference internal" href="#making-use-of-private-images-from-docker-hub">Making use of private images from Docker Hub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#authentication-via-interactive-login">Authentication via Interactive Login</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authentication-via-environment-variables">Authentication via Environment Variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#making-use-of-private-images-from-private-registries">Making use of private images from Private Registries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-images-for-singularity-from-docker-registries">Building images for Singularity from Docker Registries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#working-from-the-singularity-command-line">Working from the Singularity Command Line</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#remotely-hosted-images">Remotely Hosted Images</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-containers-remotely">Building Containers Remotely</a></li>
<li class="toctree-l4"><a class="reference internal" href="#locally-available-images-cached-by-docker">Locally Available Images: Cached by Docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#locally-available-images-stored-archives">Locally Available Images: Stored Archives</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pushing-locally-available-images-to-a-library">Pushing Locally Available Images to a Library</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#working-with-definition-files">Working with Definition Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mandatory-header-keywords-remotely-boostrapped">Mandatory Header Keywords: Remotely Boostrapped</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remotely-bootstrapped-and-built-containers">Remotely Bootstrapped and Built Containers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mandatory-header-keywords-locally-boostrapped">Mandatory Header Keywords: Locally Boostrapped</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-header-keywords">Optional Header Keywords</a></li>
<li class="toctree-l4"><a class="reference internal" href="#private-images-and-registries">Private Images and Registries</a></li>
<li class="toctree-l4"><a class="reference internal" href="#directing-execution">Directing Execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#container-metadata">Container Metadata</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#oci-image-support">OCI Image Support</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sec-oci-overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#image-pulls-revisited">Image Pulls Revisited</a></li>
<li class="toctree-l4"><a class="reference internal" href="#image-caching-in-singularity">Image Caching in Singularity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compliance-with-the-oci-image-layout-specification">Compliance with the OCI Image Layout Specification</a></li>
<li class="toctree-l4"><a class="reference internal" href="#oci-compliance-and-the-singularity-cache">OCI Compliance and the Singularity Cache</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-containers-for-singularity-from-oci-images">Building Containers for Singularity from OCI Images</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#working-locally-from-the-singularity-command-line-oci-boostrap-agent">Working Locally from the Singularity Command Line: <code class="docutils literal notranslate"><span class="pre">oci</span></code> Boostrap Agent</a></li>
<li class="toctree-l4"><a class="reference internal" href="#working-locally-from-the-singularity-command-line-oci-archive-boostrap-agent">Working Locally from the Singularity Command Line: <code class="docutils literal notranslate"><span class="pre">oci-archive</span></code> Boostrap Agent</a></li>
<li class="toctree-l4"><a class="reference internal" href="#working-from-the-singularity-command-line-with-remotely-hosted-images">Working from the Singularity Command Line with Remotely Hosted Images</a></li>
<li class="toctree-l4"><a class="reference internal" href="#working-with-definition-files-mandatory-header-keywords">Working with Definition Files: Mandatory Header Keywords</a></li>
<li class="toctree-l4"><a class="reference internal" href="#working-with-definition-files-additonal-considerations">Working with Definition Files: Additonal Considerations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_services.html">Running Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment_and_metadata.html">Environment and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci_runtime.html">OCI Runtime Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_commands.html">Key commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="signNverify.html">Sign and Verify</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_options.html">Security Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Network Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="endpoint.html">Remote Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgroups.html">Cgroups Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Singularity container</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Support for Docker and OCI</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/sylabs/singularity-userdocs/blob/master/singularity_and_docker.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="support-for-docker-and-oci">
<span id="singularity-and-docker"></span><h1>Support for Docker and OCI<a class="headerlink" href="#support-for-docker-and-oci" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Effort has been expended in developing <a class="reference external" href="https://www.docker.com/">Docker</a> containers. Deconstructed into one or more compressed archives (typically split across multiple segments, or <strong>layers</strong> as they are known in Docker parlance) plus some metadata, images for these containers are built from specifications known as <code class="docutils literal notranslate"><span class="pre">Dockerfiles</span></code>. The public <a class="reference external" href="https://hub.docker.com/">Docker Hub</a>, as well as various private registries, host images for use as Docker containers. Singularity has from the outset emphasized the importance of interoperability with Docker. As a consequence, this section of the Singularity User Docs first makes its sole focus interoperabilty with Docker. In so doing, the following topics receive attention here:</p>
<blockquote>
<div><ul class="simple">
<li><p>Application of Singularity action commands on ephemeral containers derived from public Docker images</p></li>
<li><p>Converting public Docker images into Singularity’s native format for containerization, namely the Singularity Image Format (SIF)</p></li>
<li><p>Authenticated application of Singularity commands to containers derived from private Docker images</p></li>
<li><p>Authenticated application of Singularity commands to containers derived from private Docker images originating from private registries</p></li>
<li><p>Building SIF containers for Singularity via the command line or definition files from a variety of sources for Docker images and image archives</p></li>
</ul>
</div></blockquote>
<p>The second part of this section places emphasis upon Singularity’s interoperability with open standards emerging from the <a class="reference external" href="https://www.opencontainers.org/">Open Containers Initiative</a> (OCI). Specifically, in documenting Singularity interoperability as it relates to the OCI Image Specification, the following topics are covered:</p>
<blockquote>
<div><ul class="simple">
<li><p>Compliance with the OCI Image Layout Specification</p></li>
<li><p>OCI-compliant caching in Singularity</p></li>
<li><p>Acquiring OCI images and image archives via Singularity</p></li>
<li><p>Building SIF containers for Singularity via the command line or definition files from a variety of sources for OCI images and image archives</p></li>
</ul>
</div></blockquote>
<p>The section closes with a brief enumeration of emerging best practices plus consideration of troubleshooting common issues.</p>
</div>
<div class="section" id="running-action-commands-on-public-images-from-docker-hub">
<span id="sec-action-commands-prebuilt-public-docker-images"></span><h2>Running action commands on public images from Docker Hub<a class="headerlink" href="#running-action-commands-on-public-images-from-docker-hub" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">godlovedc/lolcow</span></code> is a whimsical example of a publicly accessible image hosted via <a class="reference external" href="https://hub.docker.com/">Docker Hub</a>. Singularity can execute this image as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity run docker://godlovedc/lolcow
INFO:    Converting OCI blobs to SIF format
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
 45.33 MiB / 45.33 MiB [====================================================] 1s
Copying blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
 848 B / 848 B [============================================================] 0s
Copying blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
 621 B / 621 B [============================================================] 0s
Copying blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
 853 B / 853 B [============================================================] 0s
Copying blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
 169 B / 169 B [============================================================] 0s
Copying blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
 53.75 MiB / 53.75 MiB [====================================================] 2s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: /home/vagrant/.singularity/cache/oci-tmp/a692b57abc43035b197b10390ea2c12855d21649f2ea2cc28094d18b93360eeb/lolcow_latest.sif
INFO:    Image cached as SIF at /home/vagrant/.singularity/cache/oci-tmp/a692b57abc43035b197b10390ea2c12855d21649f2ea2cc28094d18b93360eeb/lolcow_latest.sif
 ___________________________________
/ Repartee is something we think of \
| twenty-four hours too late.       |
|                                   |
\ -- Mark Twain                     /
 -----------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">docker</span></code> is prepended to ensure that the <code class="docutils literal notranslate"><span class="pre">run</span></code> command of Singularity is instructed to boostrap container creation based upon this Docker image, thus creating a complete URI for Singularity. Singularity subsequently downloads <a class="reference internal" href="#sec-oci-overview"><span class="std std-ref">all the OCI blobs that comprise this image</span></a>, and converts them into a <em>single</em> SIF file - the native format for Singularity containers. Because this image from Docker Hub is cached locally in the <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/cache/oci-tmp/&lt;org.opencontainers.image.ref.name&gt;/lolcow_latest.sif</span></code> directory, where <code class="docutils literal notranslate"><span class="pre">&lt;org.opencontainers.image.ref.name&gt;</span></code> will be replaced by the appropriate hash for the container, the image does not need to be downloaded again (from Docker Hub) the next time a Singularity <code class="docutils literal notranslate"><span class="pre">run</span></code> is executed. In other words, the cached copy is sensibly reused:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity run docker://godlovedc/lolcow
 _________________________________________
/ Soap and education are not as sudden as \
| a massacre, but they are more deadly in |
| the long run.                           |
|                                         |
\ -- Mark Twain                           /
 -----------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Image caching is <a class="reference internal" href="#sec-oci-overview"><span class="std std-ref">documented in detail below</span></a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Use is made of the <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity</span></code> directory by default to cache images. To cache images elsewhere, use of the environment variable <code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code> can be made.</p>
</div>
<p>As the runtime of this container is encapsulated as a single SIF file, it is possible to</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd /home/vagrant/.singularity/cache/oci-tmp/a692b57abc43035b197b10390ea2c12855d21649f2ea2cc28094d18b93360eeb/
</pre></div>
</div>
<p>and then execute the SIF file directly:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>./lolcow_latest.sif
 _______________________________________
/ The secret source of humor is not joy \
| but sorrow; there is no humor in      |
| Heaven.                               |
|                                       |
\ -- Mark Twain                         /
 ---------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SIF files abstract Singularity containers as a single file. As with any executable, a SIF file can be executed directly.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">fortune</span> <span class="pre">|</span> <span class="pre">cowsay</span> <span class="pre">|</span> <span class="pre">lolcat</span></code> is executed by <em>default</em> when this container is <code class="docutils literal notranslate"><span class="pre">run</span></code> by Singularity. Singularity’s <code class="docutils literal notranslate"><span class="pre">exec</span></code> command allows a different command to be executed; for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity exec docker://godlovedc/lolcow fortune
Don&#39;t go around saying the world owes you a living.  The world owes you
nothing.  It was here first.
        -- Mark Twain
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <em>same</em> cached copy of the <code class="docutils literal notranslate"><span class="pre">lolcow</span></code> container is reused here by Singularity <code class="docutils literal notranslate"><span class="pre">exec</span></code>, and immediately below here by <code class="docutils literal notranslate"><span class="pre">shell</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Execution defaults are documented below - see <a class="reference internal" href="#sec-def-files-execution"><span class="std std-ref">Directing Execution</span></a> and <a class="reference internal" href="#sec-inspect-container-metadata"><span class="std std-ref">Container Metadata</span></a>.</p>
</div>
<p>In addition to non-interactive execution of an image from Docker Hub, Singularity provides support for an <em>interactive</em> <code class="docutils literal notranslate"><span class="pre">shell</span></code> session:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity shell docker://godlovedc/lolcow
Singularity lolcow_latest.sif:~&gt; cat /etc/os-release
NAME=&quot;Ubuntu&quot;
VERSION=&quot;16.04.3 LTS (Xenial Xerus)&quot;
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME=&quot;Ubuntu 16.04.3 LTS&quot;
VERSION_ID=&quot;16.04&quot;
HOME_URL=&quot;http://www.ubuntu.com/&quot;
SUPPORT_URL=&quot;http://help.ubuntu.com/&quot;
BUG_REPORT_URL=&quot;http://bugs.launchpad.net/ubuntu/&quot;
VERSION_CODENAME=xenial
UBUNTU_CODENAME=xenial
Singularity lolcow_latest.sif:~&gt;
</pre></div>
</div>
<p>From this it is evident that use is being made of Ubuntu 16.04 <em>within</em> this container, whereas the shell <em>external</em> to the container is running a more recent release of Ubuntu (not illustrated here).</p>
<p><code class="docutils literal notranslate"><span class="pre">inspect</span></code> reveals the metadata for a Singularity container encapsulated via SIF; <a class="reference internal" href="#sec-inspect-container-metadata"><span class="std std-ref">Container Metadata</span></a> is documented below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">search</span> <span class="pre">[search</span> <span class="pre">options...]</span> <span class="pre">&lt;search</span> <span class="pre">query&gt;</span></code> does <em>not</em> support Docker registries like <a class="reference external" href="https://hub.docker.com/">Docker Hub</a>. Use the search box at Docker Hub to locate Docker images. Docker <code class="docutils literal notranslate"><span class="pre">pull</span></code> commands, e.g., <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span> <span class="pre">godlovedc/lolcow</span></code>, can be easily translated into the corresponding command for Singularity. The Docker <code class="docutils literal notranslate"><span class="pre">pull</span></code> command is available under “DETAILS” for a given image on Docker Hub.</p>
</div>
</div>
<div class="section" id="making-use-of-public-images-from-docker-hub">
<span id="sec-use-prebuilt-public-docker-images"></span><h2>Making use of public images from Docker Hub<a class="headerlink" href="#making-use-of-public-images-from-docker-hub" title="Permalink to this headline">¶</a></h2>
<p>Singularity can make use of public images available from the <a class="reference external" href="https://hub.docker.com/">Docker Hub</a>. By specifying the <code class="docutils literal notranslate"><span class="pre">docker://</span></code> URI for an image that has already been located, Singularity can <code class="docutils literal notranslate"><span class="pre">pull</span></code>  it - e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull docker://godlovedc/lolcow
WARNING: Authentication token file not found : Only pulls of public images will succeed
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
 45.33 MiB / 45.33 MiB [====================================================] 2s
Copying blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
 848 B / 848 B [============================================================] 0s
Copying blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
 621 B / 621 B [============================================================] 0s
Copying blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
 853 B / 853 B [============================================================] 0s
Copying blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
 169 B / 169 B [============================================================] 0s
Copying blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
 53.75 MiB / 53.75 MiB [====================================================] 3s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_latest.sif
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">pull</span></code> results in a <em>local</em> copy of the Docker image in SIF, the Singularity Image Format:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ file lolcow_latest.sif
lolcow_latest.sif: a /usr/bin/env run-singularity script executable (binary data)
</pre></div>
</div>
<p>In converting to SIF, individual layers of the Docker image have been <em>combined</em> into a single, native file for use by Singularity; there is no need to subsequently <code class="docutils literal notranslate"><span class="pre">build</span></code> the image for Singularity. For example, you can now <code class="docutils literal notranslate"><span class="pre">exec</span></code>, <code class="docutils literal notranslate"><span class="pre">run</span></code> or <code class="docutils literal notranslate"><span class="pre">shell</span></code> into the SIF version via Singularity, <a class="reference internal" href="#sec-action-commands-prebuilt-public-docker-images"><span class="std std-ref">as described above</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The above authentication warning originates from a check for the existence of <code class="docutils literal notranslate"><span class="pre">${HOME}/.singularity/sylabs-token</span></code>. It can be ignored when making use of Docker Hub, or  silenced by issuing <code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">${HOME}/.singularity/sylabs-token</span></code> once.</p>
</div>
<p id="sec-use-prebuilt-public-docker-images-sub-inspect"><code class="docutils literal notranslate"><span class="pre">inspect</span></code> reveals metadata for the container encapsulated via SIF:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity inspect lolcow_latest.sif

{
    &quot;org.label-schema.build-date&quot;: &quot;Thursday_6_December_2018_17:29:48_UTC&quot;,
    &quot;org.label-schema.schema-version&quot;: &quot;1.0&quot;,
    &quot;org.label-schema.usage.singularity.deffile.bootstrap&quot;: &quot;docker&quot;,
    &quot;org.label-schema.usage.singularity.deffile.from&quot;: &quot;godlovedc/lolcow&quot;,
    &quot;org.label-schema.usage.singularity.version&quot;: &quot;3.0.1-40.g84083b4f&quot;
}
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sec-inspect-container-metadata"><span class="std std-ref">Container Metadata</span></a> is documented below.</p>
</div>
<p>SIF files built from Docker images are <em>not</em> crytographically signed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity verify lolcow_latest.sif
Verifying image: lolcow_latest.sif
ERROR:   verification failed: error while searching for signature blocks: no signatures found for system partition
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sign</span></code> command allows a cryptographic signature to be added. Refer to
<a class="reference internal" href="signNverify.html#signnverify"><span class="std std-ref">Signing and Verifying Containers</span></a> for details. But caution
should be exercised in signing images from Docker Hub because, unless you build
an image from scratch (OS mirrors) you are probably not really sure about the
complete contents of that image.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">pull</span></code> is a one-time-only operation that builds a SIF file corresponding to the image retrieved from Docker Hub. Updates to the image on Docker Hub will <em>not</em> be reflected in the <em>local</em> copy.</p>
</div>
<p>In our example <code class="docutils literal notranslate"><span class="pre">docker://godlovedc/lolcow</span></code>, <code class="docutils literal notranslate"><span class="pre">godlovedc</span></code> specifies a Docker Hub user, whereas <code class="docutils literal notranslate"><span class="pre">lolcow</span></code> is the name of the repository. Adding the option to specifiy an image tag, the generic version of the URI is <code class="docutils literal notranslate"><span class="pre">docker://&lt;user&gt;/&lt;repo-name&gt;[:&lt;tag&gt;]</span></code>. <a class="reference external" href="https://docs.docker.com/docker-hub/repos/">Repositories on Docker Hub</a> provides additional details.</p>
</div>
<div class="section" id="making-use-of-private-images-from-docker-hub">
<span id="sec-using-prebuilt-private-images"></span><h2>Making use of private images from Docker Hub<a class="headerlink" href="#making-use-of-private-images-from-docker-hub" title="Permalink to this headline">¶</a></h2>
<p>After successful authentication, Singularity can also make use of <em>private</em> images available from the <a class="reference external" href="https://hub.docker.com/">Docker Hub</a>. The two means available for authentication follow here. Before describing these means, it is instructive to illustate the error generated when attempting access a private image <em>without</em> credentials:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull docker://ilumb/mylolcow
INFO:    Starting build...
FATAL:   Unable to pull docker://ilumb/mylolcow: conveyor failed to get: Error reading manifest latest in docker.io/ilumb/mylolcow: errors:
denied: requested access to the resource is denied
unauthorized: authentication required
</pre></div>
</div>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">mylolcow</span></code> repository of user <code class="docutils literal notranslate"><span class="pre">ilumb</span></code> <strong>requires</strong> authentication through specification of a valid username and password.</p>
<div class="section" id="authentication-via-interactive-login">
<span id="sec-authentication-via-docker-login"></span><h3>Authentication via Interactive Login<a class="headerlink" href="#authentication-via-interactive-login" title="Permalink to this headline">¶</a></h3>
<p>Interactive login is the first of two means provided for authentication with Docker Hub. It is enabled through use of the <code class="docutils literal notranslate"><span class="pre">--docker-login</span></code> option of Singularity’s <code class="docutils literal notranslate"><span class="pre">pull</span></code> command; for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull --docker-login docker://ilumb/mylolcow
Enter Docker Username: ilumb
Enter Docker Password:
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:7b8b6451c85f072fd0d7961c97be3fe6e2f772657d471254f6d52ad9f158a580
Skipping fetch of repeat blob sha256:ab4d1096d9ba178819a3f71f17add95285b393e96d08c8a6bfc3446355bcdc49
Skipping fetch of repeat blob sha256:e6797d1788acd741d33f4530106586ffee568be513d47e6e20a4c9bc3858822e
Skipping fetch of repeat blob sha256:e25c5c290bded5267364aa9f59a18dd22a8b776d7658a41ffabbf691d8104e36
Skipping fetch of repeat blob sha256:258e068bc5e36969d3ba4b47fd3ca0d392c6de465726994f7432b14b0414d23b
Copying config sha256:8a8f815257182b770d32dffff7f185013b4041d076e065893f9dd1e89ad8a671
 3.12 KiB / 3.12 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: mylolcow_latest.sif
</pre></div>
</div>
<p>After successful authentication, the private Docker image is pulled and converted to SIF as described above.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For interactive sessions, <code class="docutils literal notranslate"><span class="pre">--docker-login</span></code> is <em>recommended</em> as use of plain-text passwords in your environment is <em>avoided</em>. Encoded authentication data is communicated with Docker Hub via secure HTTP.</p>
</div>
</div>
<div class="section" id="authentication-via-environment-variables">
<span id="sec-authentication-via-environment-variables"></span><h3>Authentication via Environment Variables<a class="headerlink" href="#authentication-via-environment-variables" title="Permalink to this headline">¶</a></h3>
<p>Environment variables offer an alternative means for authentication with Docker Hub. The <strong>required</strong> exports are as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>export SINGULARITY_DOCKER_USERNAME=ilumb
export SINGULARITY_DOCKER_PASSWORD=&lt;redacted&gt;
</pre></div>
</div>
<p>Of course, the <code class="docutils literal notranslate"><span class="pre">&lt;redacted&gt;</span></code> plain-text password needs to be replaced by a valid one to be of practical use.</p>
<p>Based upon these exports, <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">singularity</span> <span class="pre">pull</span> <span class="pre">docker://ilumb/mylolcow</span></code> allows for the retrieval of this private image.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This approach for authentication supports both interactive and non-interactive sessions. However, the requirement for a plain-text password assigned to an envrionment variable, is the security compromise for this flexibility.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When specifying passwords, ‘special characters’ (e.g., <code class="docutils literal notranslate"><span class="pre">$</span></code>, <code class="docutils literal notranslate"><span class="pre">#</span></code>, <code class="docutils literal notranslate"><span class="pre">.</span></code>) need to be ‘escaped’ to avoid interpretation by the shell.</p>
</div>
</div>
</div>
<div class="section" id="making-use-of-private-images-from-private-registries">
<span id="sec-using-prebuilt-private-images-parivate-registries"></span><h2>Making use of private images from Private Registries<a class="headerlink" href="#making-use-of-private-images-from-private-registries" title="Permalink to this headline">¶</a></h2>
<p>Authentication is required to access <em>private</em> images that reside in Docker Hub. Of course, private images can also reside in <strong>private registries</strong>. Accounting for locations <em>other</em> than Docker Hub is easily achieved.</p>
<p>In the complete command line specification</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>docker://&lt;registry&gt;/&lt;user&gt;/&lt;repo-name&gt;[:&lt;tag&gt;]
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">registry</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">index.docker.io</span></code>. In other words,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull docker://godlovedc/lolcow
</pre></div>
</div>
<p>is functionally equivalent to</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull docker://index.docker.io/godlovedc/lolcow
</pre></div>
</div>
<p>From the above example, it is evident that</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull docker://nvcr.io/nvidia/pytorch:18.11-py3
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:18d680d616571900d78ee1c8fff0310f2a2afe39c6ed0ba2651ff667af406c3e
&lt;blob fetching details deleted&gt;
Skipping fetch of repeat blob sha256:c71aeebc266c779eb4e769c98c935356a930b16d881d7dde4db510a09cfa4222
Copying config sha256:b77551af8073c85588088ab2a39007d04bc830831ba1eef4127b2d39aaf3a6b1
 21.28 KiB / 21.28 KiB [====================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: pytorch_18.11-py3.sif
</pre></div>
</div>
<p>will retrieve a specific version of the <a class="reference external" href="https://pytorch.org/">PyTorch platform</a> for Deep Learning from the NVIDIA GPU Cloud (NGC). Because NGC is a private registry, the above <code class="docutils literal notranslate"><span class="pre">pull</span></code> assumes <a class="reference internal" href="#sec-authentication-via-environment-variables"><span class="std std-ref">authentication via environment variables</span></a> when the blobs that collectively comprise the Docker image have not already been cached locally. In the NGC case, the required environment variable are set as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>export SINGULARITY_DOCKER_USERNAME=&#39;$oauthtoken&#39;
export SINGULARITY_DOCKER_PASSWORD=&lt;redacted&gt;
</pre></div>
</div>
<p>Upon use, these environment-variable settings allow for authentication with NGC.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">$oauthtoken</span></code> is to be taken literally - it is not, for example, an environment variable.</p>
<p>The password provided via these means is actually an API token. This token is generated via your NGC account, and is <strong>required</strong> for use of the service.</p>
<p>For additional details regarding authentication with NGC, and much more, please consult the NGC <a class="reference external" href="https://docs.nvidia.com/ngc/ngc-getting-started-guide/index.html">Getting Started</a> documentation.</p>
</div>
<p>Alternatively, for purely interactive use, <code class="docutils literal notranslate"><span class="pre">--docker-login</span></code> is recommended:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull --docker-login docker://nvcr.io/nvidia/pytorch:18.11-py3
Enter Docker Username: $oauthtoken
Enter Docker Password:
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:18d680d616571900d78ee1c8fff0310f2a2afe39c6ed0ba2651ff667af406c3e
&lt;blob fetching details deleted&gt;
Skipping fetch of repeat blob sha256:c71aeebc266c779eb4e769c98c935356a930b16d881d7dde4db510a09cfa4222
Copying config sha256:b77551af8073c85588088ab2a39007d04bc830831ba1eef4127b2d39aaf3a6b1
21.28 KiB / 21.28 KiB [====================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: pytorch_18.11-py3.sif
</pre></div>
</div>
<p>Authentication aside, the outcome of the <code class="docutils literal notranslate"><span class="pre">pull</span></code> command is the Singularity container <code class="docutils literal notranslate"><span class="pre">pytorch_18.11-py3.sif</span></code> - i.e., a locally stored copy, that has been coverted to SIF.</p>
</div>
<div class="section" id="building-images-for-singularity-from-docker-registries">
<h2>Building images for Singularity from Docker Registries<a class="headerlink" href="#building-images-for-singularity-from-docker-registries" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">build</span></code> command is used to <strong>create</strong> Singularity containers. Because it is documented extensively <a class="reference internal" href="build_a_container.html#build-a-container"><span class="std std-ref">elsewhere in this manual</span></a>, only specifics relevant to Docker are provided here - namely, working with Docker Hub via <a class="reference internal" href="#sec-singularity-build-cli"><span class="std std-ref">the Singularity command line</span></a> and through <a class="reference internal" href="#sec-singularity-build-def-files"><span class="std std-ref">Singularity definition files</span></a>.</p>
<div class="section" id="working-from-the-singularity-command-line">
<span id="sec-singularity-build-cli"></span><h3>Working from the Singularity Command Line<a class="headerlink" href="#working-from-the-singularity-command-line" title="Permalink to this headline">¶</a></h3>
<div class="section" id="remotely-hosted-images">
<h4>Remotely Hosted Images<a class="headerlink" href="#remotely-hosted-images" title="Permalink to this headline">¶</a></h4>
<p>In the simplest case, <code class="docutils literal notranslate"><span class="pre">build</span></code> is functionally equivalent to <code class="docutils literal notranslate"><span class="pre">pull</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build mylolcow_latest.sif docker://godlovedc/lolcow
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
Skipping fetch of repeat blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
Skipping fetch of repeat blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
Skipping fetch of repeat blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
Skipping fetch of repeat blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
Skipping fetch of repeat blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: mylolcow_latest.sif
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">build</span></code> results in a <em>local</em> copy of the Docker image in SIF, as did <code class="docutils literal notranslate"><span class="pre">pull</span></code> <a class="reference internal" href="#sec-use-prebuilt-public-docker-images"><span class="std std-ref">above</span></a>. Here, <code class="docutils literal notranslate"><span class="pre">build</span></code> has named the Singularity container <code class="docutils literal notranslate"><span class="pre">mylolcow_latest.sif</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">docker://godlovedc/lolcow</span></code> is the <strong>target</strong> provided as input for <code class="docutils literal notranslate"><span class="pre">build</span></code>. Armed with this target, <code class="docutils literal notranslate"><span class="pre">build</span></code> applies the appropriate boostrap agent to create the container - in this case, one appropriate for Docker Hub.</p>
</div>
<p>In addition to a read-only container image in SIF (<strong>default</strong>), <code class="docutils literal notranslate"><span class="pre">build</span></code> allows for the creation of a writable (ch)root <em>directory</em> called a <strong>sandbox</strong> for interactive development via the <code class="docutils literal notranslate"><span class="pre">--sandbox</span></code> option:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build --sandbox mylolcow_latest_sandbox docker://godlovedc/lolcow
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
Skipping fetch of repeat blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
Skipping fetch of repeat blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
Skipping fetch of repeat blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
Skipping fetch of repeat blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
Skipping fetch of repeat blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating sandbox directory...
INFO:    Build complete: mylolcow_latest_sandbox
</pre></div>
</div>
<p>After successful execution, the above command results in creation of the <code class="docutils literal notranslate"><span class="pre">mylolcow_latest_sandbox</span></code> directory with contents:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>bin  boot  core  dev  environment  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  singularity  srv  sys  tmp  usr  var
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">build</span></code> command of Singularity allows (e.g., development) sandbox containers to be converted into (e.g., production) read-only SIF containers, and vice-versa. Consult the <a class="reference internal" href="build_a_container.html#build-a-container"><span class="std std-ref">Build a container</span></a> documentation for the details.</p>
<p>Implicit in the above command-line interactions is use of public images from Docker Hub. To make use of <strong>private</strong> images from Docker Hub, authentication is required. Available means for authentication were described above. Use of environment variables is functionally equivalent for Singularity <code class="docutils literal notranslate"><span class="pre">build</span></code> as it is for <code class="docutils literal notranslate"><span class="pre">pull</span></code>; see <a class="reference internal" href="#sec-authentication-via-environment-variables"><span class="std std-ref">Authentication via Environment Variables</span></a> above. For purely interactive use, authentication can be added to the <code class="docutils literal notranslate"><span class="pre">build</span></code> command as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>singularity build --docker-login mylolcow_latest_il.sif docker://ilumb/mylolcow
</pre></div>
</div>
<p>(Recall that <code class="docutils literal notranslate"><span class="pre">docker://ilumb/mylolcow</span></code> is a private image available via Docker Hub.) See <a class="reference internal" href="#sec-authentication-via-docker-login"><span class="std std-ref">Authentication via Interactive Login</span></a> above regarding use of <code class="docutils literal notranslate"><span class="pre">--docker-login</span></code>.</p>
</div>
<div class="section" id="building-containers-remotely">
<h4>Building Containers Remotely<a class="headerlink" href="#building-containers-remotely" title="Permalink to this headline">¶</a></h4>
<p>By making use of the <a class="reference external" href="https://cloud.sylabs.io/builder">Sylabs Cloud Remote Builder</a>, it is possible to build SIF containers <em>remotely</em> from images hosted at Docker Hub. The Sylabs Cloud Remote Builder is a <strong>service</strong> that can be used from the Singularity command line or via its Web interface. Here use of the Singularity CLI is emphasized.</p>
<p>Once you have an account for Sylabs Cloud, and have logged in to the portal, select <a class="reference external" href="https://cloud.sylabs.io/builder">Remote Builder</a>. The right-hand side of this page is devoted to use of the Singularity CLI. Self-generated API tokens are used to enable authenticated access to the Remote Builder. To create a token, follow the <a class="reference external" href="https://cloud.sylabs.io/auth/tokens">instructions provided</a>. Once the token has been created, store it in the file <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/sylabs-token</span></code>.</p>
<p>The above token provides <em>authenticated</em> use of the Sylabs Cloud Remote Builder when <code class="docutils literal notranslate"><span class="pre">--remote</span></code> is <em>appended</em> to the Singularity <code class="docutils literal notranslate"><span class="pre">build</span></code> command. For example, for remotely hosted images:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build --remote lolcow_rb.sif docker://godlovedc/lolcow
searching for available build agent.........INFO:    Starting build...
Getting image source signatures
Copying blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
 45.33 MiB / 45.33 MiB  0s
Copying blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
 848 B / 848 B  0s
Copying blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
 621 B / 621 B  0s
Copying blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
 853 B / 853 B  0s
Copying blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
 169 B / 169 B  0s
Copying blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
 53.75 MiB / 53.75 MiB  0s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB  0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: /tmp/image-341891107
INFO:    Now uploading /tmp/image-341891107 to the library
 87.94 MiB / 87.94 MiB  100.00% 38.96 MiB/s 2s
INFO:    Setting tag latest
 87.94 MiB / 87.94 MiB [===============================================================================] 100.00% 17.23 MiB/s 5s
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Elevated privileges (e.g., via <code class="docutils literal notranslate"><span class="pre">sudo</span></code>) are <em>not</em> required when use is made of the Sylabs Cloud Remote Builder.</p>
</div>
<p>During the build process, progress can be monitored in the Sylabs Cloud portal on the Remote Builder page - as illustrated upon completion by the screenshot below. Once complete, this results in a <em>local</em> copy of the SIF file <code class="docutils literal notranslate"><span class="pre">lolcow_rb.sif</span></code>. From the <a class="reference external" href="https://cloud.sylabs.io/library">Sylabs Cloud Singularity Library</a> it is evident that the ‘original’ SIF file remains available via this portal.</p>
<img alt="_images/lolcow_sylabsrb.png" src="_images/lolcow_sylabsrb.png" />
</div>
<div class="section" id="locally-available-images-cached-by-docker">
<span id="sec-mandatory-headers-docker-locally-boostrapped-cli"></span><h4>Locally Available Images: Cached by Docker<a class="headerlink" href="#locally-available-images-cached-by-docker" title="Permalink to this headline">¶</a></h4>
<p>Singularity containers can be built at the command line from images cached <em>locally</em> by Docker. Suppose, for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
godlovedc/lolcow    latest              577c1fe8e6d8        16 months ago       241MB
</pre></div>
</div>
<p>This indicates that <code class="docutils literal notranslate"><span class="pre">godlovedc/lolcow:latest</span></code> has been cached locally by Docker. Then</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build lolcow_from_docker_cache.sif docker-daemon://godlovedc/lolcow:latest
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:a2022691bf950a72f9d2d84d557183cb9eee07c065a76485f1695784855c5193
 119.83 MiB / 119.83 MiB [==================================================] 6s
Copying blob sha256:ae620432889d2553535199dbdd8ba5a264ce85fcdcd5a430974d81fc27c02b45
 15.50 KiB / 15.50 KiB [====================================================] 0s
Copying blob sha256:c561538251751e3685c7c6e7479d488745455ad7f84e842019dcb452c7b6fecc
 14.50 KiB / 14.50 KiB [====================================================] 0s
Copying blob sha256:f96e6b25195f1b36ad02598b5d4381e41997c93ce6170cab1b81d9c68c514db0
 5.50 KiB / 5.50 KiB [======================================================] 0s
Copying blob sha256:7f7a065d245a6501a782bf674f4d7e9d0a62fa6bd212edbf1f17bad0d5cd0bfc
 3.00 KiB / 3.00 KiB [======================================================] 0s
Copying blob sha256:70ca7d49f8e9c44705431e3dade0636a2156300ae646ff4f09c904c138728839
 116.56 MiB / 116.56 MiB [==================================================] 6s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_from_docker_cache.sif
</pre></div>
</div>
<p>results in <code class="docutils literal notranslate"><span class="pre">lolcow_from_docker_cache.sif</span></code> for native use by Singularity. There are two important differences in syntax evident in the above <code class="docutils literal notranslate"><span class="pre">build</span></code> command:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">docker</span></code> part of the URI has been appended by <code class="docutils literal notranslate"><span class="pre">daemon</span></code>. This ensures Singularity seek an image locally cached by Docker to boostrap the conversion process to SIF, as opposed to attempting to retrieve an image remotely hosted via Docker Hub.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span></code> is prepended to the <code class="docutils literal notranslate"><span class="pre">build</span></code> command for Singularity; this is required as the Docker daemon executes as <code class="docutils literal notranslate"><span class="pre">root</span></code>. However, if the user issuing the <code class="docutils literal notranslate"><span class="pre">build</span></code> command is a member of the <code class="docutils literal notranslate"><span class="pre">docker</span></code> Linux group, then <code class="docutils literal notranslate"><span class="pre">sudo</span></code> need not be prepended.</p></li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The image tag, in this case <code class="docutils literal notranslate"><span class="pre">latest</span></code>, is <strong>required</strong> when bootstrapping creation of a container for Singularity from an image locally cached by Docker.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Sylabs Cloud Remote Builder <em>does not</em> interoperate with local Docker daemons; therefore, images cached locally by Docker, <em>cannot</em> be used to bootstrap creation of SIF files via the Remote Builder service. Of course, a SIF file could be created locally as detailed above. Then, in a separate, manual step, <a class="reference internal" href="#sec-pushing-locally-available-images-to-library"><span class="std std-ref">pushed to the Sylabs Cloud Singularity Library</span></a>.</p>
</div>
</div>
<div class="section" id="locally-available-images-stored-archives">
<span id="sec-mandatory-headers-docker-locally-stored-bootstrap-cli"></span><h4>Locally Available Images: Stored Archives<a class="headerlink" href="#locally-available-images-stored-archives" title="Permalink to this headline">¶</a></h4>
<p>Singularity containers can also be built at the command line from Docker images stored locally as <code class="docutils literal notranslate"><span class="pre">tar</span></code> files.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">lolcow.tar</span></code> file employed below in this example can be produced by making use of an environment in which Docker is available as follows:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Obtain a local copy of the image from Docker Hub via <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">docker</span> <span class="pre">pull</span> <span class="pre">godlovedc/lolcow</span></code>. Issuing the following command confirms that a copy of the desired image is available locally:</p></li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
godlovedc/lolcow    latest              577c1fe8e6d8        17 months ago       241MB
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Noting that the image identifier above is <code class="docutils literal notranslate"><span class="pre">577c1fe8e6d8</span></code>, the required archive can be created by <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">docker</span> <span class="pre">save</span> <span class="pre">577c1fe8e6d8</span> <span class="pre">-o</span> <span class="pre">lolcow.tar</span></code>.</p></li>
</ol>
</div></blockquote>
<p>Thus <code class="docutils literal notranslate"><span class="pre">lolcow.tar</span></code> is a locally stored archive in the <em>current</em> working directory with contents:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo tar tvf lolcow.tar
drwxr-xr-x 0/0               0 2017-09-21 19:37 02aefa059d08482d344293d0ad27182a0a9d330ebc73abd92a1f9744844f91e9/
-rw-r--r-- 0/0               3 2017-09-21 19:37 02aefa059d08482d344293d0ad27182a0a9d330ebc73abd92a1f9744844f91e9/VERSION
-rw-r--r-- 0/0            1417 2017-09-21 19:37 02aefa059d08482d344293d0ad27182a0a9d330ebc73abd92a1f9744844f91e9/json
-rw-r--r-- 0/0       122219008 2017-09-21 19:37 02aefa059d08482d344293d0ad27182a0a9d330ebc73abd92a1f9744844f91e9/layer.tar
drwxr-xr-x 0/0               0 2017-09-21 19:37 3762e087ebbb895fd9c38981c1f7bfc76c9879fd3fdadef64df49e92721bb527/
-rw-r--r-- 0/0               3 2017-09-21 19:37 3762e087ebbb895fd9c38981c1f7bfc76c9879fd3fdadef64df49e92721bb527/VERSION
-rw-r--r-- 0/0             482 2017-09-21 19:37 3762e087ebbb895fd9c38981c1f7bfc76c9879fd3fdadef64df49e92721bb527/json
-rw-r--r-- 0/0           14848 2017-09-21 19:37 3762e087ebbb895fd9c38981c1f7bfc76c9879fd3fdadef64df49e92721bb527/layer.tar
-rw-r--r-- 0/0            4432 2017-09-21 19:37 577c1fe8e6d84360932b51767b65567550141af0801ff6d24ad10963e40472c5.json
drwxr-xr-x 0/0               0 2017-09-21 19:37 5bad884501c0e760bc0c9ca3ae3dca3f12c4abeb7d18194c364fec522b91b4f9/
-rw-r--r-- 0/0               3 2017-09-21 19:37 5bad884501c0e760bc0c9ca3ae3dca3f12c4abeb7d18194c364fec522b91b4f9/VERSION
-rw-r--r-- 0/0             482 2017-09-21 19:37 5bad884501c0e760bc0c9ca3ae3dca3f12c4abeb7d18194c364fec522b91b4f9/json
-rw-r--r-- 0/0            3072 2017-09-21 19:37 5bad884501c0e760bc0c9ca3ae3dca3f12c4abeb7d18194c364fec522b91b4f9/layer.tar
drwxr-xr-x 0/0               0 2017-09-21 19:37 81ce2fd011bc8241ae72eaee9146116b7c289e941467ff276397720171e6c576/
-rw-r--r-- 0/0               3 2017-09-21 19:37 81ce2fd011bc8241ae72eaee9146116b7c289e941467ff276397720171e6c576/VERSION
-rw-r--r-- 0/0             406 2017-09-21 19:37 81ce2fd011bc8241ae72eaee9146116b7c289e941467ff276397720171e6c576/json
-rw-r--r-- 0/0       125649920 2017-09-21 19:37 81ce2fd011bc8241ae72eaee9146116b7c289e941467ff276397720171e6c576/layer.tar
drwxr-xr-x 0/0               0 2017-09-21 19:37 a10239905b060fd8b17ab31f37957bd126774f52f5280767d3b2639692913499/
-rw-r--r-- 0/0               3 2017-09-21 19:37 a10239905b060fd8b17ab31f37957bd126774f52f5280767d3b2639692913499/VERSION
-rw-r--r-- 0/0             482 2017-09-21 19:37 a10239905b060fd8b17ab31f37957bd126774f52f5280767d3b2639692913499/json
-rw-r--r-- 0/0           15872 2017-09-21 19:37 a10239905b060fd8b17ab31f37957bd126774f52f5280767d3b2639692913499/layer.tar
drwxr-xr-x 0/0               0 2017-09-21 19:37 ab6e1ca3392b2f4dbb60157cf99434b6975f37a767f530e293704a7348407634/
-rw-r--r-- 0/0               3 2017-09-21 19:37 ab6e1ca3392b2f4dbb60157cf99434b6975f37a767f530e293704a7348407634/VERSION
-rw-r--r-- 0/0             482 2017-09-21 19:37 ab6e1ca3392b2f4dbb60157cf99434b6975f37a767f530e293704a7348407634/json
-rw-r--r-- 0/0            5632 2017-09-21 19:37 ab6e1ca3392b2f4dbb60157cf99434b6975f37a767f530e293704a7348407634/layer.tar
-rw-r--r-- 0/0             574 1970-01-01 01:00 manifest.json
</pre></div>
</div>
<p>In other words, it is evident that this ‘tarball’ is a Docker-format image comprised of multiple layers along with metadata in a JSON manifest.</p>
<p>Through use of the <code class="docutils literal notranslate"><span class="pre">docker-archive</span></code> bootstrap agent, a SIF file (<code class="docutils literal notranslate"><span class="pre">lolcow_tar.sif</span></code>) for use by Singularity can be created via the following <code class="docutils literal notranslate"><span class="pre">build</span></code> command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build lolcow_tar.sif docker-archive://lolcow.tar
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:a2022691bf950a72f9d2d84d557183cb9eee07c065a76485f1695784855c5193
 119.83 MiB / 119.83 MiB [==================================================] 6s
Copying blob sha256:ae620432889d2553535199dbdd8ba5a264ce85fcdcd5a430974d81fc27c02b45
 15.50 KiB / 15.50 KiB [====================================================] 0s
Copying blob sha256:c561538251751e3685c7c6e7479d488745455ad7f84e842019dcb452c7b6fecc
 14.50 KiB / 14.50 KiB [====================================================] 0s
Copying blob sha256:f96e6b25195f1b36ad02598b5d4381e41997c93ce6170cab1b81d9c68c514db0
 5.50 KiB / 5.50 KiB [======================================================] 0s
Copying blob sha256:7f7a065d245a6501a782bf674f4d7e9d0a62fa6bd212edbf1f17bad0d5cd0bfc
 3.00 KiB / 3.00 KiB [======================================================] 0s
Copying blob sha256:70ca7d49f8e9c44705431e3dade0636a2156300ae646ff4f09c904c138728839
 116.56 MiB / 116.56 MiB [==================================================] 6s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_tar.sif
</pre></div>
</div>
<p>There are two important differences in syntax evident in the above <code class="docutils literal notranslate"><span class="pre">build</span></code> command:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">docker</span></code> part of the URI has been appended by <code class="docutils literal notranslate"><span class="pre">archive</span></code>. This ensures Singularity seek a Docker-format image archive stored locally as <code class="docutils literal notranslate"><span class="pre">lolcow.tar</span></code> to boostrap the conversion process to SIF, as opposed to attempting to retrieve an image remotely hosted via Docker Hub.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span></code> is <em>not</em> prepended to the <code class="docutils literal notranslate"><span class="pre">build</span></code> command for Singularity. This is <em>not</em> required if the executing user has the appropriate access privileges to the stored file.</p></li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">docker-archive</span></code> bootstrap agent handles archives (<code class="docutils literal notranslate"><span class="pre">.tar</span></code> files) as well as compressed archives (<code class="docutils literal notranslate"><span class="pre">.tar.gz</span></code>) when containers are built for Singularity via its <code class="docutils literal notranslate"><span class="pre">build</span></code> command.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Sylabs Cloud Remote Builder <em>does not</em> interoperate with locally stored Docker-format images; therefore, images cached locally by Docker, <em>cannot</em> be used to bootstrap creation of SIF files via the Remote Builder service. Of course, a SIF file could be created locally as detailed above. Then, in a separate, manual step, <a class="reference internal" href="#sec-pushing-locally-available-images-to-library"><span class="std std-ref">pushed to the Sylabs Cloud Singularity Library</span></a>.</p>
</div>
</div>
<div class="section" id="pushing-locally-available-images-to-a-library">
<span id="sec-pushing-locally-available-images-to-library"></span><h4>Pushing Locally Available Images to a Library<a class="headerlink" href="#pushing-locally-available-images-to-a-library" title="Permalink to this headline">¶</a></h4>
<p>The outcome of bootstrapping from an image cached locally by Docker, or one stored locally as an archive, is of course a <em>locally</em> stored SIF file. As noted above, this is the <em>only</em> option available, as the Sylabs Cloud Remote Builder <em>does not</em> interoperate with the Docker daemon or locally stored archives in the Docker image format. Once produced, however, it may be desirable to  make the resulting SIF file available through the Sylabs Cloud Singularity Library; therefore, the procedure to <code class="docutils literal notranslate"><span class="pre">push</span></code> a locally available SIF file to the Library is detailed here.</p>
<p>From the <a class="reference external" href="https://cloud.sylabs.io/library">Sylabs Cloud Singularity Library</a>, select <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">a</span> <span class="pre">new</span> <span class="pre">Project</span></code>. In this first of two steps, the publicly accessible project is created as illustrated below:</p>
<img alt="_images/create_project.png" src="_images/create_project.png" />
<p>Because an access token for the cloud service already exists, attention can be focused on the <code class="docutils literal notranslate"><span class="pre">push</span></code> command prototyped towards the bottom of the following screenshot:</p>
<img alt="_images/push_prototype.png" src="_images/push_prototype.png" />
<p>In fact, by simply replacing <code class="docutils literal notranslate"><span class="pre">image.sif</span></code> with <code class="docutils literal notranslate"><span class="pre">lolcow_tar.sif</span></code>, the following upload is executed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity push lolcow_tar.sif library://ilumb/default/lolcow_tar
INFO:    Now uploading lolcow_tar.sif to the library
 87.94 MiB / 87.94 MiB [=============================================================================] 100.00% 1.25 MiB/s 1m10s
INFO:    Setting tag latest
</pre></div>
</div>
<p>Finally, from the perspective of the Library, the <em>hosted</em> version of the SIF file appears as illustrated below. Directions on how to <code class="docutils literal notranslate"><span class="pre">pull</span></code> this file are included from the portal.</p>
<img alt="_images/lolcow_lib_listing.png" src="_images/lolcow_lib_listing.png" />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The hosted version of the SIF file in the Sylabs Cloud Singularity Library is maintainable. In other words, if the image is updated locally, the update can be pushed to the Library and tagged appropriately.</p>
</div>
</div>
</div>
<div class="section" id="working-with-definition-files">
<span id="sec-singularity-build-def-files"></span><h3>Working with Definition Files<a class="headerlink" href="#working-with-definition-files" title="Permalink to this headline">¶</a></h3>
<div class="section" id="mandatory-header-keywords-remotely-boostrapped">
<span id="sec-def-file-mandatory-headers-remotely-boostrapped"></span><h4>Mandatory Header Keywords: Remotely Boostrapped<a class="headerlink" href="#mandatory-header-keywords-remotely-boostrapped" title="Permalink to this headline">¶</a></h4>
<p>Akin to a set of blueprints that explain how to build a custom container, Singularity definition files (or “def files”) are considered in detail <span class="xref std std-ref">elsewhere in this manual</span>. Therefore, only def file nuances specific to interoperability with Docker receive consideration here.</p>
<p>Singularity definition files are comprised of two parts - a <strong>header</strong> plus <strong>sections</strong>.</p>
<p>When working with repositories such as Docker Hub, <code class="docutils literal notranslate"><span class="pre">Bootstrap</span></code> and <code class="docutils literal notranslate"><span class="pre">From</span></code> are <strong>mandatory</strong> keywords within the header; for example, if the file <code class="docutils literal notranslate"><span class="pre">lolcow.def</span></code> has contents</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: godlovedc/lolcow
</pre></div>
</div>
<p>then</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo singularity build lolcow.sif lolcow.def
</pre></div>
</div>
<p>creates a Singularity container in SIF by bootstrapping from the public <code class="docutils literal notranslate"><span class="pre">godlovedc/lolcow</span></code> image from Docker Hub.</p>
<p>In the above definition file, <code class="docutils literal notranslate"><span class="pre">docker</span></code> is one of numerous, possible bootstrap agents; this, and other bootstrap agents receive attention <a class="reference internal" href="appendix.html#build-docker-module"><span class="std std-ref">in the appendix</span></a>.</p>
<p>Through <a class="reference internal" href="#sec-using-prebuilt-private-images"><span class="std std-ref">the means for authentication described above</span></a>, definition files permit use of private images hosted via Docker Hub. For example, if the file <code class="docutils literal notranslate"><span class="pre">mylolcow.def</span></code> has contents</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: ilumb/mylolcow
</pre></div>
</div>
<p>then</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sudo singularity build --docker-login mylolcow.sif mylolcow.def
</pre></div>
</div>
<p>creates a Singularity container in SIF by bootstrapping from the <em>private</em> <code class="docutils literal notranslate"><span class="pre">ilumb/mylolcow</span></code> image from Docker Hub after successful <a class="reference internal" href="#sec-authentication-via-docker-login"><span class="std std-ref">interactive authentication</span></a>.</p>
<p>Alternatively, if <a class="reference internal" href="#sec-authentication-via-environment-variables"><span class="std std-ref">environment variables have been set as above</span></a>, then</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo -E singularity build mylolcow.sif mylolcow.def
</pre></div>
</div>
<p>enables authenticated use of the private image.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-E</span></code> option is required to preserve the user’s existing environment variables upon <code class="docutils literal notranslate"><span class="pre">sudo</span></code> invocation - a priviledge escalation <em>required</em> to create Singularity containers via the <code class="docutils literal notranslate"><span class="pre">build</span></code> command.</p>
</div>
</div>
<div class="section" id="remotely-bootstrapped-and-built-containers">
<h4>Remotely Bootstrapped and Built Containers<a class="headerlink" href="#remotely-bootstrapped-and-built-containers" title="Permalink to this headline">¶</a></h4>
<p>Consider again <a class="reference internal" href="#sec-def-file-mandatory-headers-remotely-boostrapped"><span class="std std-ref">the definition file used the outset of the section above</span></a>:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: godlovedc/lolcow
</pre></div>
</div>
<p>With two small adjustments to the Singularity <code class="docutils literal notranslate"><span class="pre">build</span></code> command, the Sylabs Cloud Remote Builder can be utilized:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build --remote lolcow_rb_def.sif lolcow.def
searching for available build agent......INFO:    Starting build...
Getting image source signatures
Copying blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
 45.33 MiB / 45.33 MiB  0s
Copying blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
 848 B / 848 B  0s
Copying blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
 621 B / 621 B  0s
Copying blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
 853 B / 853 B  0s
Copying blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
 169 B / 169 B  0s
Copying blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
 53.75 MiB / 53.75 MiB  0s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB  0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: /tmp/image-994007654
INFO:    Now uploading /tmp/image-994007654 to the library
 87.94 MiB / 87.94 MiB  100.00% 41.76 MiB/s 2s
INFO:    Setting tag latest
 87.94 MiB / 87.94 MiB [===============================================================================] 100.00% 19.08 MiB/s 4s
</pre></div>
</div>
<p>In the above, <code class="docutils literal notranslate"><span class="pre">--remote</span></code> has been added as the <code class="docutils literal notranslate"><span class="pre">build</span></code> option that causes use of the Remote Builder service. A much more subtle change, however, is the <em>absence</em> of <code class="docutils literal notranslate"><span class="pre">sudo</span></code> ahead of <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">build</span></code>. Though subtle here, this absence is notable, as users can build containers via the Remote Builder with <em>escalated privileges</em>; in other words, steps in container creation that <em>require</em> <code class="docutils literal notranslate"><span class="pre">root</span></code> access <em>are</em> enabled via the Remote Builder even for (DevOps) users <em>without</em> admninistrative privileges locally.</p>
<p>In addition to the command-line support described above, the Sylabs Cloud Remote Builder also allows definition files to be copied and pasted into its Graphical User Interface (GUI). After pasting a definition file, and having that file validated by the service, the build-centric part of the GUI appears as illustrated below. By clicking on the <code class="docutils literal notranslate"><span class="pre">Build</span></code> button, creation of the container is initiated.</p>
<img alt="_images/build_gui.png" src="_images/build_gui.png" />
<p>Once the build process has been completed, the corresponding SIF file can be retrieved from the service - as shown below. A log file for the <code class="docutils literal notranslate"><span class="pre">build</span></code> process is provided by the GUI, and made available for download as a text file (not shown here).</p>
<img alt="_images/build_output.png" src="_images/build_output.png" />
<p>A copy of the SIF file created by the service remains in the Sylabs Cloud Singularity Library as illustrated below.</p>
<img alt="_images/mysylabslibrary.png" src="_images/mysylabslibrary.png" />
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Sylabs Cloud is currently available as an Alpha Preview. In addition to the Singularity Library and Remote Builder, a Keystore service is also available. All three services make use of a <em>freemium</em> pricing model in supporting Singularity Community Edition. In contrast, all three services are included in SingularityPRO - an enterprise grade subscription for Singularity that is offered for a fee from Sylabs. For addtional details regarding the different offerings available for Singularity, please <a class="reference external" href="https://www.sylabs.io/singularity/">consult the Sylabs website</a>.</p>
</div>
</div>
<div class="section" id="mandatory-header-keywords-locally-boostrapped">
<span id="sec-mandatory-headers-docker-locally-boostrapped-def-file"></span><h4>Mandatory Header Keywords: Locally Boostrapped<a class="headerlink" href="#mandatory-header-keywords-locally-boostrapped" title="Permalink to this headline">¶</a></h4>
<p>When <code class="docutils literal notranslate"><span class="pre">docker-daemon</span></code> is the bootstrap agent in a Singularity definition file, SIF containers can be created from images cached locally by Docker. Suppose the definition file <code class="docutils literal notranslate"><span class="pre">lolcow-d.def</span></code> has contents:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker-daemon
<span class="k">From</span>: godlovedc/lolcow:latest
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Again, the image tag <code class="docutils literal notranslate"><span class="pre">latest</span></code> is <strong>required</strong> when bootstrapping creation of a container for Singularity from an image locally cached by Docker.</p>
</div>
<p>Then,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build lolcow_from_docker_cache.sif lolcow-d.def
Build target already exists. Do you want to overwrite? [N/y] y
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:a2022691bf950a72f9d2d84d557183cb9eee07c065a76485f1695784855c5193
 119.83 MiB / 119.83 MiB [==================================================] 6s
Copying blob sha256:ae620432889d2553535199dbdd8ba5a264ce85fcdcd5a430974d81fc27c02b45
 15.50 KiB / 15.50 KiB [====================================================] 0s
Copying blob sha256:c561538251751e3685c7c6e7479d488745455ad7f84e842019dcb452c7b6fecc
 14.50 KiB / 14.50 KiB [====================================================] 0s
Copying blob sha256:f96e6b25195f1b36ad02598b5d4381e41997c93ce6170cab1b81d9c68c514db0
 5.50 KiB / 5.50 KiB [======================================================] 0s
Copying blob sha256:7f7a065d245a6501a782bf674f4d7e9d0a62fa6bd212edbf1f17bad0d5cd0bfc
 3.00 KiB / 3.00 KiB [======================================================] 0s
Copying blob sha256:70ca7d49f8e9c44705431e3dade0636a2156300ae646ff4f09c904c138728839
 116.56 MiB / 116.56 MiB [==================================================] 6s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_from_docker_cache.sif
</pre></div>
</div>
<p>In other words, this is the definition-file counterpart to <a class="reference internal" href="#sec-mandatory-headers-docker-locally-boostrapped-cli"><span class="std std-ref">the command-line invocation provided above</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sudo</span></code> requirement in the above <code class="docutils literal notranslate"><span class="pre">build</span></code> request originates from Singularity; it is the standard requirement when use is made of definition files. In other words, membership of the issuing user in the <code class="docutils literal notranslate"><span class="pre">docker</span></code> Linux group is of no consequence in this context.</p>
</div>
<p>Alternatively when <code class="docutils literal notranslate"><span class="pre">docker-archive</span></code> is the bootstrap agent in a Singularity definition file, SIF containers can be created from images stored locally by Docker. Suppose the definition file <code class="docutils literal notranslate"><span class="pre">lolcow-da.def</span></code> has contents:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker-archive
<span class="k">From</span>: lolcow.tar
</pre></div>
</div>
<p>Then,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build lolcow_tar_def.sif lolcow-da.def
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:a2022691bf950a72f9d2d84d557183cb9eee07c065a76485f1695784855c5193
 119.83 MiB / 119.83 MiB [==================================================] 6s
Copying blob sha256:ae620432889d2553535199dbdd8ba5a264ce85fcdcd5a430974d81fc27c02b45
 15.50 KiB / 15.50 KiB [====================================================] 0s
Copying blob sha256:c561538251751e3685c7c6e7479d488745455ad7f84e842019dcb452c7b6fecc
 14.50 KiB / 14.50 KiB [====================================================] 0s
Copying blob sha256:f96e6b25195f1b36ad02598b5d4381e41997c93ce6170cab1b81d9c68c514db0
 5.50 KiB / 5.50 KiB [======================================================] 0s
Copying blob sha256:7f7a065d245a6501a782bf674f4d7e9d0a62fa6bd212edbf1f17bad0d5cd0bfc
 3.00 KiB / 3.00 KiB [======================================================] 0s
Copying blob sha256:70ca7d49f8e9c44705431e3dade0636a2156300ae646ff4f09c904c138728839
 116.56 MiB / 116.56 MiB [==================================================] 6s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_tar_def.sif
</pre></div>
</div>
<p>through <code class="docutils literal notranslate"><span class="pre">build</span></code> results in the SIF file <code class="docutils literal notranslate"><span class="pre">lolcow_tar_def.sif</span></code>. In other words, this is the definition-file counterpart to <a class="reference internal" href="#sec-mandatory-headers-docker-locally-stored-bootstrap-cli"><span class="std std-ref">the command-line invocation provided above</span></a> .</p>
</div>
<div class="section" id="optional-header-keywords">
<span id="sec-optional-headers-def-files"></span><h4>Optional Header Keywords<a class="headerlink" href="#optional-header-keywords" title="Permalink to this headline">¶</a></h4>
<p>In the two-previous examples, the <code class="docutils literal notranslate"><span class="pre">From</span></code> keyword specifies <em>both</em> the <code class="docutils literal notranslate"><span class="pre">user</span></code> and <code class="docutils literal notranslate"><span class="pre">repo-name</span></code> in making use of Docker Hub. <em>Optional</em> use of <code class="docutils literal notranslate"><span class="pre">Namespace</span></code> permits the more-granular split across two keywords:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">Namespace</span>: godlovedc
<span class="k">From</span>: lolcow
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In <a class="reference external" href="https://docs.docker.com/docker-hub/repos/">their documentation</a>, “Docker ID namespace” and <code class="docutils literal notranslate"><span class="pre">user</span></code> are employed as synonyms in the text and examples, respectively.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default value for the optional keyword <code class="docutils literal notranslate"><span class="pre">Namespace</span></code> is <code class="docutils literal notranslate"><span class="pre">library</span></code>.</p>
</div>
</div>
<div class="section" id="private-images-and-registries">
<h4>Private Images and Registries<a class="headerlink" href="#private-images-and-registries" title="Permalink to this headline">¶</a></h4>
<p>Thus far, use of Docker Hub has been assumed. To make use of a different repository of Docker images the <strong>optional</strong> <code class="docutils literal notranslate"><span class="pre">Registry</span></code> keyword can be added to the Singularity definition file. For example, to make use of a Docker image from the NVIDIA GPU Cloud (NGC) corresponding definition file is:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">From</span>: nvidia/pytorch:<span class="m">18.11</span>-py3
<span class="k">Registry</span>: nvcr.io
</pre></div>
</div>
<p>This def file <code class="docutils literal notranslate"><span class="pre">ngc_pytorch.def</span></code> can be passed as a specification to <code class="docutils literal notranslate"><span class="pre">build</span></code> as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build --docker-login mypytorch.sif ngc_pytorch.def
Enter Docker Username: $oauthtoken
Enter Docker Password: &lt;obscured&gt;
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:18d680d616571900d78ee1c8fff0310f2a2afe39c6ed0ba2651ff667af406c3e
 41.34 MiB / 41.34 MiB [====================================================] 2s
&lt;blob copying details deleted&gt;
Copying config sha256:b77551af8073c85588088ab2a39007d04bc830831ba1eef4127b2d39aaf3a6b1
21.28 KiB / 21.28 KiB [====================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: mypytorch.sif
</pre></div>
</div>
<p>After successful authentication via interactive use of the <code class="docutils literal notranslate"><span class="pre">--docker-login</span></code> option, output as the SIF container <code class="docutils literal notranslate"><span class="pre">mypytorch.sif</span></code> is (ultimately) produced. As above, <a class="reference internal" href="#sec-authentication-via-environment-variables"><span class="std std-ref">use of environment variables</span></a> is another option available for authenticating private Docker type repositories such as NGC; once set, the <code class="docutils literal notranslate"><span class="pre">build</span></code> command is as above save for the absence of the <code class="docutils literal notranslate"><span class="pre">--docker-login</span></code> option.</p>
</div>
<div class="section" id="directing-execution">
<span id="sec-def-files-execution"></span><h4>Directing Execution<a class="headerlink" href="#directing-execution" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> corresponding to <code class="docutils literal notranslate"><span class="pre">godlovedc/lolcow</span></code> (and <a class="reference external" href="https://hub.docker.com/r/godlovedc/lolcow/dockerfile">available here</a>) is as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>FROM ubuntu:16.04

RUN apt-get update &amp;&amp; apt-get install -y fortune cowsay lolcat

ENV PATH /usr/games:${PATH}
ENV LC_ALL=C

ENTRYPOINT fortune | cowsay | lolcat
</pre></div>
</div>
<p>The execution-specific part of this <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> is the <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> - “… an optional definition for the first part of the command to be run …” according to <a class="reference external" href="https://docs.docker.com/search/?q=ENTRYPOINT">the available documentation</a>. After conversion to SIF, execution of <code class="docutils literal notranslate"><span class="pre">fortune</span> <span class="pre">|</span> <span class="pre">cowsay</span> <span class="pre">|</span> <span class="pre">lolcat</span></code> <em>within</em> the container produces the output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./mylolcow.sif
 ______________________________________
/ Q: How did you get into artificial   \
| intelligence? A: Seemed logical -- I |
\ didn&#39;t have any real intelligence.   /
 --------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</pre></div>
</div>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">CMD</span></code> allows an arbitrary string to be <em>appended</em> to the <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code>. Thus, multiple commands or flags can be passed together through combined use.</p>
<p>Suppose now that a Singularity <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> <strong>section</strong> is added to the definition file as follows:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">Namespace</span>: godlovedc
<span class="k">From</span>: lolcow

<span class="gh">%runscript</span>

    fortune
</pre></div>
</div>
<p>After conversion to SIF via the Singularity <code class="docutils literal notranslate"><span class="pre">build</span></code> command, exection of the resulting container produces the output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./lolcow.sif
This was the most unkindest cut of all.
        -- William Shakespeare, &quot;Julius Caesar&quot;
</pre></div>
</div>
<p>In other words, introduction of a <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> section into the Singularity definition file causes the <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> of the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> to be <em>bypassed</em>. The presence of the <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> section would also bypass a <code class="docutils literal notranslate"><span class="pre">CMD</span></code> entry in the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>.</p>
<p>To <em>preserve</em> use of <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> and/or <code class="docutils literal notranslate"><span class="pre">CMD</span></code> as defined in the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, the <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> section must be <em>absent</em> from the Singularity definition. In this case, and to favor execution of <code class="docutils literal notranslate"><span class="pre">CMD</span></code> <em>over</em> <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code>, a non-empty assignment of the <em>optional</em> <code class="docutils literal notranslate"><span class="pre">IncludeCmd</span></code> should be included in the header section of the Singularity definition file as follows:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: docker
<span class="k">Namespace</span>: godlovedc
<span class="k">From</span>: lolcow
<span class="k">IncludeCmd</span>: yes
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because only a non-empty <code class="docutils literal notranslate"><span class="pre">IncludeCmd</span></code> is required, <em>either</em> <code class="docutils literal notranslate"><span class="pre">yes</span></code> (as above) or <code class="docutils literal notranslate"><span class="pre">no</span></code> results in execution of <code class="docutils literal notranslate"><span class="pre">CMD</span></code> <em>over</em> <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code>.</p>
</div>
<p id="sec-def-files-execution-sub-execution-precedence">To summarize execution precedence:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>If present, the <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> section of the Singularity definition file is executed</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">IncludeCmd</span></code> is a non-empty keyword entry in the header of the Singularity definition file, then <code class="docutils literal notranslate"><span class="pre">CMD</span></code> from the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> is executed</p></li>
<li><p>If present in the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> appended by <code class="docutils literal notranslate"><span class="pre">CMD</span></code> (if present) are executed in sequence</p></li>
<li><p>Execution of the <code class="docutils literal notranslate"><span class="pre">bash</span></code> shell is defaulted to</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="container-metadata">
<span id="sec-inspect-container-metadata"></span><h4>Container Metadata<a class="headerlink" href="#container-metadata" title="Permalink to this headline">¶</a></h4>
<p>Singularity’s <code class="docutils literal notranslate"><span class="pre">inspect</span></code> command displays container metadata - data about data that is encapsulated <em>within</em> a SIF file. Default output (assumed via the <code class="docutils literal notranslate"><span class="pre">--labels</span></code> option) from the command was <a class="reference internal" href="#sec-use-prebuilt-public-docker-images-sub-inspect"><span class="std std-ref">illustrated above</span></a>. <code class="docutils literal notranslate"><span class="pre">inspect</span></code>, however, provides a number of options that are <a class="reference internal" href="environment_and_metadata.html#environment-and-metadata"><span class="std std-ref">detailed elsewhere</span></a>; in the remainder of this section, Docker-specific use to establish execution precedence is emphasized.</p>
<p>As stated above (i.e., <a class="reference internal" href="#sec-def-files-execution-sub-execution-precedence"><span class="std std-ref">the first case of execution precedence</span></a>), the very existence of a <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> section in a Singularity definition file <em>takes precedence</em> over commands that might exist in the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> section is <em>removed</em> from the Singularity definition file, the result is (once again):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity inspect --deffile lolcow.sif

from: lolcow
bootstrap: docker
namespace: godlovedc
</pre></div>
</div>
<p>The runscript ‘inherited’ from the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity inspect --runscript lolcow.sif

#!/bin/sh
OCI_ENTRYPOINT=&#39;&quot;/bin/sh&quot; &quot;-c&quot; &quot;fortune | cowsay | lolcat&quot;&#39;
OCI_CMD=&#39;&#39;
# ENTRYPOINT only - run entrypoint plus args
if [ -z &quot;$OCI_CMD&quot; ] &amp;&amp; [ -n &quot;$OCI_ENTRYPOINT&quot; ]; then
    SINGULARITY_OCI_RUN=&quot;${OCI_ENTRYPOINT} $@&quot;
fi

# CMD only - run CMD or override with args
if [ -n &quot;$OCI_CMD&quot; ] &amp;&amp; [ -z &quot;$OCI_ENTRYPOINT&quot; ]; then
    if [ $# -gt 0 ]; then
        SINGULARITY_OCI_RUN=&quot;$@&quot;
    else
        SINGULARITY_OCI_RUN=&quot;${OCI_CMD}&quot;
    fi
fi

# ENTRYPOINT and CMD - run ENTRYPOINT with CMD as default args
# override with user provided args
if [ $# -gt 0 ]; then
    SINGULARITY_OCI_RUN=&quot;${OCI_ENTRYPOINT} $@&quot;
else
    SINGULARITY_OCI_RUN=&quot;${OCI_ENTRYPOINT} ${OCI_CMD}&quot;
fi

eval ${SINGULARITY_OCI_RUN}
</pre></div>
</div>
<p>From this Bourne shell script, it is evident that only an <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> is detailed in the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>; thus the <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span> <span class="pre">only</span> <span class="pre">-</span> <span class="pre">run</span> <span class="pre">entrypoint</span> <span class="pre">plus</span> <span class="pre">args</span></code> conditional block is executed. In this case then, <a class="reference internal" href="#sec-def-files-execution-sub-execution-precedence"><span class="std std-ref">the third case of execution precedence</span></a> has been illustrated.</p>
<p>The above Bourne shell script also illustrates how the following scenarios will be handled:</p>
<blockquote>
<div><ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">CMD</span></code> only entry in the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code></p></li>
<li><p><strong>Both</strong> <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> <em>and</em> <code class="docutils literal notranslate"><span class="pre">CMD</span></code> entries in the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code></p></li>
</ul>
</div></blockquote>
<p>From this level of detail, use of <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> <em>and/or</em> <code class="docutils literal notranslate"><span class="pre">CMD</span></code> in a Dockerfile has been made <strong>explicit</strong>. These remain examples within <a class="reference internal" href="#sec-def-files-execution-sub-execution-precedence"><span class="std std-ref">the third case of execution precedence</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="oci-image-support">
<h2>OCI Image Support<a class="headerlink" href="#oci-image-support" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sec-oci-overview">
<span id="id6"></span><h3>Overview<a class="headerlink" href="#sec-oci-overview" title="Permalink to this headline">¶</a></h3>
<p>OCI is an acronym for the <a class="reference external" href="https://www.opencontainers.org/">Open Containers Initiative</a> - an independent organization whose mandate is to develop open standards relating to containerization. To date, standardization efforts have focused on container formats and runtimes; it is the former that is emphasized here. Stated simply, an <strong>OCI blob</strong> is content that can be addressed; in other words, <em>each</em> layer of a Docker image is rendered as an OCI blob as illustrated in the (revisited) <code class="docutils literal notranslate"><span class="pre">pull</span></code> example below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To facilitate interoperation with Docker Hub, the Singularity core makes use of  the <code class="docutils literal notranslate"><span class="pre">containers/image</span></code> <a class="reference external" href="https://github.com/containers/image/">library</a> - “… a set of Go libraries aimed at working in various way[s] with containers’ images and container image registries.”</p>
</div>
<div class="section" id="image-pulls-revisited">
<h4>Image Pulls Revisited<a class="headerlink" href="#image-pulls-revisited" title="Permalink to this headline">¶</a></h4>
<p>After describing various <a class="reference internal" href="#sec-action-commands-prebuilt-public-docker-images"><span class="std std-ref">action commands that could be applied to images hosted remotely via Docker Hub</span></a>, the notion of having <a class="reference internal" href="#sec-use-prebuilt-public-docker-images"><span class="std std-ref">a local copy in Singularity’s native format for containerization (SIF)</span></a> was introduced:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull docker://godlovedc/lolcow
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
 45.33 MiB / 45.33 MiB [====================================================] 1s
Copying blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
 848 B / 848 B [============================================================] 0s
Copying blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
 621 B / 621 B [============================================================] 0s
Copying blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
 853 B / 853 B [============================================================] 0s
Copying blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
 169 B / 169 B [============================================================] 0s
Copying blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
 53.75 MiB / 53.75 MiB [====================================================] 2s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_latest.sif
</pre></div>
</div>
<p>Thus use of Singularity’s <code class="docutils literal notranslate"><span class="pre">pull</span></code> command results in the <em>local</em> file copy in SIF, namely <code class="docutils literal notranslate"><span class="pre">lolcow_latest.sif</span></code>. Layers of the image from Docker Hub are copied locally as OCI blobs.</p>
</div>
<div class="section" id="image-caching-in-singularity">
<h4>Image Caching in Singularity<a class="headerlink" href="#image-caching-in-singularity" title="Permalink to this headline">¶</a></h4>
<p>If the <em>same</em> <code class="docutils literal notranslate"><span class="pre">pull</span></code> command is issued a <em>second</em> time, the output is different:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull docker://godlovedc/lolcow
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
Skipping fetch of repeat blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
Skipping fetch of repeat blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
Skipping fetch of repeat blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
Skipping fetch of repeat blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
Skipping fetch of repeat blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_latest.sif
</pre></div>
</div>
<p>As the copy operation has clearly been <em>skipped</em>, it is evident that a copy of all OCI blobs <strong>must</strong> be cached locally. Indeed, Singularity has made an entry in its local cache as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tree .singularity/
.singularity/
└── cache
    └── oci
        ├── blobs
        │   └── sha256
        │       ├── 3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
        │       ├── 73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
        │       ├── 7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
        │       ├── 8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
        │       ├── 9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
        │       ├── 9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
        │       ├── d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
        │       └── f2a852991b0a36a9f3d6b2a33b98a461e9ede8393482f0deb5287afcbae2ce10
        ├── index.json
        └── oci-layout

4 directories, 10 files
</pre></div>
</div>
</div>
<div class="section" id="compliance-with-the-oci-image-layout-specification">
<span id="misc-oci-image-layout-specification"></span><h4>Compliance with the OCI Image Layout Specification<a class="headerlink" href="#compliance-with-the-oci-image-layout-specification" title="Permalink to this headline">¶</a></h4>
<p>From the perspective of the directory <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/cache/oci</span></code>, this cache implementation in Singularity complies with the <a class="reference external" href="https://github.com/opencontainers/image-spec/blob/master/image-layout.md">OCI Image Layout Specification</a>:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">blobs</span></code> directory - contains content addressable data, that is otherwise considered opaque</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">oci-layout</span></code> file - a mandatory JSON object file containing both mandatory and optional content</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">index.json</span></code> file - a mandatory JSON object file containing an index of the images</p></li>
</ul>
</div></blockquote>
<p>Because one or more images is ‘bundled’ here, the directory <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/cache/oci</span></code> is referred to as the <code class="docutils literal notranslate"><span class="pre">$OCI_BUNDLE_DIR</span></code>.</p>
<p>For additional details regarding this specification, consult the <a class="reference external" href="https://github.com/opencontainers/image-spec">OCI Image Format Specification</a>.</p>
</div>
<div class="section" id="oci-compliance-and-the-singularity-cache">
<h4>OCI Compliance and the Singularity Cache<a class="headerlink" href="#oci-compliance-and-the-singularity-cache" title="Permalink to this headline">¶</a></h4>
<p>As required by the layout specification, OCI blobs are <em>uniquely</em> named by their contents:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ shasum -a 256 ./blobs/sha256/9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118  ./blobs/sha256/9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
</pre></div>
</div>
<p>They are also otherwise opaque:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ file ./blobs/sha256/9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118 ./blobs/sha256/9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118: gzip compressed data
</pre></div>
</div>
<p>The content of the <code class="docutils literal notranslate"><span class="pre">oci-layout</span></code> file in this example is:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cat</span> <span class="nx">oci</span><span class="o">-</span><span class="nx">layout</span> <span class="o">|</span> <span class="nx">jq</span>
<span class="p">{</span>
  <span class="s2">&quot;imageLayoutVersion&quot;</span><span class="o">:</span> <span class="s2">&quot;1.0.0&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is as required for compliance with the layout standard.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In rendering the above JSON object files, use has been made of <code class="docutils literal notranslate"><span class="pre">jq</span></code> - the command-line JSON processor.</p>
</div>
<p>The index of images in this case is:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cat</span> <span class="nx">index</span><span class="p">.</span><span class="nx">json</span> <span class="o">|</span> <span class="nx">jq</span>
<span class="p">{</span>
  <span class="s2">&quot;schemaVersion&quot;</span><span class="o">:</span> <span class="mf">2</span><span class="p">,</span>
  <span class="s2">&quot;manifests&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;mediaType&quot;</span><span class="o">:</span> <span class="s2">&quot;application/vnd.oci.image.manifest.v1+json&quot;</span><span class="p">,</span>
      <span class="s2">&quot;digest&quot;</span><span class="o">:</span> <span class="s2">&quot;sha256:f2a852991b0a36a9f3d6b2a33b98a461e9ede8393482f0deb5287afcbae2ce10&quot;</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="o">:</span> <span class="mf">1125</span><span class="p">,</span>
      <span class="s2">&quot;annotations&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;org.opencontainers.image.ref.name&quot;</span><span class="o">:</span> <span class="s2">&quot;a692b57abc43035b197b10390ea2c12855d21649f2ea2cc28094d18b93360eeb&quot;</span>
      <span class="p">},</span>
      <span class="s2">&quot;platform&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;architecture&quot;</span><span class="o">:</span> <span class="s2">&quot;amd64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;os&quot;</span><span class="o">:</span> <span class="s2">&quot;linux&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">digest</span></code> blob in this index file includes the details for all of the blobs that collectively comprise the <code class="docutils literal notranslate"><span class="pre">godlovedc/lolcow</span></code> image:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cat</span>  <span class="p">.</span><span class="o">/</span><span class="nx">blobs</span><span class="o">/</span><span class="nx">sha256</span><span class="o">/</span><span class="nx">f2a852991b0a36a9f3d6b2a33b98a461e9ede8393482f0deb5287afcbae2ce10</span> <span class="o">|</span> <span class="nx">jq</span>
<span class="p">{</span>
  <span class="s2">&quot;schemaVersion&quot;</span><span class="o">:</span> <span class="mf">2</span><span class="p">,</span>
  <span class="s2">&quot;config&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;mediaType&quot;</span><span class="o">:</span> <span class="s2">&quot;application/vnd.oci.image.config.v1+json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;digest&quot;</span><span class="o">:</span> <span class="s2">&quot;sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82&quot;</span><span class="p">,</span>
    <span class="s2">&quot;size&quot;</span><span class="o">:</span> <span class="mf">3410</span>
  <span class="p">},</span>
  <span class="s2">&quot;layers&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;mediaType&quot;</span><span class="o">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">,</span>
      <span class="s2">&quot;digest&quot;</span><span class="o">:</span> <span class="s2">&quot;sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118&quot;</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="o">:</span> <span class="mf">47536248</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;mediaType&quot;</span><span class="o">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">,</span>
      <span class="s2">&quot;digest&quot;</span><span class="o">:</span> <span class="s2">&quot;sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a&quot;</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="o">:</span> <span class="mf">848</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;mediaType&quot;</span><span class="o">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">,</span>
      <span class="s2">&quot;digest&quot;</span><span class="o">:</span> <span class="s2">&quot;sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2&quot;</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="o">:</span> <span class="mf">621</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;mediaType&quot;</span><span class="o">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">,</span>
      <span class="s2">&quot;digest&quot;</span><span class="o">:</span> <span class="s2">&quot;sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e&quot;</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="o">:</span> <span class="mf">853</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;mediaType&quot;</span><span class="o">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">,</span>
      <span class="s2">&quot;digest&quot;</span><span class="o">:</span> <span class="s2">&quot;sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9&quot;</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="o">:</span> <span class="mf">169</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;mediaType&quot;</span><span class="o">:</span> <span class="s2">&quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;</span><span class="p">,</span>
      <span class="s2">&quot;digest&quot;</span><span class="o">:</span> <span class="s2">&quot;sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945&quot;</span><span class="p">,</span>
      <span class="s2">&quot;size&quot;</span><span class="o">:</span> <span class="mf">56355961</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">digest</span></code> blob referenced in the <code class="docutils literal notranslate"><span class="pre">index.json</span></code> file references the following configuration file:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cat</span> <span class="p">.</span><span class="o">/</span><span class="nx">blobs</span><span class="o">/</span><span class="nx">sha256</span><span class="o">/</span><span class="mf">73</span><span class="nx">d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82</span> <span class="o">|</span> <span class="nx">jq</span>
<span class="p">{</span>
  <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-21T18:37:47.278336798Z&quot;</span><span class="p">,</span>
  <span class="s2">&quot;architecture&quot;</span><span class="o">:</span> <span class="s2">&quot;amd64&quot;</span><span class="p">,</span>
  <span class="s2">&quot;os&quot;</span><span class="o">:</span> <span class="s2">&quot;linux&quot;</span><span class="p">,</span>
  <span class="s2">&quot;config&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;Env&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;PATH=/usr/games:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class="p">,</span>
      <span class="s2">&quot;LC_ALL=C&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Entrypoint&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;/bin/sh&quot;</span><span class="p">,</span>
      <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
      <span class="s2">&quot;fortune | cowsay | lolcat&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;rootfs&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span>
    <span class="s2">&quot;diff_ids&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;sha256:a2022691bf950a72f9d2d84d557183cb9eee07c065a76485f1695784855c5193&quot;</span><span class="p">,</span>
      <span class="s2">&quot;sha256:ae620432889d2553535199dbdd8ba5a264ce85fcdcd5a430974d81fc27c02b45&quot;</span><span class="p">,</span>
      <span class="s2">&quot;sha256:c561538251751e3685c7c6e7479d488745455ad7f84e842019dcb452c7b6fecc&quot;</span><span class="p">,</span>
      <span class="s2">&quot;sha256:f96e6b25195f1b36ad02598b5d4381e41997c93ce6170cab1b81d9c68c514db0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;sha256:7f7a065d245a6501a782bf674f4d7e9d0a62fa6bd212edbf1f17bad0d5cd0bfc&quot;</span><span class="p">,</span>
      <span class="s2">&quot;sha256:70ca7d49f8e9c44705431e3dade0636a2156300ae646ff4f09c904c138728839&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;history&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-18T23:31:37.453092323Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c #(nop) ADD file:5ed435208da6621b45db657dd6549ee132cde58c4b6763920030794c2f31fbc0 in / &quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-18T23:31:38.196268404Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c set -xe \t\t&amp;&amp; echo &#39;#!/bin/sh&#39; &gt; /usr/sbin/policy-rc.d \t&amp;&amp; echo &#39;exit 101&#39; &gt;&gt; /usr/sbin/policy-rc.d \t&amp;&amp; chmod +x /usr/sbin/policy-rc.d \t\t&amp;&amp; dpkg-divert --local --rename --add /sbin/initctl \t&amp;&amp; cp -a /usr/sbin/policy-rc.d /sbin/initctl \t&amp;&amp; sed -i &#39;s/^exit.*/exit 0/&#39; /sbin/initctl \t\t&amp;&amp; echo &#39;force-unsafe-io&#39; &gt; /etc/dpkg/dpkg.cfg.d/docker-apt-speedup \t\t&amp;&amp; echo &#39;DPkg::Post-Invoke { \&quot;rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true\&quot;; };&#39; &gt; /etc/apt/apt.conf.d/docker-clean \t&amp;&amp; echo &#39;APT::Update::Post-Invoke { \&quot;rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true\&quot;; };&#39; &gt;&gt; /etc/apt/apt.conf.d/docker-clean \t&amp;&amp; echo &#39;Dir::Cache::pkgcache \&quot;\&quot;; Dir::Cache::srcpkgcache \&quot;\&quot;;&#39; &gt;&gt; /etc/apt/apt.conf.d/docker-clean \t\t&amp;&amp; echo &#39;Acquire::Languages \&quot;none\&quot;;&#39; &gt; /etc/apt/apt.conf.d/docker-no-languages \t\t&amp;&amp; echo &#39;Acquire::GzipIndexes \&quot;true\&quot;; Acquire::CompressionTypes::Order:: \&quot;gz\&quot;;&#39; &gt; /etc/apt/apt.conf.d/docker-gzip-indexes \t\t&amp;&amp; echo &#39;Apt::AutoRemove::SuggestsImportant \&quot;false\&quot;;&#39; &gt; /etc/apt/apt.conf.d/docker-autoremove-suggests&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-18T23:31:38.788043199Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c rm -rf /var/lib/apt/lists/*&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-18T23:31:39.411670721Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c sed -i &#39;s/^#\\s*\\(deb.*universe\\)$/\\1/g&#39; /etc/apt/sources.list&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-18T23:31:40.055188541Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c mkdir -p /run/systemd &amp;&amp; echo &#39;docker&#39; &gt; /run/systemd/container&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-18T23:31:40.215057796Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c #(nop)  CMD [\&quot;/bin/bash\&quot;]&quot;</span><span class="p">,</span>
      <span class="s2">&quot;empty_layer&quot;</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-21T18:37:46.483638061Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c apt-get update &amp;&amp; apt-get install -y fortune cowsay lolcat&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-21T18:37:47.041333952Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c #(nop)  ENV PATH=/usr/games:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span><span class="p">,</span>
      <span class="s2">&quot;empty_layer&quot;</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-21T18:37:47.170535967Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c #(nop)  ENV LC_ALL=C&quot;</span><span class="p">,</span>
      <span class="s2">&quot;empty_layer&quot;</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;created&quot;</span><span class="o">:</span> <span class="s2">&quot;2017-09-21T18:37:47.278336798Z&quot;</span><span class="p">,</span>
      <span class="s2">&quot;created_by&quot;</span><span class="o">:</span> <span class="s2">&quot;/bin/sh -c #(nop)  ENTRYPOINT [\&quot;/bin/sh\&quot; \&quot;-c\&quot; \&quot;fortune | cowsay | lolcat\&quot;]&quot;</span><span class="p">,</span>
      <span class="s2">&quot;empty_layer&quot;</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Even when all OCI blobs are already in Singularity’s local cache, repeated image pulls cause <em>both</em> these last-two JSON object files, as well as the <code class="docutils literal notranslate"><span class="pre">oci-layout</span></code> and <code class="docutils literal notranslate"><span class="pre">index.json</span></code> files, to be updated.</p>
</div>
</div>
<div class="section" id="building-containers-for-singularity-from-oci-images">
<h3>Building Containers for Singularity from OCI Images<a class="headerlink" href="#building-containers-for-singularity-from-oci-images" title="Permalink to this headline">¶</a></h3>
<div class="section" id="working-locally-from-the-singularity-command-line-oci-boostrap-agent">
<span id="sec-cli-oci-bootstrap-agent"></span><h4>Working Locally from the Singularity Command Line: <code class="docutils literal notranslate"><span class="pre">oci</span></code> Boostrap Agent<a class="headerlink" href="#working-locally-from-the-singularity-command-line-oci-boostrap-agent" title="Permalink to this headline">¶</a></h4>
<p>The example detailed in the previous section can be used to illustrate how a SIF file for use by Singularity can be created from the local cache - an albeit contrived example, that works because the Singularity cache is compliant with the OCI Image Layout Specification.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Of course, the <code class="docutils literal notranslate"><span class="pre">oci</span></code> bootstrap agent can be applied to <em>any</em> <strong>bundle</strong> that is compliant with the OCI Image Layout Specification - not <em>just</em> the Singularity cache, as created by executing a Singularity <code class="docutils literal notranslate"><span class="pre">pull</span></code> command.</p>
</div>
<p>In this local case, the <code class="docutils literal notranslate"><span class="pre">build</span></code> command of Singularity makes use of the <code class="docutils literal notranslate"><span class="pre">oci</span></code> boostrap agent as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build ~/lolcow_oci_cache.sif oci://$HOME/.singularity/cache/oci:a692b57abc43035b197b10390ea2c12855d21649f2ea2cc28094d18b93360eeb
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
Skipping fetch of repeat blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
Skipping fetch of repeat blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
Skipping fetch of repeat blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
Skipping fetch of repeat blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
Skipping fetch of repeat blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: /home/vagrant/lolcow_oci_cache.sif
</pre></div>
</div>
<p>As can be seen, this results in the SIF file <code class="docutils literal notranslate"><span class="pre">lolcow_oci_cache.sif</span></code> in the user’s home directory.</p>
<p>The syntax for the <code class="docutils literal notranslate"><span class="pre">oci</span></code> boostrap agent requires some elaboration, however. In this case, and as illustrated above, <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/cache/oci</span></code> has content:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ls
blobs  index.json  oci-layout
</pre></div>
</div>
<p>In other words, it is the <code class="docutils literal notranslate"><span class="pre">$OCI_BUNDLE_DIR</span></code> containing the data and metadata that collectively comprise the image layed out in accordance with the OCI Image Layout Specification <a class="reference internal" href="#misc-oci-image-layout-specification"><span class="std std-ref">as discussed previously</span></a> - the same data and metadata that are assembled into a single SIF file through the <code class="docutils literal notranslate"><span class="pre">build</span></code> process. However,</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build ~/lolcow_oci_cache.sif oci://$HOME/.singularity/cache/oci
INFO:    Starting build...
FATAL:   While performing build: conveyor failed to get: more than one image in oci, choose an image
</pre></div>
</div>
<p>does not <em>uniquely</em> specify an image from which to bootstrap the <code class="docutils literal notranslate"><span class="pre">build</span></code> process. In other words, there are multiple images referenced via <code class="docutils literal notranslate"><span class="pre">org.opencontainers.image.ref.name</span></code> in the <code class="docutils literal notranslate"><span class="pre">index.json</span></code> file. By appending <code class="docutils literal notranslate"><span class="pre">:a692b57abc43035b197b10390ea2c12855d21649f2ea2cc28094d18b93360eeb</span></code> to <code class="docutils literal notranslate"><span class="pre">oci</span></code> in this example, the image is uniquely specified, and the container created in SIF (as illustrated previously).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Executing the Singularity <code class="docutils literal notranslate"><span class="pre">pull</span></code> command multiple times on the same image produces multiple <code class="docutils literal notranslate"><span class="pre">org.opencontainers.image.ref.name</span></code> entries in the <code class="docutils literal notranslate"><span class="pre">index.json</span></code> file. Appending the value of the unique <code class="docutils literal notranslate"><span class="pre">org.opencontainers.image.ref.name</span></code> allows for use of the <code class="docutils literal notranslate"><span class="pre">oci</span></code> boostrap agent.</p>
</div>
</div>
<div class="section" id="working-locally-from-the-singularity-command-line-oci-archive-boostrap-agent">
<span id="sec-cli-oci-archive-bootstrap-agent"></span><h4>Working Locally from the Singularity Command Line: <code class="docutils literal notranslate"><span class="pre">oci-archive</span></code> Boostrap Agent<a class="headerlink" href="#working-locally-from-the-singularity-command-line-oci-archive-boostrap-agent" title="Permalink to this headline">¶</a></h4>
<p>OCI archives, i.e., <code class="docutils literal notranslate"><span class="pre">tar</span></code> files obeying the OCI Image Layout Specification <a class="reference internal" href="#misc-oci-image-layout-specification"><span class="std std-ref">as discussed previously</span></a>, can seed creation of a container for Singularity. In this case, use is made of the <code class="docutils literal notranslate"><span class="pre">oci-archive</span></code> bootstrap agent.</p>
<p>To illustrate this agent, it is convenient to build the archive from the Singularity cache. After a single <code class="docutils literal notranslate"><span class="pre">pull</span></code> of the <code class="docutils literal notranslate"><span class="pre">godlovedc/lolcow</span></code> image from Docker Hub, a <code class="docutils literal notranslate"><span class="pre">tar</span></code> format archive can be generated from the <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/cache/oci</span></code> directory as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar cvf $HOME/godlovedc_lolcow.tar *
blobs/
blobs/sha256/
blobs/sha256/73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
blobs/sha256/8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
blobs/sha256/9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
blobs/sha256/3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
blobs/sha256/9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
blobs/sha256/d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
blobs/sha256/f2a852991b0a36a9f3d6b2a33b98a461e9ede8393482f0deb5287afcbae2ce10
blobs/sha256/7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
index.json
oci-layout
</pre></div>
</div>
<p>The native container <code class="docutils literal notranslate"><span class="pre">lolcow_oci_tarfile.sif</span></code> for use by Singularity can be created by issuing the <code class="docutils literal notranslate"><span class="pre">build</span></code> command as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build lolcow_oci_tarfile.sif oci-archive://godlovedc_lolcow.tar
Build target already exists. Do you want to overwrite? [N/y] y
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
Skipping fetch of repeat blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
Skipping fetch of repeat blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
Skipping fetch of repeat blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
Skipping fetch of repeat blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
Skipping fetch of repeat blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_oci_tarfile.sif
</pre></div>
</div>
<p>This assumes that the <code class="docutils literal notranslate"><span class="pre">tar</span></code> file exists in the current working directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Cache maintenance is a manual process at the current time. In other words, the cache can be cleared by <strong>carefully</strong> issuing the command <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">$HOME/.singularity/cache</span></code>. Of course, this will clear the local cache of all downloaded images.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Because the layers of a Docker image as well as the blobs of an OCI image are already <code class="docutils literal notranslate"><span class="pre">gzip</span></code> compressed, there is a minimal advantage to having compressed archives representing OCI images. For this reason, the <code class="docutils literal notranslate"><span class="pre">build</span></code> detailed above boostraps a SIF file for use by Singularity from only a <code class="docutils literal notranslate"><span class="pre">tar</span></code> file, and not a <code class="docutils literal notranslate"><span class="pre">tar.gz</span></code> file.</p>
</div>
</div>
<div class="section" id="working-from-the-singularity-command-line-with-remotely-hosted-images">
<h4>Working from the Singularity Command Line with Remotely Hosted Images<a class="headerlink" href="#working-from-the-singularity-command-line-with-remotely-hosted-images" title="Permalink to this headline">¶</a></h4>
<p>In the previous section, an OCI archive was created from locally available OCI blobs and metadata; the resulting <code class="docutils literal notranslate"><span class="pre">tar</span></code> file served to bootstrap the creation of a container for Singularity in SIF via the <code class="docutils literal notranslate"><span class="pre">oci-archive</span></code> agent. Typically, however, OCI archives of interest are remotely hosted. Consider, for example, an Alpine Linux OCI archive stored in Amazon S3 storage. Because such an archive can be retrieved via secure HTTP, the following <code class="docutils literal notranslate"><span class="pre">pull</span></code> command results in a local copy as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull https://s3.amazonaws.com/singularity-ci-public/alpine-oci-archive.tar
 1.98 MiB / 1.98 MiB [==================================================================================] 100.00% 7.48 MiB/s 0s
</pre></div>
</div>
<p>Thus <code class="docutils literal notranslate"><span class="pre">https</span></code> (and <code class="docutils literal notranslate"><span class="pre">http</span></code>) are additional bootstrap agents available to seed development of containers for Singularity.</p>
<p>It is worth noting that the OCI image specfication compliant contents of this archive are:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tar tvf alpine-oci-archive.tar
drwxr-xr-x 1000/1000         0 2018-06-25 14:45 blobs/
drwxr-xr-x 1000/1000         0 2018-06-25 14:45 blobs/sha256/
-rw-r--r-- 1000/1000       585 2018-06-25 14:45 blobs/sha256/b1a7f144ece0194921befe57ab30ed1fd98c5950db7996719429020986092058
-rw-r--r-- 1000/1000       348 2018-06-25 14:45 blobs/sha256/d0ff39a54244ba25ac7447f19941765bee97b05f37ceb438a72e80c9ed39854a
-rw-r--r-- 1000/1000   2065537 2018-06-25 14:45 blobs/sha256/ff3a5c916c92643ff77519ffa742d3ec61b7f591b6b7504599d95a4a41134e28
-rw-r--r-- 1000/1000       296 2018-06-25 14:45 index.json
-rw-r--r-- 1000/1000        31 2018-06-25 14:45 oci-layout
</pre></div>
</div>
<p>Proceeding as before, for a (now) locally available OCI archive, a SIF file can be produced by executing:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity build alpine_oci_archive.sif oci-archive://alpine-oci-archive.tar
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:ff3a5c916c92643ff77519ffa742d3ec61b7f591b6b7504599d95a4a41134e28
 1.97 MiB / 1.97 MiB [======================================================] 0s
Copying config sha256:b1a7f144ece0194921befe57ab30ed1fd98c5950db7996719429020986092058
 585 B / 585 B [============================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: alpine_oci_archive.sif
</pre></div>
</div>
<p>The resulting SIF file can be validated as follows, for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./alpine_oci_archive.sif
Singularity&gt; cat /etc/os-release
NAME=&quot;Alpine Linux&quot;
ID=alpine
VERSION_ID=3.7.0
PRETTY_NAME=&quot;Alpine Linux v3.7&quot;
HOME_URL=&quot;http://alpinelinux.org&quot;
BUG_REPORT_URL=&quot;http://bugs.alpinelinux.org&quot;
Singularity&gt;
$
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">http</span></code> and <code class="docutils literal notranslate"><span class="pre">https</span></code> bootstrap agents can only be used to <code class="docutils literal notranslate"><span class="pre">pull</span></code> OCI archives from where they are hosted.</p>
<p>In working with remotely hosted OCI image archives then, a two-step workflow is <em>required</em> to produce SIF files for native use by Singularity:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Transfer of the image to local storage via the <code class="docutils literal notranslate"><span class="pre">https</span></code> (or <code class="docutils literal notranslate"><span class="pre">http</span></code>) bootstrap agent. The Singularity <code class="docutils literal notranslate"><span class="pre">pull</span></code> command achieves this.</p></li>
<li><p>Creation of a SIF file via the <code class="docutils literal notranslate"><span class="pre">oci-archive</span></code> bootstrap agent. The Singularity <code class="docutils literal notranslate"><span class="pre">build</span></code> command achieves this.</p></li>
</ol>
</div></blockquote>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Though a frequently asked question, the distribution of OCI images remains <a class="reference external" href="https://www.opencontainers.org/about/oci-scope-table">out of scope</a>. In other words, there is no OCI endorsed distribution method or registry.</p>
<p>Established with nothing more than a Web server then, any individual, group or organization, <em>could</em> host OCI archives. This might be particularly appealing, for example, for organizations having security requirements that preclude access to public registries such as Docker Hub. Other that having a very basic hosting capability, OCI archives need only comply to the OCI Image Layout Specification <a class="reference internal" href="#misc-oci-image-layout-specification"><span class="std std-ref">as discussed previously</span></a>.</p>
</div>
</div>
<div class="section" id="working-with-definition-files-mandatory-header-keywords">
<h4>Working with Definition Files: Mandatory Header Keywords<a class="headerlink" href="#working-with-definition-files-mandatory-header-keywords" title="Permalink to this headline">¶</a></h4>
<p>Three, new bootstrap agents have been introduced as a consequence of compliance with the OCI Image Specification - assuming <code class="docutils literal notranslate"><span class="pre">http</span></code> and <code class="docutils literal notranslate"><span class="pre">https</span></code> are considered together. In addition to bootstrapping images for Singularity completely from the command line, definition files can be employed.</p>
<p>As <a class="reference internal" href="#sec-cli-oci-bootstrap-agent"><span class="std std-ref">above</span></a>, the OCI image layout compliant Singularity cache can be employed to create SIF containers; the definition file, <code class="docutils literal notranslate"><span class="pre">lolcow-oci.def</span></code>, equivalent is:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: oci
<span class="k">From</span>: .singularity/cache/oci:a692b57abc43035b197b10390ea2c12855d21649f2ea2cc28094d18b93360eeb
</pre></div>
</div>
<p>Recall that the colon-appended string in this file uniquely specifies the <code class="docutils literal notranslate"><span class="pre">org.opencontainers.image.ref.name</span></code> of the desired image, as more than one possibility exists in the <code class="docutils literal notranslate"><span class="pre">index.json</span></code> file. The corresponding <code class="docutils literal notranslate"><span class="pre">build</span></code> command is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build ~/lolcow_oci_cache.sif lolcow-oci.def
WARNING: Authentication token file not found : Only pulls of public images will succeed
Build target already exists. Do you want to overwrite? [N/y] y
INFO:    Starting build...
Getting image source signatures
Copying blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
 45.33 MiB / 45.33 MiB [====================================================] 0s
Copying blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
 848 B / 848 B [============================================================] 0s
Copying blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
 621 B / 621 B [============================================================] 0s
Copying blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
 853 B / 853 B [============================================================] 0s
Copying blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
 169 B / 169 B [============================================================] 0s
Copying blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
 53.75 MiB / 53.75 MiB [====================================================] 0s
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: /home/vagrant/lolcow_oci_cache.sif
</pre></div>
</div>
<p>Required use of <code class="docutils literal notranslate"><span class="pre">sudo</span></code> allows Singularity to <code class="docutils literal notranslate"><span class="pre">build</span></code> the SIF container <code class="docutils literal notranslate"><span class="pre">lolcow_oci_cache.sif</span></code>.</p>
<p>When it comes to OCI archives, the definition file, <code class="docutils literal notranslate"><span class="pre">lolcow-ocia.def</span></code> corresponding to the command-line invocation above is:</p>
<div class="highlight-singularity notranslate"><div class="highlight"><pre><span></span><span class="k">Bootstrap</span>: oci-archive
<span class="k">From</span>: godlovedc_lolcow.tar
</pre></div>
</div>
<p>Applying <code class="docutils literal notranslate"><span class="pre">build</span></code> as follows</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity build lolcow_oci_tarfile.sif lolcow-ocia.def
WARNING: Authentication token file not found : Only pulls of public images will succeed
INFO:    Starting build...
Getting image source signatures
Skipping fetch of repeat blob sha256:9fb6c798fa41e509b58bccc5c29654c3ff4648b608f5daa67c1aab6a7d02c118
Skipping fetch of repeat blob sha256:3b61febd4aefe982e0cb9c696d415137384d1a01052b50a85aae46439e15e49a
Skipping fetch of repeat blob sha256:9d99b9777eb02b8943c0e72d7a7baec5c782f8fd976825c9d3fb48b3101aacc2
Skipping fetch of repeat blob sha256:d010c8cf75d7eb5d2504d5ffa0d19696e8d745a457dd8d28ec6dd41d3763617e
Skipping fetch of repeat blob sha256:7fac07fb303e0589b9c23e6f49d5dc1ff9d6f3c8c88cabe768b430bdb47f03a9
Skipping fetch of repeat blob sha256:8e860504ff1ee5dc7953672d128ce1e4aa4d8e3716eb39fe710b849c64b20945
Copying config sha256:73d5b1025fbfa138f2cacf45bbf3f61f7de891559fa25b28ab365c7d9c3cbd82
 3.33 KiB / 3.33 KiB [======================================================] 0s
Writing manifest to image destination
Storing signatures
INFO:    Creating SIF file...
INFO:    Build complete: lolcow_oci_tarfile.sif
</pre></div>
</div>
<p>results in the SIF container <code class="docutils literal notranslate"><span class="pre">lolcow_oci_tarfile.sif</span></code>.</p>
</div>
<div class="section" id="working-with-definition-files-additonal-considerations">
<h4>Working with Definition Files: Additonal Considerations<a class="headerlink" href="#working-with-definition-files-additonal-considerations" title="Permalink to this headline">¶</a></h4>
<p>In working with definition files, the following additional considerations arise:</p>
<blockquote>
<div><ul class="simple">
<li><p>In addition to the mandatory header keywords documented above, <a class="reference internal" href="#sec-optional-headers-def-files"><span class="std std-ref">optional header keywords</span></a> are possible additions to OCI bundle and/or archive bootstrap definition files.</p></li>
<li><p>As distribution of OCI bundles and/or archives is out of the Initiative’s scope, so is the authentication required to access private images and/or registries.</p></li>
<li><p>The direction of execution follows along the same lines <a class="reference internal" href="#sec-def-files-execution"><span class="std std-ref">as described above</span></a>. Of course, the SIF container’s metadata will make clear the <code class="docutils literal notranslate"><span class="pre">runscript</span></code> through application of the <code class="docutils literal notranslate"><span class="pre">inspect</span></code> command <a class="reference internal" href="#sec-inspect-container-metadata"><span class="std std-ref">as described previously</span></a>.</p></li>
<li><p>Container metadata will also reveal whether or not a given SIF file was bootstrapped from an OCI bundle or archive; for example, below it is evident that an OCI archive was employed to bootstrap creation of the SIF file:</p></li>
</ul>
</div></blockquote>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">singularity</span> <span class="nx">inspect</span> <span class="o">--</span><span class="nx">labels</span> <span class="nx">lolcow_oci_tarfile</span><span class="p">.</span><span class="nx">sif</span> <span class="o">|</span> <span class="nx">jq</span>
<span class="p">{</span>
  <span class="s2">&quot;org.label-schema.build-date&quot;</span><span class="o">:</span> <span class="s2">&quot;Sunday_27_January_2019_0:5:29_UTC&quot;</span><span class="p">,</span>
  <span class="s2">&quot;org.label-schema.schema-version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;org.label-schema.usage.singularity.deffile.bootstrap&quot;</span><span class="o">:</span> <span class="s2">&quot;oci-archive&quot;</span><span class="p">,</span>
  <span class="s2">&quot;org.label-schema.usage.singularity.deffile.from&quot;</span><span class="o">:</span> <span class="s2">&quot;godlovedc_lolcow.tar&quot;</span><span class="p">,</span>
  <span class="s2">&quot;org.label-schema.usage.singularity.version&quot;</span><span class="o">:</span> <span class="s2">&quot;3.0.3-1&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="best-practices">
<span id="sec-best-practices"></span><h2>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h2>
<p>Singularity can make use of most Docker and OCI images without complication. However, there exist  known cases where complications can arise. Thus a brief compilation of best practices follows below.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Accounting for trust</p></li>
</ol>
<p>Docker containers <em>allow for</em> privilege escalation. In a <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, for example, the <code class="docutils literal notranslate"><span class="pre">USER</span></code> instruction allows for user and/or group settings to be made in the Linux operating environment. The trust model in Singularity is completely different: Singularity allows untrusted users to run untrusted containers in a trusted way. Because Singularity containers embodied as SIF files execute in <em>user</em> space, there is no possibility for privilege escalation. In other words, those familiar with Docker, should <em>not</em> expect access to elevated user permissions; and as a corollary, use of the <code class="docutils literal notranslate"><span class="pre">USER</span></code> instruction must be <em>avoided</em>.</p>
<p>Singularity does, however, allow for fine-grained control over the permissions that containers require for execution. Given that Singularilty executes in user space, it is not surprising that permissions need to be externally established <em>for</em> the container through use of the <code class="docutils literal notranslate"><span class="pre">capability</span></code> command. <a class="reference internal" href="security_options.html#security-options"><span class="std std-ref">Detailed elsewhere in this documentation</span></a>, Singularity allows users and/or groups to be granted/revoked authorized capabilties. Owing to Singularity’s trust model, this fundamental best practice can be stated as follows:</p>
<blockquote>
<div><p>“Employ <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">capability</span></code> to manage execution privileges for containers”</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Maintaining containers built from Docker and OCI images</p></li>
</ol>
<p>SIF files created by boostrapping from Docker or OCI images are, of course, only as current as the most recent Singularity <code class="docutils literal notranslate"><span class="pre">pull</span></code>. Subsequent retrievals <em>may</em> result in containers that are built and/or behave differently, owing to changes in the corresponding <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>. A prudent practice then, for maintaining containers of value, is based upon use of Singularity definition files. Styled and implemented after a <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> retrieved at some point in time, use of <code class="docutils literal notranslate"><span class="pre">diff</span></code> on subsequent versions of this same file, can be employed to inform maintenance of the corresponding Singularity definition file. Understanding build specifications at this level of detail places container creators in a much more sensible position prior to signing with an encrypted key. Thus the best practice is:</p>
<blockquote>
<div><p>“Maintain detailed build specifications for containers, rather than opaque runtimes”</p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>Working with environment variables</p></li>
</ol>
<p>In a <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, <a class="reference external" href="https://docs.docker.com/engine/reference/builder/#env">environment variables are declared</a> as key-value pairs through use of the <code class="docutils literal notranslate"><span class="pre">ENV</span></code> instruction. Declaration in the build specification for a container is advised, rather than relying upon user
(e.g., <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code>, <code class="docutils literal notranslate"><span class="pre">.profile</span></code>) or system-wide configuration files for interactive shells. Should a <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> be converted into a definition file for Singularity, as suggested in the container-maintenance best practice above, <span class="xref std std-ref">environment variables can be explicitly represented</span> as <code class="docutils literal notranslate"><span class="pre">ENV</span></code> instructions that have been converted into entries in the <code class="docutils literal notranslate"><span class="pre">%environment</span></code> section, respectively. This best practice can be stated as follows:</p>
<blockquote>
<div><p>“Define environment variables in container specifications, not interactive shells”</p>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>Installation to <code class="docutils literal notranslate"><span class="pre">/root</span></code></p></li>
</ol>
<p>Docker and OCI container’s are typically run as the <code class="docutils literal notranslate"><span class="pre">root</span></code> user; therefore, <code class="docutils literal notranslate"><span class="pre">/root</span></code> (this user’s <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> directory) will be the installation target when <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> is specified. Installation to <code class="docutils literal notranslate"><span class="pre">/root</span></code> may prove workable in some circumstances - e.g., while the container is executing, or if read-only access is required to this directory after installation. In general, however, because this is the <code class="docutils literal notranslate"><span class="pre">root</span></code> directory conventional wisdom suggests this practice be avoided. Thus the best practice is:</p>
<blockquote>
<div><p>“Avoid installations that make use of <code class="docutils literal notranslate"><span class="pre">/root</span></code>.”</p>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><p>Read-only <code class="docutils literal notranslate"><span class="pre">/</span></code> filesystem</p></li>
</ol>
<p>Singularity mounts a container’s <code class="docutils literal notranslate"><span class="pre">/</span></code> filesystem in read-only mode. To ensure a Docker container meets Singularity’s requirements, it may prove useful to execute <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--read-only</span> <span class="pre">--tmpfs</span> <span class="pre">/run</span> <span class="pre">--tmpfs</span> <span class="pre">/tmp</span> <span class="pre">godlovedc/lolcow</span></code>. The best practioce here is:</p>
<blockquote>
<div><p>“Ensure Docker containers meet Singularity’s read-only <code class="docutils literal notranslate"><span class="pre">/</span></code> filesystem requirement”</p>
</div></blockquote>
<ol class="arabic simple" start="6">
<li><p>Installation to <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> or <code class="docutils literal notranslate"><span class="pre">$TMP</span></code></p></li>
</ol>
<p>In making use of Singularity, it is common practice for <code class="docutils literal notranslate"><span class="pre">$USER</span></code> to be automatically mounted on <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>, and for <code class="docutils literal notranslate"><span class="pre">$TMP</span></code> also to be mounted. To avoid the side effects (e.g., ‘missing’ or conflicting files) that might arise as a consequence of executing <code class="docutils literal notranslate"><span class="pre">mount</span></code> commands then, the best practice is:</p>
<blockquote>
<div><p>“Avoid placing container ‘valuables’ in <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> or <code class="docutils literal notranslate"><span class="pre">$TMP</span></code>.”</p>
</div></blockquote>
<p>A detailed review of the container’s build specification (e.g., its <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>) may be required to ensure this best practice is adhered to.</p>
<ol class="arabic simple" start="7">
<li><p>Current library caches</p></li>
</ol>
<p>Irrespective of containers, <a class="reference external" href="https://codeyarns.com/2014/01/14/how-to-fix-shared-object-file-error/">a common runtime error</a> stems from failing to locate shared libraries required for execution. Suppose now there exists a requirement for symbolically linked libraries <em>within</em> a Singularity container. If the builld process that creates the container fails to update the cache, then it is quite likely that (read-only) execution of this container will result in the common error of missing libraries. Upon investigation, it is likely revealed that the library exists, just not the required symbolic links. Thus the best practice is:</p>
<blockquote>
<div><p>“Ensure calls to <code class="docutils literal notranslate"><span class="pre">ldconfig</span></code> are executed towards the <em>end</em> of <code class="docutils literal notranslate"><span class="pre">build</span></code> specifications (e.g., <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>), so that the library cache is updated when the container is created.”</p>
</div></blockquote>
<ol class="arabic simple" start="8">
<li><p>Use of plain-text passwords for authentication</p></li>
</ol>
<p>For obvious reasons, it is desireable to completely <em>avoid</em> use of plain-text passwords. Therefore, for interactive sessions requiring authentication, use of the <code class="docutils literal notranslate"><span class="pre">--docker-login</span></code> option for Singularity’s <code class="docutils literal notranslate"><span class="pre">pull</span></code> and <code class="docutils literal notranslate"><span class="pre">build</span></code> commands is <em>recommended</em>. At the present time, the <em>only</em> option available for non-interactive use is to <a class="reference internal" href="#sec-authentication-via-environment-variables"><span class="std std-ref">embed plain-text passwords into environment variables</span></a>. Because the Sylabs Cloud Singularity Library employs <a class="reference external" href="https://cloud.sylabs.io/auth">time-limited API tokens for authentication</a>, use of SIF containers hosted through this service provides a more secure means for both interactive <em>and</em> non-interactive use. This best practice is:</p>
<blockquote>
<div><p>“Avoid use of plain-text passwords”</p>
</div></blockquote>
<ol class="arabic simple" start="9">
<li><p>Execution ambiguity</p></li>
</ol>
<p>Short of converting an <em>entire</em> <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> into a Singularity definition file, informed specification of the <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> entry in the def file <em>removes</em> any ambiguity associated with <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> <a class="reference internal" href="#sec-def-files-execution"><span class="std std-ref">versus</span></a> <code class="docutils literal notranslate"><span class="pre">CMD</span></code> and ultimately <a class="reference internal" href="#sec-def-files-execution"><span class="std std-ref">execution precedence</span></a>. Thus the best practice is:</p>
<blockquote>
<div><p>“Employ Singularity’s <code class="docutils literal notranslate"><span class="pre">%runscript</span></code> by default to avoid execution ambiguity”</p>
</div></blockquote>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">ENTRYPOINT</span></code> can be bypassed completely, e.g., <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">-i</span> <span class="pre">-t</span> <span class="pre">--entrypoint</span> <span class="pre">/bin/bash</span> <span class="pre">godlovedc/lolcow</span></code>. This allows for an interactive session within the container, that may prove useful in validating the built runtime.</p>
</div></blockquote>
<p>Best practices emerge from experience. Contributions that allow additional experiences to be shared as best practices are always encouraged. Please refer to <a class="reference internal" href="contributing.html#contributing"><span class="std std-ref">Contributing</span></a> for additional details.</p>
</div>
<div class="section" id="troubleshooting">
<span id="sec-troubleshooting"></span><h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>In making use of Docker and OCI images through Singularity the need to troubleshoot may arise. A brief compilation of issues and their resolution is provided here.</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Authentication issues</p></li>
</ol>
<p>Authentication is required to make use of Docker-style private images and/or private registries. Examples involving private images hosted by the public Docker Hub were <a class="reference internal" href="#sec-using-prebuilt-private-images"><span class="std std-ref">provided above</span></a>, whereas the NVIDIA GPU Cloud was used to <a class="reference internal" href="#sec-using-prebuilt-private-images-parivate-registries"><span class="std std-ref">illustrate access to a private registry</span></a>. Even if the intended use of containers is non-interactive, issues in authenticating with these image-hosting services are most easily addressed through use of the <code class="docutils literal notranslate"><span class="pre">--docker-login</span></code> option that can be appended to a Singularity <code class="docutils literal notranslate"><span class="pre">pull</span></code> request. As soon as image signatures and blobs start being received, authentication credentials have been validated, and the image <code class="docutils literal notranslate"><span class="pre">pull</span></code> can be cancelled.</p>
<ol class="arabic simple" start="2">
<li><p>Execution mismatches</p></li>
</ol>
<p>Execution intentions are detailed through specification files - i.e., the <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> in the case of Docker images. However, intentions and precedence aside, the reality of executing a container may not align with expectations. To alleviate this mismatch, use of <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">inspect</span> <span class="pre">--runscript</span> <span class="pre">&lt;somecontainer&gt;.sif</span></code> details the <em>effective</em> runscript - i.e., the one that is actually being executed. Of course, the ultimate solution to this issue is to develop and maintain Singularity definition files for containers of interest.</p>
<ol class="arabic simple" start="3">
<li><p>More than one image in the OCI bundle directory</p></li>
</ol>
<p><a class="reference internal" href="#sec-cli-oci-bootstrap-agent"><span class="std std-ref">As illustrated above</span></a>, and with respect to the bootstrap agent <code class="docutils literal notranslate"><span class="pre">oci://$OCI_BUNDLE_DIR</span></code>, a fatal error is generated when <em>more</em> than one image is referenced in the <code class="docutils literal notranslate"><span class="pre">$OCI_BUNDLE_DIR/index.json</span></code> file. The workaround shared previously was to append the bootstrap directive with the unique reference name for the image of interest - i.e., <code class="docutils literal notranslate"><span class="pre">oci://$OCI_BUNDLE_DIR:org.opencontainers.image.ref.name</span></code>. Because it may take some effort to locate the reference name for an image of interest, an even simpler solution is to ensure that each <code class="docutils literal notranslate"><span class="pre">$OCI_BUNDLE_DIR</span></code> contains at most a single image.</p>
<ol class="arabic simple" start="4">
<li><p>Cache maintenance</p></li>
</ol>
<p>Maintenance of the Singularity cache (i.e., <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/cache</span></code>) requires manual intervention at this time. By <strong>carefully</strong> issuing the command <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">$HOME/.singularity/cache</span></code>, its local cache will be cleared of all downloaded images.</p>
<ol class="arabic simple" start="5">
<li><p>The <code class="docutils literal notranslate"><span class="pre">http</span></code> and <code class="docutils literal notranslate"><span class="pre">https</span></code> are <code class="docutils literal notranslate"><span class="pre">pull</span></code> only boostrap agents</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">http</span></code> and <code class="docutils literal notranslate"><span class="pre">https</span></code> are the only examples of <code class="docutils literal notranslate"><span class="pre">pull</span></code> only boostrap agents. In other words, when used with Singularity’s <code class="docutils literal notranslate"><span class="pre">pull</span></code> command, the result is a local copy of, for example, an OCI archive image. This means that a subsequent step is necessary to actually create a SIF container for use by Singularity - a step involving the <code class="docutils literal notranslate"><span class="pre">oci-archive</span></code> bootstrap agent in the case of an OCI image archive.</p>
</div></blockquote>
<p>Like <a class="reference internal" href="#sec-best-practices"><span class="std std-ref">best practices</span></a>, troubleshooting scenarios and solutions emerge from experience. Contributions that allow additional experiences to be shared  are always encouraged. Please refer to <a class="reference internal" href="contributing.html#contributing"><span class="std std-ref">Contributing</span></a> for additional details.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="bind_paths_and_mounts.html" class="btn btn-neutral float-right" title="Bind Paths and Mounts" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="cloud_library.html" class="btn btn-neutral float-left" title="Cloud Library" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2019, Sylabs Inc.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>