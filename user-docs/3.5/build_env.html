

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Build Environment &mdash; Singularity container 3.5 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/js/ga.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Support for Docker and OCI" href="singularity_and_docker.html" />
    <link rel="prev" title="Definition Files" href="definition_files.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Singularity container
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Singularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security in Singularity</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="build_a_container.html">Build a container</a></li>
<li class="toctree-l1"><a class="reference internal" href="definition_files.html">The Definition File</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Build Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cache-folders">Cache Folders</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cache-commands">Cache commands</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#listing-cache">Listing Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cleaning-the-cache">Cleaning the Cache</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#temporary-folders">Temporary Folders</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pull-folder">Pull Folder</a></li>
<li class="toctree-l2"><a class="reference internal" href="#encrypted-containers">Encrypted Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#environment-variables">Environment Variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#defaults">Defaults</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#docker">Docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#library">Library</a></li>
<li class="toctree-l4"><a class="reference internal" href="#encryption">Encryption</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="singularity_and_docker.html">Singularity and Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="fakeroot.html">Fakeroot feature</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="signNverify.html">Sign and Verify</a></li>
<li class="toctree-l1"><a class="reference internal" href="key_commands.html">Key management commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="encryption.html">Encrypted Containers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="endpoint.html">Remote Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud_library.html">Cloud Library</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bind_paths_and_mounts.html">Bind Paths and Mounts</a></li>
<li class="toctree-l1"><a class="reference internal" href="persistent_overlays.html">Persistent Overlays</a></li>
<li class="toctree-l1"><a class="reference internal" href="running_services.html">Running Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="environment_and_metadata.html">Environment and Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="oci_runtime.html">OCI Runtime Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="security_options.html">Security Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Network Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgroups.html">Cgroups Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="mpi.html">Singularity and MPI applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.html">GPU Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Singularity container</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Build Environment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/sylabs/singularity-userdocs/blob/master/build_env.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="build-environment">
<span id="id1"></span><h1>Build Environment<a class="headerlink" href="#build-environment" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<span id="sec-buildenv"></span><h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>You may wish to customize your build
environment by doing things such as specifying a custom cache directory for images or
sending your Docker Credentials to the registry endpoint. Here we will discuss these and other topics
related to the build environment.</p>
</div>
<div class="section" id="cache-folders">
<h2>Cache Folders<a class="headerlink" href="#cache-folders" title="Permalink to this headline">¶</a></h2>
<p>To make downloading images for build and <span class="xref std std-ref">pull</span> faster and less redundant, Singularity
uses a caching strategy. By default, Singularity will create
a set of folders in your <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> directory for docker layers, Cloud library images, and metadata, respectively:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$HOME/.singularity/cache/library
$HOME/.singularity/cache/oci
$HOME/.singularity/cache/oci-tmp
</pre></div>
</div>
<p>If you want to cache in a different directory, set <code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code> to the desired path.
By using the <code class="docutils literal notranslate"><span class="pre">-E</span></code> option with the <code class="docutils literal notranslate"><span class="pre">sudo</span></code> command, <code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code> will be passed along
to root’s environment and respected during the build.
Remember that when you run commands as root images will be cached in root’s home at <code class="docutils literal notranslate"><span class="pre">/root</span></code> and not your user’s home.</p>
</div>
<div class="section" id="cache-commands">
<h2>Cache commands<a class="headerlink" href="#cache-commands" title="Permalink to this headline">¶</a></h2>
<p>Singularity 3.1 comes with new commands for cleaning and listing the cache image files generated.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Running the cache commands with sudo privilege will consider cache location as <code class="docutils literal notranslate"><span class="pre">/root/.singularity/cache</span></code>. The default location for cache without sudo privilege is <code class="docutils literal notranslate"><span class="pre">~/.singularity/cache</span></code>.
Make sure that if you build a container with sudo privilege, you will need to consider the sudo location from the cache, and not the default.</p>
<p>For example, running the following command with sudo privilege (considering the sudo privilege location for cache <code class="docutils literal notranslate"><span class="pre">/root/.singularity/cache</span></code>):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity cache list
NAME                   DATE CREATED           SIZE             TYPE
ubuntu_latest.sif      2019-01-31 14:59:32    28.11 Mb         library
ubuntu_18.04.sif       2019-01-31 14:58:44    27.98 Mb         library
</pre></div>
</div>
<p>and then cleaning the cache without sudo privilege (<code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">cache</span> <span class="pre">clean</span> <span class="pre">-a</span></code>) will not work, since the default cache location is <code class="docutils literal notranslate"><span class="pre">~/.singularity/cache</span></code>.
In this case you would need to run the clean command with sudo privilege:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ sudo singularity cache clean -a
NAME                     DATE CREATED           SIZE             TYPE

There 0 containers using: 0.00 kB, 0 oci blob file(s) using 0.00 kB of space.
Total space used: 0.00 kB
</pre></div>
</div>
</div>
<div class="section" id="listing-cache">
<h3>Listing Cache<a class="headerlink" href="#listing-cache" title="Permalink to this headline">¶</a></h3>
<p>For example, you can list cache image files and check which type they belong to: Library or oci.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity cache list
NAME                   DATE CREATED           SIZE             TYPE
ubuntu_latest.sif      2019-01-31 14:59:32    28.11 Mb         library
ubuntu_18.04.sif       2019-01-31 14:58:44    27.98 Mb         library
alpine_latest.sif      2019-01-31 14:58:24    2.18 Mb          library
centos_latest.sif      2019-01-31 14:59:07    72.96 Mb         library
centos_latest.sif      2019-01-31 14:59:26    73.45 Mb         oci
ubuntu_18.04.sif       2019-01-31 14:58:58    27.99 Mb         oci
ubuntu_latest.sif      2019-01-31 14:59:41    27.99 Mb         oci
alpine_latest.sif      2019-01-31 14:58:30    2.72 Mb          oci

There are 15 oci blob file(s) using 112.51 Mb of space. Use: &#39;-T=blob&#39; to list
</pre></div>
</div>
<p>You can also clean a specific cache type, choosing between: <code class="docutils literal notranslate"><span class="pre">library</span></code>, <code class="docutils literal notranslate"><span class="pre">oci</span></code>, <code class="docutils literal notranslate"><span class="pre">blob</span></code> (separated by commas)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># clean only library cache
$ singularity cache clean --type=library

# clean only oci cache
$ singularity cache clean --type=oci

# clean only blob cache
$ singularity cache clean --type=blob

# clean only library, and oci cache
$ singularity cache clean --type=library,oci
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This feature of passing additional flags with comma-separated arguments can also be used with the <code class="docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">cache</span> <span class="pre">clean</span></code> command we will see below.</p>
</div>
</div>
<div class="section" id="cleaning-the-cache">
<h3>Cleaning the Cache<a class="headerlink" href="#cleaning-the-cache" title="Permalink to this headline">¶</a></h3>
<p>Most of the <code class="docutils literal notranslate"><span class="pre">cache</span> <span class="pre">clean</span></code> and <code class="docutils literal notranslate"><span class="pre">cache</span> <span class="pre">list</span></code> flags can be interchanged, (<code class="docutils literal notranslate"><span class="pre">--name</span></code> is only reserved for <code class="docutils literal notranslate"><span class="pre">cache</span> <span class="pre">clean</span></code>).</p>
<p>It’s worth noting that by running the following command: (with no flags)</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity cache clean
</pre></div>
</div>
<p>By default will just clean the blob cache, but if you do:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity cache clean --all
</pre></div>
</div>
<p>It will clean all the cache.</p>
</div>
</div>
<div class="section" id="temporary-folders">
<h2>Temporary Folders<a class="headerlink" href="#temporary-folders" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p id="sec-temporaryfolders">Singularity uses a temporary directory to build the squashfs filesystem,
and this temp space needs to be large enough to hold the entire resulting Singularity image.
By default this happens in <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> but the location can be configured by setting <code class="docutils literal notranslate"><span class="pre">SINGULARITY_TMPDIR</span></code> to the full
path where you want the sandbox and squashfs temp files to be stored. Remember to use <code class="docutils literal notranslate"><span class="pre">-E</span></code> option to pass the value of <code class="docutils literal notranslate"><span class="pre">SINGULARITY_TMPDIR</span></code>
to root’s environment when executing the <code class="docutils literal notranslate"><span class="pre">build</span></code> command with <code class="docutils literal notranslate"><span class="pre">sudo</span></code>.</p>
<p>When you run one of the action commands (i.e. <code class="docutils literal notranslate"><span class="pre">run</span></code>, <code class="docutils literal notranslate"><span class="pre">exec</span></code>, or <code class="docutils literal notranslate"><span class="pre">shell</span></code>) with a container from the
container library or an OCI registry, Singularity builds the container in the temporary directory caches it
and runs it from the cached location.</p>
<p>Consider the following command:</p>
</div></blockquote>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity exec docker://busybox /bin/sh
</pre></div>
</div>
<p>This container is first built in <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>. Since all the oci blobs are converted into SIF format,
by default a temporary runtime directory is created in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$HOME/.singularity/cache/oci-tmp/&lt;sha256-code&gt;/busybox_latest.sif
</pre></div>
</div>
<p>In this case, the <code class="docutils literal notranslate"><span class="pre">SINGULARITY_TMPDIR</span></code> and <code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code> variables will also be respected.</p>
</div>
<div class="section" id="pull-folder">
<h2>Pull Folder<a class="headerlink" href="#pull-folder" title="Permalink to this headline">¶</a></h2>
<p>To customize your pull default location you can do so by specifying Singularity in which folder to pull the image, assuming you own a folder called <code class="docutils literal notranslate"><span class="pre">mycontainers</span></code> inside your <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> folder
, you would need to do something like the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ singularity pull $HOME/mycontainers library://library/default/alpine
</pre></div>
</div>
<p>Singularity also allows you to modify the default cache location for pulling images. By default, the location of the pull folder is given by the environment variable <code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code>.
<code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code> by default points to <code class="docutils literal notranslate"><span class="pre">$HOME/.singularity/cache</span></code> but this path can be modified. You would need to set and export the <code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code> environment variable before pulling the image, like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ export SINGULARITY_CACHEDIR=$HOME/mycontainers
$ singularity pull library://library/default/alpine
</pre></div>
</div>
<p>And that will successfully pull that container image inside your new <code class="docutils literal notranslate"><span class="pre">SINGULARITY_CACHEDIR</span></code> location.</p>
</div>
<div class="section" id="encrypted-containers">
<h2>Encrypted Containers<a class="headerlink" href="#encrypted-containers" title="Permalink to this headline">¶</a></h2>
<p>Beginning in Singularity 3.4.0 it is possible to build and run encrypted
containers.  The containers are decrypted at runtime entirely in kernel space,
meaning that no intermediate decrypted data is ever present on disk or in
memory.  See <a class="reference internal" href="encryption.html#encryption"><span class="std std-ref">encrypted containers</span></a> for more details.</p>
</div>
<div class="section" id="environment-variables">
<h2>Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>If a flag is represented by both a CLI option and an environment variable, and both are set, the CLI option will always take precedence. This is true for all environment variables except for <code class="docutils literal notranslate"><span class="pre">SINGULARITY_BIND</span></code> and <code class="docutils literal notranslate"><span class="pre">SINGULARITY_BINDPATH</span></code> which is combined with the <code class="docutils literal notranslate"><span class="pre">--bind</span></code> option, argument pair if both are present.</p></li>
<li><p>Environment variables overwrite default values in the CLI code</p></li>
<li><p>Any defaults in the CLI code are applied.</p></li>
</ol>
<div class="section" id="defaults">
<h3>Defaults<a class="headerlink" href="#defaults" title="Permalink to this headline">¶</a></h3>
<p>The following variables have defaults that can be customized by you via
environment variables at runtime.</p>
<div class="section" id="docker">
<h4>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h4>
<p><strong>SINGULARITY_DOCKER_LOGIN</strong> Used for the interactive login for Docker Hub.</p>
<p><strong>SINGULARITY_DOCKER_USERNAME</strong> Your Docker username.</p>
<p><strong>SINGULARITY_DOCKER_PASSWORD</strong> Your Docker password.</p>
<p><strong>RUNSCRIPT_COMMAND</strong> Is not obtained from the environment, but is a
hard coded default (“/bin/bash”). This is the fallback command used in
the case that the docker image does not have a CMD or ENTRYPOINT.
<strong>TAG</strong> Is the default tag, <code class="docutils literal notranslate"><span class="pre">latest</span></code>.</p>
<p><strong>SINGULARITY_NOHTTPS</strong> This is relevant if you want to use a
registry that doesn’t have https, and it speaks for itself. If you
export the variable <code class="docutils literal notranslate"><span class="pre">SINGULARITY_NOHTTPS</span></code> you can force the software to not use https when
interacting with a Docker registry. This use case is typically for use
of a local registry.</p>
</div>
<div class="section" id="library">
<h4>Library<a class="headerlink" href="#library" title="Permalink to this headline">¶</a></h4>
<p><strong>SINGULARITY_BUILDER</strong> Used to specify the remote builder service URL. The default value is our remote builder.</p>
<p><strong>SINGULARITY_LIBRARY</strong> Used to specify the library to pull from. Default is set to our Cloud Library.</p>
<p><strong>SINGULARITY_REMOTE</strong> Used to build an image remotely (This does not require root). The default is set to false.</p>
</div>
<div class="section" id="encryption">
<h4>Encryption<a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h4>
<p><strong>SINGULARITY_ENCRYPTION_PASSPHRASE</strong> Used to pass a plaintext passphrase to encrypt a container file system (with the <code class="docutils literal notranslate"><span class="pre">--encrypt</span></code> flag). The default is empty.</p>
<p><strong>SINGULARITY_ENCRYPTION_PEM_PATH</strong> Used to specify the location of a public key to use for container encryption (with the <code class="docutils literal notranslate"><span class="pre">--encrypt</span></code> flag). The default is empty.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="singularity_and_docker.html" class="btn btn-neutral float-right" title="Support for Docker and OCI" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="definition_files.html" class="btn btn-neutral float-left" title="Definition Files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2019, Sylabs Inc.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>